"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _db = _interopRequireDefault(require("../db"));

var _types = require("../types");

var _utils = require("../utils");

var _debug = _interopRequireDefault(require("debug"));

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

function _toArray(arr) { return _arrayWithHoles(arr) || _iterableToArray(arr) || _nonIterableRest(); }

function _toConsumableArray(arr) { return _arrayWithoutHoles(arr) || _iterableToArray(arr) || _nonIterableSpread(); }

function _nonIterableSpread() { throw new TypeError("Invalid attempt to spread non-iterable instance"); }

function _iterableToArray(iter) { if (Symbol.iterator in Object(iter) || Object.prototype.toString.call(iter) === "[object Arguments]") return Array.from(iter); }

function _arrayWithoutHoles(arr) { if (Array.isArray(arr)) { for (var i = 0, arr2 = new Array(arr.length); i < arr.length; i++) { arr2[i] = arr[i]; } return arr2; } }

function _slicedToArray(arr, i) { return _arrayWithHoles(arr) || _iterableToArrayLimit(arr, i) || _nonIterableRest(); }

function _nonIterableRest() { throw new TypeError("Invalid attempt to destructure non-iterable instance"); }

function _iterableToArrayLimit(arr, i) { var _arr = []; var _n = true; var _d = false; var _e = undefined; try { for (var _i = arr[Symbol.iterator](), _s; !(_n = (_s = _i.next()).done); _n = true) { _arr.push(_s.value); if (i && _arr.length === i) break; } } catch (err) { _d = true; _e = err; } finally { try { if (!_n && _i["return"] != null) _i["return"](); } finally { if (_d) throw _e; } } return _arr; }

function _arrayWithHoles(arr) { if (Array.isArray(arr)) return arr; }

function _classCallCheck(instance, Constructor) { if (!(instance instanceof Constructor)) { throw new TypeError("Cannot call a class as a function"); } }

function _defineProperties(target, props) { for (var i = 0; i < props.length; i++) { var descriptor = props[i]; descriptor.enumerable = descriptor.enumerable || false; descriptor.configurable = true; if ("value" in descriptor) descriptor.writable = true; Object.defineProperty(target, descriptor.key, descriptor); } }

function _createClass(Constructor, protoProps, staticProps) { if (protoProps) _defineProperties(Constructor.prototype, protoProps); if (staticProps) _defineProperties(Constructor, staticProps); return Constructor; }

var debug = (0, _debug.default)('funfunzmc:controller-table');

function toRequestBuilder(relation, columnName) {
  return {
    values: new Set(),
    key: relation.key,
    display: relation.display,
    foreignKeyColumn: columnName
  };
}

var TableController =
/*#__PURE__*/
function () {
  function TableController() {
    _classCallCheck(this, TableController);

    debug('Created');
  }

  _createClass(TableController, [{
    key: "getTableConfig",
    value: function getTableConfig(req, res, next) {
      var TABLE_CONFIG = (0, _utils.getTableConfig)(req.params.table);
      var RESULT = {
        columns: TABLE_CONFIG.columns,
        name: TABLE_CONFIG.name,
        pk: TABLE_CONFIG.pk,
        verbose: TABLE_CONFIG.verbose,
        chips: TABLE_CONFIG.chips || [],
        itemTitle: TABLE_CONFIG.itemTitle
      };

      if (!(0, _utils.hasAuthorization)(TABLE_CONFIG.roles, req.user)) {
        return (0, _utils.catchMiddleware)(next)(new _types.HttpException(401, 'Not authorized'));
      }

      (0, _utils.addToResponse)(res, 'results')(RESULT);
      return (0, _utils.nextAndReturn)(next)(RESULT);
    }
  }, {
    key: "getTableData",
    value: function getTableData(req, res, next) {
      var _this = this;

      var PAGE_NUMBER = req.query.page || 0;
      var TABLE_NAME = req.params.table;
      var ORDER = req.query.order || null;
      var TABLE_CONFIG = (0, _utils.getTableConfig)(TABLE_NAME);
      var COLUMNS = (0, _utils.filterVisibleTableColumns)(TABLE_CONFIG, 'main');
      var LIMIT = 10;

      if (!(0, _utils.hasAuthorization)(TABLE_CONFIG.roles, req.user)) {
        return (0, _utils.catchMiddleware)(next)(new _types.HttpException(401, 'Not authorized'));
      }

      if (!_db.default.db) {
        return (0, _utils.catchMiddleware)(next)(new _types.HttpException(500, 'No database'));
      }

      var DB = _db.default.db;
      var QUERY = DB.select(COLUMNS).from(TABLE_NAME);

      if (req.query.filter) {
        QUERY = (0, _utils.applyQueryFilters)(QUERY, req.query.filter, TABLE_CONFIG);
      }

      if (req.query.search) {
        QUERY = (0, _utils.applyQuerySearch)(QUERY, req.query.search, TABLE_CONFIG);
      }

      if (ORDER) {
        var ORDER_OBJ = JSON.parse(ORDER);

        if (Array.isArray(ORDER_OBJ)) {
          QUERY.orderBy(ORDER_OBJ);
        } else {
          QUERY.orderBy(ORDER_OBJ.column, ORDER_OBJ.order);
        }
      }

      if (req.query.limit) {
        LIMIT = parseInt(req.query.limit, 10);
      }

      if (LIMIT > 0) {
        QUERY.offset(PAGE_NUMBER * LIMIT).limit(LIMIT);
      }

      return (0, _utils.runHook)(TABLE_CONFIG, 'getTableData', 'before', req, res, _db.default.db).then(function (hookResult) {
        if (hookResult) {
          if (hookResult.filter) {
            Object.keys(hookResult.filter).forEach(function (column) {
              if (Array.isArray(hookResult.filter[column])) {
                QUERY.whereIn(column, hookResult.filter[column]);
              }
            });
          }
        }

        return QUERY;
      }).then(function (results) {
        if (req.query.friendlyData) {
          return _this.addVerboseRelatedData(results, TABLE_CONFIG, DB);
        }

        return results;
      }).then(function (results) {
        return (0, _utils.runHook)(TABLE_CONFIG, 'getTableData', 'after', req, res, _db.default.db, results);
      }).then((0, _utils.addToResponse)(res, 'results')).then((0, _utils.nextAndReturn)(next));
    }
  }, {
    key: "getTableCount",
    value: function getTableCount(req, res, next) {
      var TABLE_NAME = req.params.table;
      var TABLE_CONFIG = (0, _utils.getTableConfig)(TABLE_NAME);
      return this.requirementsCheck(TABLE_CONFIG, req.user, _db.default, next).then(function (DB) {
        var QUERY = DB(TABLE_NAME).select('*');

        if (req.query.search) {
          QUERY = (0, _utils.applyQuerySearch)(QUERY, req.query.search, TABLE_CONFIG);
        }

        return Promise.all([DB, QUERY]);
      }).then(function (_ref) {
        var _ref2 = _slicedToArray(_ref, 2),
            DB = _ref2[0],
            results = _ref2[1];

        return (0, _utils.runHook)(TABLE_CONFIG, 'getTableCount', 'after', req, res, DB, results);
      }).then((0, _utils.addToResponse)(res, 'count')).then((0, _utils.nextAndReturn)(next)).catch((0, _utils.catchMiddleware)(next));
    }
  }, {
    key: "getRow",
    value: function getRow(req, res, next) {
      var _this2 = this;

      var TABLE_NAME = req.params.table;
      var TABLE_CONFIG = (0, _utils.getTableConfig)(TABLE_NAME);
      return this.requirementsCheck(TABLE_CONFIG, req.user, _db.default, next).then(function (DB) {
        var requestedColumns = (0, _utils.filterVisibleTableColumns)(TABLE_CONFIG, 'detail');
        return DB.select(requestedColumns).from("".concat(req.params.table)).where('id', req.params.id);
      }).then(function (results) {
        var relationQueries = [];

        if (req.query.includeRelations) {
          relationQueries = _this2.getRelationQueries(TABLE_CONFIG, results[0].id);
        }

        if (relationQueries.length) {
          return Promise.all([results[0]].concat(_toConsumableArray(relationQueries)));
        }

        return Promise.all([results[0]]);
      }).then(this.mergeRelatedData).then((0, _utils.addToResponse)(res, 'results')).then((0, _utils.nextAndReturn)(next)).catch((0, _utils.catchMiddleware)(next));
    }
  }, {
    key: "insertRow",
    value: function insertRow(req, res, next) {
      var TABLE_NAME = req.params.table;
      var TABLE_CONFIG = (0, _utils.getTableConfig)(TABLE_NAME);
      return this.requirementsCheck(TABLE_CONFIG, req.user, _db.default, next).then(function (DB) {
        TABLE_CONFIG.columns.forEach(function (column) {
          if (column.type === 'datetime') {
            req.body.data[column.name] = new Date(req.body.data[column.name] || null);
          } else if (column.type === 'tinyint(1)') {
            req.body.data[column.name] = column.type ? 1 : 0;
          }
        });
        return DB(req.params.table).insert(req.body.data);
      }).then(function (results) {
        (0, _utils.addToResponse)(res, 'results')(results);
      }).then((0, _utils.nextAndReturn)(next)).catch((0, _utils.catchMiddleware)(next));
    }
  }, {
    key: "updateRow",
    value: function updateRow(req, res, next) {
      var TABLE_NAME = req.params.table;
      var TABLE_CONFIG = (0, _utils.getTableConfig)(TABLE_NAME);
      return this.requirementsCheck(TABLE_CONFIG, req.user, _db.default, next).then(function (DB) {
        TABLE_CONFIG.columns.forEach(function (column) {
          if (column.type === 'datetime') {
            req.body.data[column.name] = new Date(req.body.data[column.name] || null);
          }
        });
        return DB(TABLE_NAME).where('id', req.params.id).update(req.body.data);
      }).then((0, _utils.addToResponse)(res, 'results')).then((0, _utils.nextAndReturn)(next)).catch((0, _utils.catchMiddleware)(next));
    }
  }, {
    key: "deleteRow",
    value: function deleteRow(req, res, next) {
      var TABLE_NAME = req.params.table;
      var TABLE_CONFIG = (0, _utils.getTableConfig)(TABLE_NAME);
      return this.requirementsCheck(TABLE_CONFIG, req.user, _db.default, next).then(function (DB) {
        return DB(TABLE_NAME).where('id', req.params.id).del();
      }).then((0, _utils.addToResponse)(res, 'results')).then((0, _utils.nextAndReturn)(next)).catch((0, _utils.catchMiddleware)(next));
    }
  }, {
    key: "addVerboseRelatedData",
    value: function addVerboseRelatedData(results, TABLE_CONFIG, DB) {
      var toRequest = {};
      var COLUMNS_WITH_RELATIONS = (0, _utils.getColumnsWithRelations)(TABLE_CONFIG);
      results.forEach(function (row, index) {
        COLUMNS_WITH_RELATIONS.forEach(function (column) {
          if (!column.relation) {
            throw new _types.HttpException(500, 'Column should have a relation');
          }

          var RELATION_TABLE_NAME = column.relation.table;

          if (!toRequest[RELATION_TABLE_NAME]) {
            toRequest[RELATION_TABLE_NAME] = toRequestBuilder(column.relation, column.name);
          }

          toRequest[RELATION_TABLE_NAME].values.add(row[column.name]);
        });
      });
      var relationQueries = [];
      Object.keys(toRequest).forEach(function (tableName) {
        relationQueries.push(DB.select(toRequest[tableName].display, toRequest[tableName].key).from(tableName).whereIn(toRequest[tableName].key, Array.from(toRequest[tableName].values.values())));
      });
      return Promise.all(relationQueries).then(function (relationResults) {
        var MATCHER = {};
        Object.values(toRequest).forEach(function (requestedTable, index) {
          var FOREIGN_KEY_COLUMN = requestedTable.foreignKeyColumn;
          MATCHER[FOREIGN_KEY_COLUMN] = {};
          relationResults[index].forEach(function (relationRow) {
            var CURRENT_VALUE = relationRow[requestedTable.key];
            var VALUE_TO_DISPLAY = relationRow[requestedTable.display];
            MATCHER[FOREIGN_KEY_COLUMN][CURRENT_VALUE] = VALUE_TO_DISPLAY;
          });
        });
        return results.map(function (row) {
          Object.values(toRequest).forEach(function (requestedTable) {
            var ROW_KEY = requestedTable.foreignKeyColumn;
            row[ROW_KEY] = MATCHER[ROW_KEY][row[ROW_KEY]];
          });
          return row;
        });
      });
    }
  }, {
    key: "requirementsCheck",
    value: function requirementsCheck(tableConfig, user, dbInstance, next) {
      if (!(0, _utils.hasAuthorization)(tableConfig.roles, user)) {
        return Promise.reject(new _types.HttpException(401, 'Not authorized'));
      }

      if (!dbInstance.db) {
        return (0, _utils.catchMiddleware)(next)(new _types.HttpException(500, 'No database'));
      }

      return Promise.resolve(dbInstance.db);
    }
  }, {
    key: "getRelationQueries",
    value: function getRelationQueries(TABLE_CONFIG, parentId) {
      var _this3 = this;

      var relationQueries = [];

      if (TABLE_CONFIG.relations && TABLE_CONFIG.relations.manyToOne) {
        var MANY_TO_ONE = TABLE_CONFIG.relations.manyToOne;
        var KEYS = Object.keys(MANY_TO_ONE);
        KEYS.forEach(function (tableName) {
          relationQueries.push(_this3.getRelatedRow(tableName, MANY_TO_ONE[tableName], parentId));
        });
      }

      return relationQueries;
    }
  }, {
    key: "getRelatedRow",
    value: function getRelatedRow(tableName, columnName, parentId) {
      if (!_db.default.db) {
        throw new _types.HttpException(500, 'No database');
      }

      var TABLE_NAME = tableName;
      var TABLE_CONFIG = (0, _utils.getTableConfig)(TABLE_NAME);
      var requestedColumns = (0, _utils.filterVisibleTableColumns)(TABLE_CONFIG, 'detail').filter(function (column) {
        return column !== columnName;
      });
      return _db.default.db.select(requestedColumns).from(tableName).where(columnName, parentId).then(function (results) {
        return {
          results: results,
          tableName: tableName
        };
      });
    }
  }, {
    key: "mergeRelatedData",
    value: function mergeRelatedData(_ref3) {
      var _ref4 = _toArray(_ref3),
          results = _ref4[0],
          relations = _ref4.slice(1);

      if (relations && relations.length) {
        relations.forEach(function (relation) {
          results[relation.tableName] = relation.results;
        });
      }

      return results;
    }
  }]);

  return TableController;
}();

var _default = TableController;
exports.default = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9hcGkvY29udHJvbGxlcnMvVGFibGVDb250cm9sbGVyLnRzIl0sIm5hbWVzIjpbImRlYnVnIiwidG9SZXF1ZXN0QnVpbGRlciIsInJlbGF0aW9uIiwiY29sdW1uTmFtZSIsInZhbHVlcyIsIlNldCIsImtleSIsImRpc3BsYXkiLCJmb3JlaWduS2V5Q29sdW1uIiwiVGFibGVDb250cm9sbGVyIiwicmVxIiwicmVzIiwibmV4dCIsIlRBQkxFX0NPTkZJRyIsInBhcmFtcyIsInRhYmxlIiwiUkVTVUxUIiwiY29sdW1ucyIsIm5hbWUiLCJwayIsInZlcmJvc2UiLCJjaGlwcyIsIml0ZW1UaXRsZSIsInJvbGVzIiwidXNlciIsIkh0dHBFeGNlcHRpb24iLCJQQUdFX05VTUJFUiIsInF1ZXJ5IiwicGFnZSIsIlRBQkxFX05BTUUiLCJPUkRFUiIsIm9yZGVyIiwiQ09MVU1OUyIsIkxJTUlUIiwiZGF0YWJhc2UiLCJkYiIsIkRCIiwiUVVFUlkiLCJzZWxlY3QiLCJmcm9tIiwiZmlsdGVyIiwic2VhcmNoIiwiT1JERVJfT0JKIiwiSlNPTiIsInBhcnNlIiwiQXJyYXkiLCJpc0FycmF5Iiwib3JkZXJCeSIsImNvbHVtbiIsImxpbWl0IiwicGFyc2VJbnQiLCJvZmZzZXQiLCJ0aGVuIiwiaG9va1Jlc3VsdCIsIk9iamVjdCIsImtleXMiLCJmb3JFYWNoIiwid2hlcmVJbiIsInJlc3VsdHMiLCJmcmllbmRseURhdGEiLCJhZGRWZXJib3NlUmVsYXRlZERhdGEiLCJyZXF1aXJlbWVudHNDaGVjayIsIlByb21pc2UiLCJhbGwiLCJjYXRjaCIsInJlcXVlc3RlZENvbHVtbnMiLCJ3aGVyZSIsImlkIiwicmVsYXRpb25RdWVyaWVzIiwiaW5jbHVkZVJlbGF0aW9ucyIsImdldFJlbGF0aW9uUXVlcmllcyIsImxlbmd0aCIsIm1lcmdlUmVsYXRlZERhdGEiLCJ0eXBlIiwiYm9keSIsImRhdGEiLCJEYXRlIiwiaW5zZXJ0IiwidXBkYXRlIiwiZGVsIiwidG9SZXF1ZXN0IiwiQ09MVU1OU19XSVRIX1JFTEFUSU9OUyIsInJvdyIsImluZGV4IiwiUkVMQVRJT05fVEFCTEVfTkFNRSIsImFkZCIsInRhYmxlTmFtZSIsInB1c2giLCJyZWxhdGlvblJlc3VsdHMiLCJNQVRDSEVSIiwicmVxdWVzdGVkVGFibGUiLCJGT1JFSUdOX0tFWV9DT0xVTU4iLCJyZWxhdGlvblJvdyIsIkNVUlJFTlRfVkFMVUUiLCJWQUxVRV9UT19ESVNQTEFZIiwibWFwIiwiUk9XX0tFWSIsInRhYmxlQ29uZmlnIiwiZGJJbnN0YW5jZSIsInJlamVjdCIsInJlc29sdmUiLCJwYXJlbnRJZCIsInJlbGF0aW9ucyIsIm1hbnlUb09uZSIsIk1BTllfVE9fT05FIiwiS0VZUyIsImdldFJlbGF0ZWRSb3ciXSwibWFwcGluZ3MiOiI7Ozs7Ozs7QUFBQTs7QUFDQTs7QUFDQTs7QUFjQTs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OztBQUlBLElBQU1BLEtBQUssR0FBRyxvQkFBTSw0QkFBTixDQUFkOztBQWFBLFNBQVNDLGdCQUFULENBQTBCQyxRQUExQixFQUFxREMsVUFBckQsRUFBeUY7QUFDdkYsU0FBTztBQUNMQyxJQUFBQSxNQUFNLEVBQUUsSUFBSUMsR0FBSixFQURIO0FBRUxDLElBQUFBLEdBQUcsRUFBRUosUUFBUSxDQUFDSSxHQUZUO0FBR0xDLElBQUFBLE9BQU8sRUFBRUwsUUFBUSxDQUFDSyxPQUhiO0FBSUxDLElBQUFBLGdCQUFnQixFQUFFTDtBQUpiLEdBQVA7QUFNRDs7SUFFS00sZTs7O0FBQ0osNkJBQWM7QUFBQTs7QUFDWlQsSUFBQUEsS0FBSyxDQUFDLFNBQUQsQ0FBTDtBQUNEOzs7O21DQUVxQlUsRyxFQUFpQkMsRyxFQUFrQkMsSSxFQUFvQjtBQUMzRSxVQUFNQyxZQUFZLEdBQUcsMkJBQWVILEdBQUcsQ0FBQ0ksTUFBSixDQUFXQyxLQUExQixDQUFyQjtBQUNBLFVBQU1DLE1BQU0sR0FBRztBQUNiQyxRQUFBQSxPQUFPLEVBQUVKLFlBQVksQ0FBQ0ksT0FEVDtBQUViQyxRQUFBQSxJQUFJLEVBQUVMLFlBQVksQ0FBQ0ssSUFGTjtBQUdiQyxRQUFBQSxFQUFFLEVBQUVOLFlBQVksQ0FBQ00sRUFISjtBQUliQyxRQUFBQSxPQUFPLEVBQUVQLFlBQVksQ0FBQ08sT0FKVDtBQUtiQyxRQUFBQSxLQUFLLEVBQUVSLFlBQVksQ0FBQ1EsS0FBYixJQUFzQixFQUxoQjtBQU1iQyxRQUFBQSxTQUFTLEVBQUVULFlBQVksQ0FBQ1M7QUFOWCxPQUFmOztBQVNBLFVBQUksQ0FBQyw2QkFBaUJULFlBQVksQ0FBQ1UsS0FBOUIsRUFBcUNiLEdBQUcsQ0FBQ2MsSUFBekMsQ0FBTCxFQUFxRDtBQUNuRCxlQUFPLDRCQUFnQlosSUFBaEIsRUFBc0IsSUFBSWEsb0JBQUosQ0FBa0IsR0FBbEIsRUFBdUIsZ0JBQXZCLENBQXRCLENBQVA7QUFDRDs7QUFDRCxnQ0FBY2QsR0FBZCxFQUFtQixTQUFuQixFQUE4QkssTUFBOUI7QUFDQSxhQUFPLDBCQUFjSixJQUFkLEVBQW9CSSxNQUFwQixDQUFQO0FBQ0Q7OztpQ0FFbUJOLEcsRUFBaUJDLEcsRUFBa0JDLEksRUFBb0I7QUFBQTs7QUFDekUsVUFBTWMsV0FBVyxHQUFHaEIsR0FBRyxDQUFDaUIsS0FBSixDQUFVQyxJQUFWLElBQWtCLENBQXRDO0FBQ0EsVUFBTUMsVUFBVSxHQUFHbkIsR0FBRyxDQUFDSSxNQUFKLENBQVdDLEtBQTlCO0FBQ0EsVUFBTWUsS0FBSyxHQUFHcEIsR0FBRyxDQUFDaUIsS0FBSixDQUFVSSxLQUFWLElBQW1CLElBQWpDO0FBQ0EsVUFBTWxCLFlBQVksR0FBRywyQkFBZWdCLFVBQWYsQ0FBckI7QUFDQSxVQUFNRyxPQUFPLEdBQUcsc0NBQTBCbkIsWUFBMUIsRUFBd0MsTUFBeEMsQ0FBaEI7QUFDQSxVQUFJb0IsS0FBSyxHQUFHLEVBQVo7O0FBRUEsVUFBSSxDQUFDLDZCQUFpQnBCLFlBQVksQ0FBQ1UsS0FBOUIsRUFBcUNiLEdBQUcsQ0FBQ2MsSUFBekMsQ0FBTCxFQUFxRDtBQUNuRCxlQUFPLDRCQUFnQlosSUFBaEIsRUFBc0IsSUFBSWEsb0JBQUosQ0FBa0IsR0FBbEIsRUFBdUIsZ0JBQXZCLENBQXRCLENBQVA7QUFDRDs7QUFDRCxVQUFJLENBQUNTLFlBQVNDLEVBQWQsRUFBa0I7QUFDaEIsZUFBTyw0QkFBZ0J2QixJQUFoQixFQUFzQixJQUFJYSxvQkFBSixDQUFrQixHQUFsQixFQUF1QixhQUF2QixDQUF0QixDQUFQO0FBQ0Q7O0FBQ0QsVUFBTVcsRUFBRSxHQUFHRixZQUFTQyxFQUFwQjtBQUNBLFVBQUlFLEtBQUssR0FBR0QsRUFBRSxDQUFDRSxNQUFILENBQVVOLE9BQVYsRUFBbUJPLElBQW5CLENBQXdCVixVQUF4QixDQUFaOztBQUNBLFVBQUluQixHQUFHLENBQUNpQixLQUFKLENBQVVhLE1BQWQsRUFBc0I7QUFDcEJILFFBQUFBLEtBQUssR0FBRyw4QkFBa0JBLEtBQWxCLEVBQXlCM0IsR0FBRyxDQUFDaUIsS0FBSixDQUFVYSxNQUFuQyxFQUEyQzNCLFlBQTNDLENBQVI7QUFDRDs7QUFFRCxVQUFJSCxHQUFHLENBQUNpQixLQUFKLENBQVVjLE1BQWQsRUFBc0I7QUFDcEJKLFFBQUFBLEtBQUssR0FBRyw2QkFBaUJBLEtBQWpCLEVBQXdCM0IsR0FBRyxDQUFDaUIsS0FBSixDQUFVYyxNQUFsQyxFQUEwQzVCLFlBQTFDLENBQVI7QUFDRDs7QUFFRCxVQUFJaUIsS0FBSixFQUFXO0FBQ1QsWUFBTVksU0FBUyxHQUFHQyxJQUFJLENBQUNDLEtBQUwsQ0FBV2QsS0FBWCxDQUFsQjs7QUFDQSxZQUFJZSxLQUFLLENBQUNDLE9BQU4sQ0FBY0osU0FBZCxDQUFKLEVBQThCO0FBQzVCTCxVQUFBQSxLQUFLLENBQUNVLE9BQU4sQ0FBY0wsU0FBZDtBQUNELFNBRkQsTUFFTztBQUNMTCxVQUFBQSxLQUFLLENBQUNVLE9BQU4sQ0FBY0wsU0FBUyxDQUFDTSxNQUF4QixFQUFnQ04sU0FBUyxDQUFDWCxLQUExQztBQUNEO0FBQ0Y7O0FBRUQsVUFBSXJCLEdBQUcsQ0FBQ2lCLEtBQUosQ0FBVXNCLEtBQWQsRUFBcUI7QUFDbkJoQixRQUFBQSxLQUFLLEdBQUdpQixRQUFRLENBQUN4QyxHQUFHLENBQUNpQixLQUFKLENBQVVzQixLQUFYLEVBQWtCLEVBQWxCLENBQWhCO0FBQ0Q7O0FBQ0QsVUFBSWhCLEtBQUssR0FBRyxDQUFaLEVBQWU7QUFDYkksUUFBQUEsS0FBSyxDQUFDYyxNQUFOLENBQWN6QixXQUFELEdBQWdCTyxLQUE3QixFQUFvQ2dCLEtBQXBDLENBQTBDaEIsS0FBMUM7QUFDRDs7QUFFRCxhQUFPLG9CQUFRcEIsWUFBUixFQUFzQixjQUF0QixFQUFzQyxRQUF0QyxFQUFnREgsR0FBaEQsRUFBcURDLEdBQXJELEVBQTBEdUIsWUFBU0MsRUFBbkUsRUFBdUVpQixJQUF2RSxDQUNMLFVBQUNDLFVBQUQsRUFBZ0I7QUFDZCxZQUFJQSxVQUFKLEVBQWdCO0FBQ2QsY0FBSUEsVUFBVSxDQUFDYixNQUFmLEVBQXVCO0FBQ3JCYyxZQUFBQSxNQUFNLENBQUNDLElBQVAsQ0FBWUYsVUFBVSxDQUFDYixNQUF2QixFQUErQmdCLE9BQS9CLENBQ0UsVUFBQ1IsTUFBRCxFQUFZO0FBQ1Ysa0JBQUlILEtBQUssQ0FBQ0MsT0FBTixDQUFjTyxVQUFVLENBQUNiLE1BQVgsQ0FBa0JRLE1BQWxCLENBQWQsQ0FBSixFQUE4QztBQUM1Q1gsZ0JBQUFBLEtBQUssQ0FBQ29CLE9BQU4sQ0FBY1QsTUFBZCxFQUFzQkssVUFBVSxDQUFDYixNQUFYLENBQWtCUSxNQUFsQixDQUF0QjtBQUNEO0FBQ0YsYUFMSDtBQU9EO0FBQ0Y7O0FBQ0QsZUFBT1gsS0FBUDtBQUNELE9BZEksRUFlTGUsSUFmSyxDQWdCTCxVQUFDTSxPQUFELEVBQWE7QUFDWCxZQUFJaEQsR0FBRyxDQUFDaUIsS0FBSixDQUFVZ0MsWUFBZCxFQUE0QjtBQUMxQixpQkFBTyxLQUFJLENBQUNDLHFCQUFMLENBQTJCRixPQUEzQixFQUFvQzdDLFlBQXBDLEVBQWtEdUIsRUFBbEQsQ0FBUDtBQUNEOztBQUNELGVBQU9zQixPQUFQO0FBQ0QsT0FyQkksRUFzQkxOLElBdEJLLENBdUJMLFVBQUNNLE9BQUQsRUFBYTtBQUNYLGVBQU8sb0JBQVE3QyxZQUFSLEVBQXNCLGNBQXRCLEVBQXNDLE9BQXRDLEVBQStDSCxHQUEvQyxFQUFvREMsR0FBcEQsRUFBeUR1QixZQUFTQyxFQUFsRSxFQUFzRXVCLE9BQXRFLENBQVA7QUFDRCxPQXpCSSxFQTBCTE4sSUExQkssQ0EyQkwsMEJBQWN6QyxHQUFkLEVBQW1CLFNBQW5CLENBM0JLLEVBNEJMeUMsSUE1QkssQ0E2QkwsMEJBQWN4QyxJQUFkLENBN0JLLENBQVA7QUErQkQ7OztrQ0FFb0JGLEcsRUFBaUJDLEcsRUFBa0JDLEksRUFBb0I7QUFDMUUsVUFBTWlCLFVBQVUsR0FBR25CLEdBQUcsQ0FBQ0ksTUFBSixDQUFXQyxLQUE5QjtBQUNBLFVBQU1GLFlBQVksR0FBRywyQkFBZWdCLFVBQWYsQ0FBckI7QUFFQSxhQUFPLEtBQUtnQyxpQkFBTCxDQUF1QmhELFlBQXZCLEVBQXFDSCxHQUFHLENBQUNjLElBQXpDLEVBQStDVSxXQUEvQyxFQUF5RHRCLElBQXpELEVBQStEd0MsSUFBL0QsQ0FDTCxVQUFDaEIsRUFBRCxFQUFRO0FBQ04sWUFBSUMsS0FBSyxHQUFHRCxFQUFFLENBQUNQLFVBQUQsQ0FBRixDQUFlUyxNQUFmLENBQXNCLEdBQXRCLENBQVo7O0FBQ0EsWUFBSTVCLEdBQUcsQ0FBQ2lCLEtBQUosQ0FBVWMsTUFBZCxFQUFzQjtBQUNwQkosVUFBQUEsS0FBSyxHQUFHLDZCQUFpQkEsS0FBakIsRUFBd0IzQixHQUFHLENBQUNpQixLQUFKLENBQVVjLE1BQWxDLEVBQTBDNUIsWUFBMUMsQ0FBUjtBQUNEOztBQUNELGVBQU9pRCxPQUFPLENBQUNDLEdBQVIsQ0FBWSxDQUFDM0IsRUFBRCxFQUFLQyxLQUFMLENBQVosQ0FBUDtBQUNELE9BUEksRUFRTGUsSUFSSyxDQVNMLGdCQUFtQjtBQUFBO0FBQUEsWUFBakJoQixFQUFpQjtBQUFBLFlBQWJzQixPQUFhOztBQUNqQixlQUFPLG9CQUFRN0MsWUFBUixFQUFzQixlQUF0QixFQUF1QyxPQUF2QyxFQUFnREgsR0FBaEQsRUFBcURDLEdBQXJELEVBQTBEeUIsRUFBMUQsRUFBOERzQixPQUE5RCxDQUFQO0FBQ0QsT0FYSSxFQVlMTixJQVpLLENBYUwsMEJBQWN6QyxHQUFkLEVBQW1CLE9BQW5CLENBYkssRUFjTHlDLElBZEssQ0FlTCwwQkFBY3hDLElBQWQsQ0FmSyxFQWdCTG9ELEtBaEJLLENBaUJMLDRCQUFnQnBELElBQWhCLENBakJLLENBQVA7QUFtQkQ7OzsyQkFFYUYsRyxFQUFpQkMsRyxFQUFrQkMsSSxFQUFvQjtBQUFBOztBQUNuRSxVQUFNaUIsVUFBVSxHQUFHbkIsR0FBRyxDQUFDSSxNQUFKLENBQVdDLEtBQTlCO0FBQ0EsVUFBTUYsWUFBWSxHQUFHLDJCQUFlZ0IsVUFBZixDQUFyQjtBQUVBLGFBQU8sS0FBS2dDLGlCQUFMLENBQXVCaEQsWUFBdkIsRUFBcUNILEdBQUcsQ0FBQ2MsSUFBekMsRUFBK0NVLFdBQS9DLEVBQXlEdEIsSUFBekQsRUFBK0R3QyxJQUEvRCxDQUNMLFVBQUNoQixFQUFELEVBQVE7QUFDTixZQUFNNkIsZ0JBQWdCLEdBQUcsc0NBQTBCcEQsWUFBMUIsRUFBd0MsUUFBeEMsQ0FBekI7QUFFQSxlQUFPdUIsRUFBRSxDQUFDRSxNQUFILENBQVUyQixnQkFBVixFQUNKMUIsSUFESSxXQUNJN0IsR0FBRyxDQUFDSSxNQUFKLENBQVdDLEtBRGYsR0FFSm1ELEtBRkksQ0FFRSxJQUZGLEVBRVF4RCxHQUFHLENBQUNJLE1BQUosQ0FBV3FELEVBRm5CLENBQVA7QUFHRCxPQVBJLEVBUUxmLElBUkssQ0FTTCxVQUFDTSxPQUFELEVBQWE7QUFDWCxZQUFJVSxlQUFvQyxHQUFHLEVBQTNDOztBQUNBLFlBQUkxRCxHQUFHLENBQUNpQixLQUFKLENBQVUwQyxnQkFBZCxFQUFnQztBQUM5QkQsVUFBQUEsZUFBZSxHQUFHLE1BQUksQ0FBQ0Usa0JBQUwsQ0FBd0J6RCxZQUF4QixFQUFzQzZDLE9BQU8sQ0FBQyxDQUFELENBQVAsQ0FBV1MsRUFBakQsQ0FBbEI7QUFDRDs7QUFFRCxZQUFJQyxlQUFlLENBQUNHLE1BQXBCLEVBQTRCO0FBQzFCLGlCQUFPVCxPQUFPLENBQUNDLEdBQVIsRUFDTEwsT0FBTyxDQUFDLENBQUQsQ0FERiw0QkFFRlUsZUFGRSxHQUFQO0FBSUQ7O0FBRUQsZUFBT04sT0FBTyxDQUFDQyxHQUFSLENBQVksQ0FDakJMLE9BQU8sQ0FBQyxDQUFELENBRFUsQ0FBWixDQUFQO0FBR0QsT0F6QkksRUEwQkxOLElBMUJLLENBMkJMLEtBQUtvQixnQkEzQkEsRUE0QkxwQixJQTVCSyxDQTZCTCwwQkFBY3pDLEdBQWQsRUFBbUIsU0FBbkIsQ0E3QkssRUE4Qkx5QyxJQTlCSyxDQStCTCwwQkFBY3hDLElBQWQsQ0EvQkssRUFnQ0xvRCxLQWhDSyxDQWlDTCw0QkFBZ0JwRCxJQUFoQixDQWpDSyxDQUFQO0FBbUNEOzs7OEJBRWdCRixHLEVBQWlCQyxHLEVBQWtCQyxJLEVBQW9CO0FBQ3RFLFVBQU1pQixVQUFVLEdBQUduQixHQUFHLENBQUNJLE1BQUosQ0FBV0MsS0FBOUI7QUFDQSxVQUFNRixZQUFZLEdBQUcsMkJBQWVnQixVQUFmLENBQXJCO0FBRUEsYUFBTyxLQUFLZ0MsaUJBQUwsQ0FBdUJoRCxZQUF2QixFQUFxQ0gsR0FBRyxDQUFDYyxJQUF6QyxFQUErQ1UsV0FBL0MsRUFBeUR0QixJQUF6RCxFQUErRHdDLElBQS9ELENBQ0wsVUFBQ2hCLEVBQUQsRUFBUTtBQUNOdkIsUUFBQUEsWUFBWSxDQUFDSSxPQUFiLENBQXFCdUMsT0FBckIsQ0FDRSxVQUFDUixNQUFELEVBQVk7QUFDVixjQUFJQSxNQUFNLENBQUN5QixJQUFQLEtBQWdCLFVBQXBCLEVBQWdDO0FBQzlCL0QsWUFBQUEsR0FBRyxDQUFDZ0UsSUFBSixDQUFTQyxJQUFULENBQWMzQixNQUFNLENBQUM5QixJQUFyQixJQUE2QixJQUFJMEQsSUFBSixDQUFTbEUsR0FBRyxDQUFDZ0UsSUFBSixDQUFTQyxJQUFULENBQWMzQixNQUFNLENBQUM5QixJQUFyQixLQUE4QixJQUF2QyxDQUE3QjtBQUNELFdBRkQsTUFFTyxJQUFJOEIsTUFBTSxDQUFDeUIsSUFBUCxLQUFnQixZQUFwQixFQUFrQztBQUN2Qy9ELFlBQUFBLEdBQUcsQ0FBQ2dFLElBQUosQ0FBU0MsSUFBVCxDQUFjM0IsTUFBTSxDQUFDOUIsSUFBckIsSUFBNkI4QixNQUFNLENBQUN5QixJQUFQLEdBQWMsQ0FBZCxHQUFrQixDQUEvQztBQUNEO0FBQ0YsU0FQSDtBQVNBLGVBQU9yQyxFQUFFLENBQUMxQixHQUFHLENBQUNJLE1BQUosQ0FBV0MsS0FBWixDQUFGLENBQXFCOEQsTUFBckIsQ0FBNEJuRSxHQUFHLENBQUNnRSxJQUFKLENBQVNDLElBQXJDLENBQVA7QUFDRCxPQVpJLEVBYUx2QixJQWJLLENBY0wsVUFBQ00sT0FBRCxFQUFhO0FBQ1gsa0NBQWMvQyxHQUFkLEVBQW1CLFNBQW5CLEVBQThCK0MsT0FBOUI7QUFDRCxPQWhCSSxFQWlCTE4sSUFqQkssQ0FrQkwsMEJBQWN4QyxJQUFkLENBbEJLLEVBbUJMb0QsS0FuQkssQ0FvQkwsNEJBQWdCcEQsSUFBaEIsQ0FwQkssQ0FBUDtBQXNCRDs7OzhCQUVnQkYsRyxFQUFpQkMsRyxFQUFrQkMsSSxFQUFvQjtBQUN0RSxVQUFNaUIsVUFBVSxHQUFHbkIsR0FBRyxDQUFDSSxNQUFKLENBQVdDLEtBQTlCO0FBQ0EsVUFBTUYsWUFBWSxHQUFHLDJCQUFlZ0IsVUFBZixDQUFyQjtBQUVBLGFBQU8sS0FBS2dDLGlCQUFMLENBQXVCaEQsWUFBdkIsRUFBcUNILEdBQUcsQ0FBQ2MsSUFBekMsRUFBK0NVLFdBQS9DLEVBQXlEdEIsSUFBekQsRUFBK0R3QyxJQUEvRCxDQUNMLFVBQUNoQixFQUFELEVBQVE7QUFDTnZCLFFBQUFBLFlBQVksQ0FBQ0ksT0FBYixDQUFxQnVDLE9BQXJCLENBQ0UsVUFBQ1IsTUFBRCxFQUFZO0FBQ1YsY0FBSUEsTUFBTSxDQUFDeUIsSUFBUCxLQUFnQixVQUFwQixFQUFnQztBQUM5Qi9ELFlBQUFBLEdBQUcsQ0FBQ2dFLElBQUosQ0FBU0MsSUFBVCxDQUFjM0IsTUFBTSxDQUFDOUIsSUFBckIsSUFBNkIsSUFBSTBELElBQUosQ0FBU2xFLEdBQUcsQ0FBQ2dFLElBQUosQ0FBU0MsSUFBVCxDQUFjM0IsTUFBTSxDQUFDOUIsSUFBckIsS0FBOEIsSUFBdkMsQ0FBN0I7QUFDRDtBQUNGLFNBTEg7QUFRQSxlQUFPa0IsRUFBRSxDQUFDUCxVQUFELENBQUYsQ0FBZXFDLEtBQWYsQ0FBcUIsSUFBckIsRUFBMkJ4RCxHQUFHLENBQUNJLE1BQUosQ0FBV3FELEVBQXRDLEVBQTBDVyxNQUExQyxDQUFpRHBFLEdBQUcsQ0FBQ2dFLElBQUosQ0FBU0MsSUFBMUQsQ0FBUDtBQUNELE9BWEksRUFZTHZCLElBWkssQ0FhTCwwQkFBY3pDLEdBQWQsRUFBbUIsU0FBbkIsQ0FiSyxFQWNMeUMsSUFkSyxDQWVMLDBCQUFjeEMsSUFBZCxDQWZLLEVBZ0JMb0QsS0FoQkssQ0FpQkwsNEJBQWdCcEQsSUFBaEIsQ0FqQkssQ0FBUDtBQW1CRDs7OzhCQUVnQkYsRyxFQUFpQkMsRyxFQUFrQkMsSSxFQUFvQjtBQUN0RSxVQUFNaUIsVUFBVSxHQUFHbkIsR0FBRyxDQUFDSSxNQUFKLENBQVdDLEtBQTlCO0FBQ0EsVUFBTUYsWUFBWSxHQUFHLDJCQUFlZ0IsVUFBZixDQUFyQjtBQUVBLGFBQU8sS0FBS2dDLGlCQUFMLENBQXVCaEQsWUFBdkIsRUFBcUNILEdBQUcsQ0FBQ2MsSUFBekMsRUFBK0NVLFdBQS9DLEVBQXlEdEIsSUFBekQsRUFBK0R3QyxJQUEvRCxDQUNMLFVBQUNoQixFQUFELEVBQVE7QUFDTixlQUFPQSxFQUFFLENBQUNQLFVBQUQsQ0FBRixDQUFlcUMsS0FBZixDQUFxQixJQUFyQixFQUEyQnhELEdBQUcsQ0FBQ0ksTUFBSixDQUFXcUQsRUFBdEMsRUFBMENZLEdBQTFDLEVBQVA7QUFDRCxPQUhJLEVBSUwzQixJQUpLLENBS0wsMEJBQWN6QyxHQUFkLEVBQW1CLFNBQW5CLENBTEssRUFNTHlDLElBTkssQ0FPTCwwQkFBY3hDLElBQWQsQ0FQSyxFQVFMb0QsS0FSSyxDQVNMLDRCQUFnQnBELElBQWhCLENBVEssQ0FBUDtBQVdEOzs7MENBRTZCOEMsTyxFQUFnQjdDLFksRUFBMEJ1QixFLEVBQVU7QUFDaEYsVUFBTTRDLFNBQXFCLEdBQUcsRUFBOUI7QUFDQSxVQUFNQyxzQkFBc0IsR0FBRyxvQ0FBd0JwRSxZQUF4QixDQUEvQjtBQUNBNkMsTUFBQUEsT0FBTyxDQUFDRixPQUFSLENBQ0UsVUFBQzBCLEdBQUQsRUFBV0MsS0FBWCxFQUE2QjtBQUMzQkYsUUFBQUEsc0JBQXNCLENBQUN6QixPQUF2QixDQUNFLFVBQUNSLE1BQUQsRUFBWTtBQUNWLGNBQUksQ0FBQ0EsTUFBTSxDQUFDOUMsUUFBWixFQUFzQjtBQUNwQixrQkFBTSxJQUFJdUIsb0JBQUosQ0FBa0IsR0FBbEIsRUFBdUIsK0JBQXZCLENBQU47QUFDRDs7QUFDRCxjQUFNMkQsbUJBQW1CLEdBQUdwQyxNQUFNLENBQUM5QyxRQUFQLENBQWdCYSxLQUE1Qzs7QUFFQSxjQUFJLENBQUNpRSxTQUFTLENBQUNJLG1CQUFELENBQWQsRUFBcUM7QUFDbkNKLFlBQUFBLFNBQVMsQ0FBQ0ksbUJBQUQsQ0FBVCxHQUFpQ25GLGdCQUFnQixDQUFDK0MsTUFBTSxDQUFDOUMsUUFBUixFQUFrQjhDLE1BQU0sQ0FBQzlCLElBQXpCLENBQWpEO0FBQ0Q7O0FBRUQ4RCxVQUFBQSxTQUFTLENBQUNJLG1CQUFELENBQVQsQ0FBK0JoRixNQUEvQixDQUFzQ2lGLEdBQXRDLENBQTBDSCxHQUFHLENBQUNsQyxNQUFNLENBQUM5QixJQUFSLENBQTdDO0FBQ0QsU0FaSDtBQWNELE9BaEJIO0FBbUJBLFVBQU1rRCxlQUFvQyxHQUFHLEVBQTdDO0FBQ0FkLE1BQUFBLE1BQU0sQ0FBQ0MsSUFBUCxDQUFZeUIsU0FBWixFQUF1QnhCLE9BQXZCLENBQ0UsVUFBQzhCLFNBQUQsRUFBZTtBQUNibEIsUUFBQUEsZUFBZSxDQUFDbUIsSUFBaEIsQ0FDRW5ELEVBQUUsQ0FBQ0UsTUFBSCxDQUFVMEMsU0FBUyxDQUFDTSxTQUFELENBQVQsQ0FBcUIvRSxPQUEvQixFQUF3Q3lFLFNBQVMsQ0FBQ00sU0FBRCxDQUFULENBQXFCaEYsR0FBN0QsRUFDR2lDLElBREgsQ0FDUStDLFNBRFIsRUFFRzdCLE9BRkgsQ0FFV3VCLFNBQVMsQ0FBQ00sU0FBRCxDQUFULENBQXFCaEYsR0FGaEMsRUFFcUN1QyxLQUFLLENBQUNOLElBQU4sQ0FBV3lDLFNBQVMsQ0FBQ00sU0FBRCxDQUFULENBQXFCbEYsTUFBckIsQ0FBNEJBLE1BQTVCLEVBQVgsQ0FGckMsQ0FERjtBQUtELE9BUEg7QUFVQSxhQUFPMEQsT0FBTyxDQUFDQyxHQUFSLENBQW1CSyxlQUFuQixFQUFvQ2hCLElBQXBDLENBQ0wsVUFBQ29DLGVBQUQsRUFBcUI7QUFDbkIsWUFBTUMsT0FJTCxHQUFHLEVBSko7QUFLQW5DLFFBQUFBLE1BQU0sQ0FBQ2xELE1BQVAsQ0FBYzRFLFNBQWQsRUFBeUJ4QixPQUF6QixDQUNFLFVBQUNrQyxjQUFELEVBQWlCUCxLQUFqQixFQUEyQjtBQUN6QixjQUFNUSxrQkFBa0IsR0FBR0QsY0FBYyxDQUFDbEYsZ0JBQTFDO0FBQ0FpRixVQUFBQSxPQUFPLENBQUNFLGtCQUFELENBQVAsR0FBOEIsRUFBOUI7QUFDQUgsVUFBQUEsZUFBZSxDQUFDTCxLQUFELENBQWYsQ0FBdUIzQixPQUF2QixDQUNFLFVBQUNvQyxXQUFELEVBQXNCO0FBQ3BCLGdCQUFNQyxhQUFhLEdBQUdELFdBQVcsQ0FBQ0YsY0FBYyxDQUFDcEYsR0FBaEIsQ0FBakM7QUFDQSxnQkFBTXdGLGdCQUFnQixHQUFHRixXQUFXLENBQUNGLGNBQWMsQ0FBQ25GLE9BQWhCLENBQXBDO0FBQ0FrRixZQUFBQSxPQUFPLENBQUNFLGtCQUFELENBQVAsQ0FBNEJFLGFBQTVCLElBQTZDQyxnQkFBN0M7QUFDRCxXQUxIO0FBT0QsU0FYSDtBQWFBLGVBQU9wQyxPQUFPLENBQUNxQyxHQUFSLENBQ0wsVUFBQ2IsR0FBRCxFQUFjO0FBQ1o1QixVQUFBQSxNQUFNLENBQUNsRCxNQUFQLENBQWM0RSxTQUFkLEVBQXlCeEIsT0FBekIsQ0FDRSxVQUFDa0MsY0FBRCxFQUFvQjtBQUNsQixnQkFBTU0sT0FBTyxHQUFHTixjQUFjLENBQUNsRixnQkFBL0I7QUFDQTBFLFlBQUFBLEdBQUcsQ0FBQ2MsT0FBRCxDQUFILEdBQWVQLE9BQU8sQ0FBQ08sT0FBRCxDQUFQLENBQWlCZCxHQUFHLENBQUNjLE9BQUQsQ0FBcEIsQ0FBZjtBQUNELFdBSkg7QUFNQSxpQkFBT2QsR0FBUDtBQUNELFNBVEksQ0FBUDtBQVdELE9BL0JJLENBQVA7QUFpQ0Q7OztzQ0FHQ2UsVyxFQUNBekUsSSxFQUNBMEUsVSxFQUNBdEYsSSxFQUNBO0FBQ0EsVUFBSSxDQUFDLDZCQUFpQnFGLFdBQVcsQ0FBQzFFLEtBQTdCLEVBQW9DQyxJQUFwQyxDQUFMLEVBQWdEO0FBQzlDLGVBQU9zQyxPQUFPLENBQUNxQyxNQUFSLENBQWUsSUFBSTFFLG9CQUFKLENBQWtCLEdBQWxCLEVBQXVCLGdCQUF2QixDQUFmLENBQVA7QUFDRDs7QUFDRCxVQUFJLENBQUN5RSxVQUFVLENBQUMvRCxFQUFoQixFQUFvQjtBQUNsQixlQUFPLDRCQUFnQnZCLElBQWhCLEVBQXNCLElBQUlhLG9CQUFKLENBQWtCLEdBQWxCLEVBQXVCLGFBQXZCLENBQXRCLENBQVA7QUFDRDs7QUFDRCxhQUFPcUMsT0FBTyxDQUFDc0MsT0FBUixDQUFnQkYsVUFBVSxDQUFDL0QsRUFBM0IsQ0FBUDtBQUNEOzs7dUNBRTBCdEIsWSxFQUEwQndGLFEsRUFBZTtBQUFBOztBQUNsRSxVQUFNakMsZUFBb0MsR0FBRyxFQUE3Qzs7QUFDQSxVQUFJdkQsWUFBWSxDQUFDeUYsU0FBYixJQUEwQnpGLFlBQVksQ0FBQ3lGLFNBQWIsQ0FBdUJDLFNBQXJELEVBQWdFO0FBQzlELFlBQU1DLFdBQVcsR0FBRzNGLFlBQVksQ0FBQ3lGLFNBQWIsQ0FBdUJDLFNBQTNDO0FBQ0EsWUFBTUUsSUFBYyxHQUFHbkQsTUFBTSxDQUFDQyxJQUFQLENBQVlpRCxXQUFaLENBQXZCO0FBQ0FDLFFBQUFBLElBQUksQ0FBQ2pELE9BQUwsQ0FDRSxVQUFDOEIsU0FBRCxFQUFlO0FBQ2JsQixVQUFBQSxlQUFlLENBQUNtQixJQUFoQixDQUNFLE1BQUksQ0FBQ21CLGFBQUwsQ0FDRXBCLFNBREYsRUFFRWtCLFdBQVcsQ0FBQ2xCLFNBQUQsQ0FGYixFQUdFZSxRQUhGLENBREY7QUFPRCxTQVRIO0FBV0Q7O0FBRUQsYUFBT2pDLGVBQVA7QUFDRDs7O2tDQUVxQmtCLFMsRUFBbUJuRixVLEVBQW9Ca0csUSxFQUFlO0FBQzFFLFVBQUksQ0FBQ25FLFlBQVNDLEVBQWQsRUFBa0I7QUFDaEIsY0FBTSxJQUFJVixvQkFBSixDQUFrQixHQUFsQixFQUF1QixhQUF2QixDQUFOO0FBQ0Q7O0FBQ0QsVUFBTUksVUFBVSxHQUFHeUQsU0FBbkI7QUFDQSxVQUFNekUsWUFBWSxHQUFHLDJCQUFlZ0IsVUFBZixDQUFyQjtBQUVBLFVBQU1vQyxnQkFBZ0IsR0FBRyxzQ0FBMEJwRCxZQUExQixFQUF3QyxRQUF4QyxFQUFrRDJCLE1BQWxELENBQ3ZCLFVBQUNRLE1BQUQ7QUFBQSxlQUFZQSxNQUFNLEtBQUs3QyxVQUF2QjtBQUFBLE9BRHVCLENBQXpCO0FBSUEsYUFBTytCLFlBQVNDLEVBQVQsQ0FBWUcsTUFBWixDQUFtQjJCLGdCQUFuQixFQUNKMUIsSUFESSxDQUNDK0MsU0FERCxFQUVKcEIsS0FGSSxDQUVFL0QsVUFGRixFQUVja0csUUFGZCxFQUV3QmpELElBRnhCLENBR0gsVUFBQ00sT0FBRDtBQUFBLGVBQWM7QUFDWkEsVUFBQUEsT0FBTyxFQUFQQSxPQURZO0FBRVo0QixVQUFBQSxTQUFTLEVBQVRBO0FBRlksU0FBZDtBQUFBLE9BSEcsQ0FBUDtBQVFEOzs7NENBRXNEO0FBQUE7QUFBQSxVQUE3QjVCLE9BQTZCO0FBQUEsVUFBakI0QyxTQUFpQjs7QUFDckQsVUFBSUEsU0FBUyxJQUFJQSxTQUFTLENBQUMvQixNQUEzQixFQUFtQztBQUNqQytCLFFBQUFBLFNBQVMsQ0FBQzlDLE9BQVYsQ0FDRSxVQUFDdEQsUUFBRCxFQUFtRDtBQUNqRHdELFVBQUFBLE9BQU8sQ0FBQ3hELFFBQVEsQ0FBQ29GLFNBQVYsQ0FBUCxHQUE4QnBGLFFBQVEsQ0FBQ3dELE9BQXZDO0FBQ0QsU0FISDtBQUtEOztBQUVELGFBQU9BLE9BQVA7QUFDRDs7Ozs7O2VBR1lqRCxlIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IGRhdGFiYXNlLCB7IERhdGFiYXNlIH0gZnJvbSAnQHJvb3QvYXBpL2RiJ1xuaW1wb3J0IHsgSHR0cEV4Y2VwdGlvbiwgSU1DUmVxdWVzdCwgSU1DUmVzcG9uc2UsIElVc2VyIH0gZnJvbSAnQHJvb3QvYXBpL3R5cGVzJ1xuaW1wb3J0IHtcbiAgYWRkVG9SZXNwb25zZSxcbiAgYXBwbHlRdWVyeUZpbHRlcnMsXG4gIGFwcGx5UXVlcnlTZWFyY2gsXG4gIGNhdGNoTWlkZGxld2FyZSxcbiAgZmlsdGVyVmlzaWJsZVRhYmxlQ29sdW1ucyxcbiAgZ2V0Q29sdW1uc1dpdGhSZWxhdGlvbnMsXG4gIGdldFRhYmxlQ29uZmlnLFxuICBoYXNBdXRob3JpemF0aW9uLFxuICBuZXh0QW5kUmV0dXJuLFxuICBydW5Ib29rXG59IGZyb20gJ0Byb290L2FwaS91dGlscydcbmltcG9ydCB7IElDb2x1bW5SZWxhdGlvbiwgSVRhYmxlSW5mbywgSUNvbHVtbkluZm8gfSBmcm9tICdAcm9vdC9jb25maWdHZW5lcmF0b3InXG5pbXBvcnQgQmx1ZWJpcmQgZnJvbSAnYmx1ZWJpcmQnXG5pbXBvcnQgRGVidWcgZnJvbSAnZGVidWcnXG5pbXBvcnQgeyBOZXh0RnVuY3Rpb24sIFJlcXVlc3QgfSBmcm9tICdleHByZXNzJ1xuaW1wb3J0IEtuZXggZnJvbSAnS25leCdcblxuY29uc3QgZGVidWcgPSBEZWJ1ZygnZnVuZnVuem1jOmNvbnRyb2xsZXItdGFibGUnKVxuXG5pbnRlcmZhY2UgSVRvUmVxdWVzdEl0ZW0ge1xuICB2YWx1ZXM6IFNldDxudW1iZXI+LFxuICBrZXk6IHN0cmluZyxcbiAgZGlzcGxheTogc3RyaW5nLFxuICBmb3JlaWduS2V5Q29sdW1uOiBzdHJpbmdcbn1cblxuaW50ZXJmYWNlIElUb1JlcXVlc3Qge1xuICBba2V5OiBzdHJpbmddOiBJVG9SZXF1ZXN0SXRlbSxcbn1cblxuZnVuY3Rpb24gdG9SZXF1ZXN0QnVpbGRlcihyZWxhdGlvbjogSUNvbHVtblJlbGF0aW9uLCBjb2x1bW5OYW1lOiBzdHJpbmcpOiBJVG9SZXF1ZXN0SXRlbSB7XG4gIHJldHVybiB7XG4gICAgdmFsdWVzOiBuZXcgU2V0PG51bWJlcj4oKSxcbiAgICBrZXk6IHJlbGF0aW9uLmtleSxcbiAgICBkaXNwbGF5OiByZWxhdGlvbi5kaXNwbGF5LFxuICAgIGZvcmVpZ25LZXlDb2x1bW46IGNvbHVtbk5hbWUsXG4gIH1cbn1cblxuY2xhc3MgVGFibGVDb250cm9sbGVyIHtcbiAgY29uc3RydWN0b3IoKSB7XG4gICAgZGVidWcoJ0NyZWF0ZWQnKVxuICB9XG5cbiAgcHVibGljIGdldFRhYmxlQ29uZmlnKHJlcTogSU1DUmVxdWVzdCwgcmVzOiBJTUNSZXNwb25zZSwgbmV4dDogTmV4dEZ1bmN0aW9uKSB7XG4gICAgY29uc3QgVEFCTEVfQ09ORklHID0gZ2V0VGFibGVDb25maWcocmVxLnBhcmFtcy50YWJsZSlcbiAgICBjb25zdCBSRVNVTFQgPSB7XG4gICAgICBjb2x1bW5zOiBUQUJMRV9DT05GSUcuY29sdW1ucyxcbiAgICAgIG5hbWU6IFRBQkxFX0NPTkZJRy5uYW1lLFxuICAgICAgcGs6IFRBQkxFX0NPTkZJRy5wayxcbiAgICAgIHZlcmJvc2U6IFRBQkxFX0NPTkZJRy52ZXJib3NlLFxuICAgICAgY2hpcHM6IFRBQkxFX0NPTkZJRy5jaGlwcyB8fCBbXSxcbiAgICAgIGl0ZW1UaXRsZTogVEFCTEVfQ09ORklHLml0ZW1UaXRsZSxcbiAgICB9XG5cbiAgICBpZiAoIWhhc0F1dGhvcml6YXRpb24oVEFCTEVfQ09ORklHLnJvbGVzLCByZXEudXNlcikpIHtcbiAgICAgIHJldHVybiBjYXRjaE1pZGRsZXdhcmUobmV4dCkobmV3IEh0dHBFeGNlcHRpb24oNDAxLCAnTm90IGF1dGhvcml6ZWQnKSlcbiAgICB9XG4gICAgYWRkVG9SZXNwb25zZShyZXMsICdyZXN1bHRzJykoUkVTVUxUKVxuICAgIHJldHVybiBuZXh0QW5kUmV0dXJuKG5leHQpKFJFU1VMVClcbiAgfVxuXG4gIHB1YmxpYyBnZXRUYWJsZURhdGEocmVxOiBJTUNSZXF1ZXN0LCByZXM6IElNQ1Jlc3BvbnNlLCBuZXh0OiBOZXh0RnVuY3Rpb24pIHtcbiAgICBjb25zdCBQQUdFX05VTUJFUiA9IHJlcS5xdWVyeS5wYWdlIHx8IDBcbiAgICBjb25zdCBUQUJMRV9OQU1FID0gcmVxLnBhcmFtcy50YWJsZVxuICAgIGNvbnN0IE9SREVSID0gcmVxLnF1ZXJ5Lm9yZGVyIHx8IG51bGxcbiAgICBjb25zdCBUQUJMRV9DT05GSUcgPSBnZXRUYWJsZUNvbmZpZyhUQUJMRV9OQU1FKVxuICAgIGNvbnN0IENPTFVNTlMgPSBmaWx0ZXJWaXNpYmxlVGFibGVDb2x1bW5zKFRBQkxFX0NPTkZJRywgJ21haW4nKVxuICAgIGxldCBMSU1JVCA9IDEwXG5cbiAgICBpZiAoIWhhc0F1dGhvcml6YXRpb24oVEFCTEVfQ09ORklHLnJvbGVzLCByZXEudXNlcikpIHtcbiAgICAgIHJldHVybiBjYXRjaE1pZGRsZXdhcmUobmV4dCkobmV3IEh0dHBFeGNlcHRpb24oNDAxLCAnTm90IGF1dGhvcml6ZWQnKSlcbiAgICB9XG4gICAgaWYgKCFkYXRhYmFzZS5kYikge1xuICAgICAgcmV0dXJuIGNhdGNoTWlkZGxld2FyZShuZXh0KShuZXcgSHR0cEV4Y2VwdGlvbig1MDAsICdObyBkYXRhYmFzZScpKVxuICAgIH1cbiAgICBjb25zdCBEQiA9IGRhdGFiYXNlLmRiXG4gICAgbGV0IFFVRVJZID0gREIuc2VsZWN0KENPTFVNTlMpLmZyb20oVEFCTEVfTkFNRSlcbiAgICBpZiAocmVxLnF1ZXJ5LmZpbHRlcikge1xuICAgICAgUVVFUlkgPSBhcHBseVF1ZXJ5RmlsdGVycyhRVUVSWSwgcmVxLnF1ZXJ5LmZpbHRlciwgVEFCTEVfQ09ORklHKVxuICAgIH1cblxuICAgIGlmIChyZXEucXVlcnkuc2VhcmNoKSB7XG4gICAgICBRVUVSWSA9IGFwcGx5UXVlcnlTZWFyY2goUVVFUlksIHJlcS5xdWVyeS5zZWFyY2gsIFRBQkxFX0NPTkZJRylcbiAgICB9XG5cbiAgICBpZiAoT1JERVIpIHtcbiAgICAgIGNvbnN0IE9SREVSX09CSiA9IEpTT04ucGFyc2UoT1JERVIpXG4gICAgICBpZiAoQXJyYXkuaXNBcnJheShPUkRFUl9PQkopKSB7XG4gICAgICAgIFFVRVJZLm9yZGVyQnkoT1JERVJfT0JKKVxuICAgICAgfSBlbHNlIHtcbiAgICAgICAgUVVFUlkub3JkZXJCeShPUkRFUl9PQkouY29sdW1uLCBPUkRFUl9PQkoub3JkZXIpXG4gICAgICB9XG4gICAgfVxuXG4gICAgaWYgKHJlcS5xdWVyeS5saW1pdCkge1xuICAgICAgTElNSVQgPSBwYXJzZUludChyZXEucXVlcnkubGltaXQsIDEwKVxuICAgIH1cbiAgICBpZiAoTElNSVQgPiAwKSB7XG4gICAgICBRVUVSWS5vZmZzZXQoKFBBR0VfTlVNQkVSKSAqIExJTUlUKS5saW1pdChMSU1JVClcbiAgICB9XG5cbiAgICByZXR1cm4gcnVuSG9vayhUQUJMRV9DT05GSUcsICdnZXRUYWJsZURhdGEnLCAnYmVmb3JlJywgcmVxLCByZXMsIGRhdGFiYXNlLmRiKS50aGVuKFxuICAgICAgKGhvb2tSZXN1bHQpID0+IHtcbiAgICAgICAgaWYgKGhvb2tSZXN1bHQpIHtcbiAgICAgICAgICBpZiAoaG9va1Jlc3VsdC5maWx0ZXIpIHtcbiAgICAgICAgICAgIE9iamVjdC5rZXlzKGhvb2tSZXN1bHQuZmlsdGVyKS5mb3JFYWNoKFxuICAgICAgICAgICAgICAoY29sdW1uKSA9PiB7XG4gICAgICAgICAgICAgICAgaWYgKEFycmF5LmlzQXJyYXkoaG9va1Jlc3VsdC5maWx0ZXJbY29sdW1uXSkpIHtcbiAgICAgICAgICAgICAgICAgIFFVRVJZLndoZXJlSW4oY29sdW1uLCBob29rUmVzdWx0LmZpbHRlcltjb2x1bW5dKVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgKVxuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gUVVFUllcbiAgICAgIH1cbiAgICApLnRoZW4oXG4gICAgICAocmVzdWx0cykgPT4ge1xuICAgICAgICBpZiAocmVxLnF1ZXJ5LmZyaWVuZGx5RGF0YSkge1xuICAgICAgICAgIHJldHVybiB0aGlzLmFkZFZlcmJvc2VSZWxhdGVkRGF0YShyZXN1bHRzLCBUQUJMRV9DT05GSUcsIERCKVxuICAgICAgICB9XG4gICAgICAgIHJldHVybiByZXN1bHRzXG4gICAgICB9XG4gICAgKS50aGVuKFxuICAgICAgKHJlc3VsdHMpID0+IHtcbiAgICAgICAgcmV0dXJuIHJ1bkhvb2soVEFCTEVfQ09ORklHLCAnZ2V0VGFibGVEYXRhJywgJ2FmdGVyJywgcmVxLCByZXMsIGRhdGFiYXNlLmRiLCByZXN1bHRzKVxuICAgICAgfVxuICAgICkudGhlbihcbiAgICAgIGFkZFRvUmVzcG9uc2UocmVzLCAncmVzdWx0cycpXG4gICAgKS50aGVuKFxuICAgICAgbmV4dEFuZFJldHVybihuZXh0KVxuICAgIClcbiAgfVxuXG4gIHB1YmxpYyBnZXRUYWJsZUNvdW50KHJlcTogSU1DUmVxdWVzdCwgcmVzOiBJTUNSZXNwb25zZSwgbmV4dDogTmV4dEZ1bmN0aW9uKSB7XG4gICAgY29uc3QgVEFCTEVfTkFNRSA9IHJlcS5wYXJhbXMudGFibGVcbiAgICBjb25zdCBUQUJMRV9DT05GSUcgPSBnZXRUYWJsZUNvbmZpZyhUQUJMRV9OQU1FKVxuXG4gICAgcmV0dXJuIHRoaXMucmVxdWlyZW1lbnRzQ2hlY2soVEFCTEVfQ09ORklHLCByZXEudXNlciwgZGF0YWJhc2UsIG5leHQpLnRoZW4oXG4gICAgICAoREIpID0+IHtcbiAgICAgICAgbGV0IFFVRVJZID0gREIoVEFCTEVfTkFNRSkuc2VsZWN0KCcqJylcbiAgICAgICAgaWYgKHJlcS5xdWVyeS5zZWFyY2gpIHtcbiAgICAgICAgICBRVUVSWSA9IGFwcGx5UXVlcnlTZWFyY2goUVVFUlksIHJlcS5xdWVyeS5zZWFyY2gsIFRBQkxFX0NPTkZJRylcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gUHJvbWlzZS5hbGwoW0RCLCBRVUVSWV0pXG4gICAgICB9XG4gICAgKS50aGVuKFxuICAgICAgKFtEQiwgcmVzdWx0c10pID0+IHtcbiAgICAgICAgcmV0dXJuIHJ1bkhvb2soVEFCTEVfQ09ORklHLCAnZ2V0VGFibGVDb3VudCcsICdhZnRlcicsIHJlcSwgcmVzLCBEQiwgcmVzdWx0cylcbiAgICAgIH1cbiAgICApLnRoZW4oXG4gICAgICBhZGRUb1Jlc3BvbnNlKHJlcywgJ2NvdW50JylcbiAgICApLnRoZW4oXG4gICAgICBuZXh0QW5kUmV0dXJuKG5leHQpXG4gICAgKS5jYXRjaChcbiAgICAgIGNhdGNoTWlkZGxld2FyZShuZXh0KVxuICAgIClcbiAgfVxuXG4gIHB1YmxpYyBnZXRSb3cocmVxOiBJTUNSZXF1ZXN0LCByZXM6IElNQ1Jlc3BvbnNlLCBuZXh0OiBOZXh0RnVuY3Rpb24pIHtcbiAgICBjb25zdCBUQUJMRV9OQU1FID0gcmVxLnBhcmFtcy50YWJsZVxuICAgIGNvbnN0IFRBQkxFX0NPTkZJRyA9IGdldFRhYmxlQ29uZmlnKFRBQkxFX05BTUUpXG5cbiAgICByZXR1cm4gdGhpcy5yZXF1aXJlbWVudHNDaGVjayhUQUJMRV9DT05GSUcsIHJlcS51c2VyLCBkYXRhYmFzZSwgbmV4dCkudGhlbihcbiAgICAgIChEQikgPT4ge1xuICAgICAgICBjb25zdCByZXF1ZXN0ZWRDb2x1bW5zID0gZmlsdGVyVmlzaWJsZVRhYmxlQ29sdW1ucyhUQUJMRV9DT05GSUcsICdkZXRhaWwnKVxuXG4gICAgICAgIHJldHVybiBEQi5zZWxlY3QocmVxdWVzdGVkQ29sdW1ucylcbiAgICAgICAgICAuZnJvbShgJHtyZXEucGFyYW1zLnRhYmxlfWApXG4gICAgICAgICAgLndoZXJlKCdpZCcsIHJlcS5wYXJhbXMuaWQpXG4gICAgICB9XG4gICAgKS50aGVuKFxuICAgICAgKHJlc3VsdHMpID0+IHtcbiAgICAgICAgbGV0IHJlbGF0aW9uUXVlcmllczogQXJyYXk8Qmx1ZWJpcmQ8e30+PiA9IFtdXG4gICAgICAgIGlmIChyZXEucXVlcnkuaW5jbHVkZVJlbGF0aW9ucykge1xuICAgICAgICAgIHJlbGF0aW9uUXVlcmllcyA9IHRoaXMuZ2V0UmVsYXRpb25RdWVyaWVzKFRBQkxFX0NPTkZJRywgcmVzdWx0c1swXS5pZClcbiAgICAgICAgfVxuXG4gICAgICAgIGlmIChyZWxhdGlvblF1ZXJpZXMubGVuZ3RoKSB7XG4gICAgICAgICAgcmV0dXJuIFByb21pc2UuYWxsKFtcbiAgICAgICAgICAgIHJlc3VsdHNbMF0sXG4gICAgICAgICAgICAuLi5yZWxhdGlvblF1ZXJpZXMsXG4gICAgICAgICAgXSlcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiBQcm9taXNlLmFsbChbXG4gICAgICAgICAgcmVzdWx0c1swXSxcbiAgICAgICAgXSlcbiAgICAgIH1cbiAgICApLnRoZW4oXG4gICAgICB0aGlzLm1lcmdlUmVsYXRlZERhdGFcbiAgICApLnRoZW4oXG4gICAgICBhZGRUb1Jlc3BvbnNlKHJlcywgJ3Jlc3VsdHMnKVxuICAgICkudGhlbihcbiAgICAgIG5leHRBbmRSZXR1cm4obmV4dClcbiAgICApLmNhdGNoKFxuICAgICAgY2F0Y2hNaWRkbGV3YXJlKG5leHQpXG4gICAgKVxuICB9XG5cbiAgcHVibGljIGluc2VydFJvdyhyZXE6IElNQ1JlcXVlc3QsIHJlczogSU1DUmVzcG9uc2UsIG5leHQ6IE5leHRGdW5jdGlvbikge1xuICAgIGNvbnN0IFRBQkxFX05BTUUgPSByZXEucGFyYW1zLnRhYmxlXG4gICAgY29uc3QgVEFCTEVfQ09ORklHID0gZ2V0VGFibGVDb25maWcoVEFCTEVfTkFNRSlcblxuICAgIHJldHVybiB0aGlzLnJlcXVpcmVtZW50c0NoZWNrKFRBQkxFX0NPTkZJRywgcmVxLnVzZXIsIGRhdGFiYXNlLCBuZXh0KS50aGVuKFxuICAgICAgKERCKSA9PiB7XG4gICAgICAgIFRBQkxFX0NPTkZJRy5jb2x1bW5zLmZvckVhY2goXG4gICAgICAgICAgKGNvbHVtbikgPT4ge1xuICAgICAgICAgICAgaWYgKGNvbHVtbi50eXBlID09PSAnZGF0ZXRpbWUnKSB7XG4gICAgICAgICAgICAgIHJlcS5ib2R5LmRhdGFbY29sdW1uLm5hbWVdID0gbmV3IERhdGUocmVxLmJvZHkuZGF0YVtjb2x1bW4ubmFtZV0gfHwgbnVsbClcbiAgICAgICAgICAgIH0gZWxzZSBpZiAoY29sdW1uLnR5cGUgPT09ICd0aW55aW50KDEpJykge1xuICAgICAgICAgICAgICByZXEuYm9keS5kYXRhW2NvbHVtbi5uYW1lXSA9IGNvbHVtbi50eXBlID8gMSA6IDBcbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9XG4gICAgICAgIClcbiAgICAgICAgcmV0dXJuIERCKHJlcS5wYXJhbXMudGFibGUpLmluc2VydChyZXEuYm9keS5kYXRhKVxuICAgICAgfVxuICAgICkudGhlbihcbiAgICAgIChyZXN1bHRzKSA9PiB7XG4gICAgICAgIGFkZFRvUmVzcG9uc2UocmVzLCAncmVzdWx0cycpKHJlc3VsdHMpXG4gICAgICB9XG4gICAgKS50aGVuKFxuICAgICAgbmV4dEFuZFJldHVybihuZXh0KVxuICAgICkuY2F0Y2goXG4gICAgICBjYXRjaE1pZGRsZXdhcmUobmV4dClcbiAgICApXG4gIH1cblxuICBwdWJsaWMgdXBkYXRlUm93KHJlcTogSU1DUmVxdWVzdCwgcmVzOiBJTUNSZXNwb25zZSwgbmV4dDogTmV4dEZ1bmN0aW9uKSB7XG4gICAgY29uc3QgVEFCTEVfTkFNRSA9IHJlcS5wYXJhbXMudGFibGVcbiAgICBjb25zdCBUQUJMRV9DT05GSUcgPSBnZXRUYWJsZUNvbmZpZyhUQUJMRV9OQU1FKVxuXG4gICAgcmV0dXJuIHRoaXMucmVxdWlyZW1lbnRzQ2hlY2soVEFCTEVfQ09ORklHLCByZXEudXNlciwgZGF0YWJhc2UsIG5leHQpLnRoZW4oXG4gICAgICAoREIpID0+IHtcbiAgICAgICAgVEFCTEVfQ09ORklHLmNvbHVtbnMuZm9yRWFjaChcbiAgICAgICAgICAoY29sdW1uKSA9PiB7XG4gICAgICAgICAgICBpZiAoY29sdW1uLnR5cGUgPT09ICdkYXRldGltZScpIHtcbiAgICAgICAgICAgICAgcmVxLmJvZHkuZGF0YVtjb2x1bW4ubmFtZV0gPSBuZXcgRGF0ZShyZXEuYm9keS5kYXRhW2NvbHVtbi5uYW1lXSB8fCBudWxsKVxuICAgICAgICAgICAgfVxuICAgICAgICAgIH1cbiAgICAgICAgKVxuXG4gICAgICAgIHJldHVybiBEQihUQUJMRV9OQU1FKS53aGVyZSgnaWQnLCByZXEucGFyYW1zLmlkKS51cGRhdGUocmVxLmJvZHkuZGF0YSlcbiAgICAgIH1cbiAgICApLnRoZW4oXG4gICAgICBhZGRUb1Jlc3BvbnNlKHJlcywgJ3Jlc3VsdHMnKVxuICAgICkudGhlbihcbiAgICAgIG5leHRBbmRSZXR1cm4obmV4dClcbiAgICApLmNhdGNoKFxuICAgICAgY2F0Y2hNaWRkbGV3YXJlKG5leHQpXG4gICAgKVxuICB9XG5cbiAgcHVibGljIGRlbGV0ZVJvdyhyZXE6IElNQ1JlcXVlc3QsIHJlczogSU1DUmVzcG9uc2UsIG5leHQ6IE5leHRGdW5jdGlvbikge1xuICAgIGNvbnN0IFRBQkxFX05BTUUgPSByZXEucGFyYW1zLnRhYmxlXG4gICAgY29uc3QgVEFCTEVfQ09ORklHID0gZ2V0VGFibGVDb25maWcoVEFCTEVfTkFNRSlcblxuICAgIHJldHVybiB0aGlzLnJlcXVpcmVtZW50c0NoZWNrKFRBQkxFX0NPTkZJRywgcmVxLnVzZXIsIGRhdGFiYXNlLCBuZXh0KS50aGVuKFxuICAgICAgKERCKSA9PiB7XG4gICAgICAgIHJldHVybiBEQihUQUJMRV9OQU1FKS53aGVyZSgnaWQnLCByZXEucGFyYW1zLmlkKS5kZWwoKVxuICAgICAgfVxuICAgICkudGhlbihcbiAgICAgIGFkZFRvUmVzcG9uc2UocmVzLCAncmVzdWx0cycpXG4gICAgKS50aGVuKFxuICAgICAgbmV4dEFuZFJldHVybihuZXh0KVxuICAgICkuY2F0Y2goXG4gICAgICBjYXRjaE1pZGRsZXdhcmUobmV4dClcbiAgICApXG4gIH1cblxuICBwcml2YXRlIGFkZFZlcmJvc2VSZWxhdGVkRGF0YShyZXN1bHRzOiBhbnlbXSwgVEFCTEVfQ09ORklHOiBJVGFibGVJbmZvLCBEQjogS25leCkge1xuICAgIGNvbnN0IHRvUmVxdWVzdDogSVRvUmVxdWVzdCA9IHt9XG4gICAgY29uc3QgQ09MVU1OU19XSVRIX1JFTEFUSU9OUyA9IGdldENvbHVtbnNXaXRoUmVsYXRpb25zKFRBQkxFX0NPTkZJRylcbiAgICByZXN1bHRzLmZvckVhY2goXG4gICAgICAocm93OiBhbnksIGluZGV4OiBudW1iZXIpID0+IHtcbiAgICAgICAgQ09MVU1OU19XSVRIX1JFTEFUSU9OUy5mb3JFYWNoKFxuICAgICAgICAgIChjb2x1bW4pID0+IHtcbiAgICAgICAgICAgIGlmICghY29sdW1uLnJlbGF0aW9uKSB7XG4gICAgICAgICAgICAgIHRocm93IG5ldyBIdHRwRXhjZXB0aW9uKDUwMCwgJ0NvbHVtbiBzaG91bGQgaGF2ZSBhIHJlbGF0aW9uJylcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGNvbnN0IFJFTEFUSU9OX1RBQkxFX05BTUUgPSBjb2x1bW4ucmVsYXRpb24udGFibGVcblxuICAgICAgICAgICAgaWYgKCF0b1JlcXVlc3RbUkVMQVRJT05fVEFCTEVfTkFNRV0pIHtcbiAgICAgICAgICAgICAgdG9SZXF1ZXN0W1JFTEFUSU9OX1RBQkxFX05BTUVdID0gdG9SZXF1ZXN0QnVpbGRlcihjb2x1bW4ucmVsYXRpb24sIGNvbHVtbi5uYW1lKVxuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICB0b1JlcXVlc3RbUkVMQVRJT05fVEFCTEVfTkFNRV0udmFsdWVzLmFkZChyb3dbY29sdW1uLm5hbWVdKVxuICAgICAgICAgIH1cbiAgICAgICAgKVxuICAgICAgfVxuICAgIClcblxuICAgIGNvbnN0IHJlbGF0aW9uUXVlcmllczogS25leC5RdWVyeUJ1aWxkZXJbXSA9IFtdXG4gICAgT2JqZWN0LmtleXModG9SZXF1ZXN0KS5mb3JFYWNoKFxuICAgICAgKHRhYmxlTmFtZSkgPT4ge1xuICAgICAgICByZWxhdGlvblF1ZXJpZXMucHVzaChcbiAgICAgICAgICBEQi5zZWxlY3QodG9SZXF1ZXN0W3RhYmxlTmFtZV0uZGlzcGxheSwgdG9SZXF1ZXN0W3RhYmxlTmFtZV0ua2V5KVxuICAgICAgICAgICAgLmZyb20odGFibGVOYW1lKVxuICAgICAgICAgICAgLndoZXJlSW4odG9SZXF1ZXN0W3RhYmxlTmFtZV0ua2V5LCBBcnJheS5mcm9tKHRvUmVxdWVzdFt0YWJsZU5hbWVdLnZhbHVlcy52YWx1ZXMoKSkpXG4gICAgICAgIClcbiAgICAgIH1cbiAgICApXG5cbiAgICByZXR1cm4gUHJvbWlzZS5hbGw8YW55W10+KHJlbGF0aW9uUXVlcmllcykudGhlbihcbiAgICAgIChyZWxhdGlvblJlc3VsdHMpID0+IHtcbiAgICAgICAgY29uc3QgTUFUQ0hFUjoge1xuICAgICAgICAgIFtmb3JlaWduS2V5Q29sdW1uOiBzdHJpbmddOiB7XG4gICAgICAgICAgICBbdmFsdWU6IHN0cmluZ106IHN0cmluZ1xuICAgICAgICAgIH1cbiAgICAgICAgfSA9IHt9XG4gICAgICAgIE9iamVjdC52YWx1ZXModG9SZXF1ZXN0KS5mb3JFYWNoKFxuICAgICAgICAgIChyZXF1ZXN0ZWRUYWJsZSwgaW5kZXgpID0+IHtcbiAgICAgICAgICAgIGNvbnN0IEZPUkVJR05fS0VZX0NPTFVNTiA9IHJlcXVlc3RlZFRhYmxlLmZvcmVpZ25LZXlDb2x1bW5cbiAgICAgICAgICAgIE1BVENIRVJbRk9SRUlHTl9LRVlfQ09MVU1OXSA9IHt9XG4gICAgICAgICAgICByZWxhdGlvblJlc3VsdHNbaW5kZXhdLmZvckVhY2goXG4gICAgICAgICAgICAgIChyZWxhdGlvblJvdzogYW55KSA9PiB7XG4gICAgICAgICAgICAgICAgY29uc3QgQ1VSUkVOVF9WQUxVRSA9IHJlbGF0aW9uUm93W3JlcXVlc3RlZFRhYmxlLmtleV1cbiAgICAgICAgICAgICAgICBjb25zdCBWQUxVRV9UT19ESVNQTEFZID0gcmVsYXRpb25Sb3dbcmVxdWVzdGVkVGFibGUuZGlzcGxheV1cbiAgICAgICAgICAgICAgICBNQVRDSEVSW0ZPUkVJR05fS0VZX0NPTFVNTl1bQ1VSUkVOVF9WQUxVRV0gPSBWQUxVRV9UT19ESVNQTEFZXG4gICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIClcbiAgICAgICAgICB9XG4gICAgICAgIClcbiAgICAgICAgcmV0dXJuIHJlc3VsdHMubWFwKFxuICAgICAgICAgIChyb3c6IGFueSkgPT4ge1xuICAgICAgICAgICAgT2JqZWN0LnZhbHVlcyh0b1JlcXVlc3QpLmZvckVhY2goXG4gICAgICAgICAgICAgIChyZXF1ZXN0ZWRUYWJsZSkgPT4ge1xuICAgICAgICAgICAgICAgIGNvbnN0IFJPV19LRVkgPSByZXF1ZXN0ZWRUYWJsZS5mb3JlaWduS2V5Q29sdW1uXG4gICAgICAgICAgICAgICAgcm93W1JPV19LRVldID0gTUFUQ0hFUltST1dfS0VZXVtyb3dbUk9XX0tFWV1dXG4gICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIClcbiAgICAgICAgICAgIHJldHVybiByb3dcbiAgICAgICAgICB9XG4gICAgICAgIClcbiAgICAgIH1cbiAgICApXG4gIH1cblxuICBwcml2YXRlIHJlcXVpcmVtZW50c0NoZWNrKFxuICAgIHRhYmxlQ29uZmlnOiBJVGFibGVJbmZvLFxuICAgIHVzZXI6IElVc2VyIHwgdW5kZWZpbmVkLFxuICAgIGRiSW5zdGFuY2U6IERhdGFiYXNlLFxuICAgIG5leHQ6IChwYXJhbT86IGFueSkgPT4gdm9pZFxuICApIHtcbiAgICBpZiAoIWhhc0F1dGhvcml6YXRpb24odGFibGVDb25maWcucm9sZXMsIHVzZXIpKSB7XG4gICAgICByZXR1cm4gUHJvbWlzZS5yZWplY3QobmV3IEh0dHBFeGNlcHRpb24oNDAxLCAnTm90IGF1dGhvcml6ZWQnKSlcbiAgICB9XG4gICAgaWYgKCFkYkluc3RhbmNlLmRiKSB7XG4gICAgICByZXR1cm4gY2F0Y2hNaWRkbGV3YXJlKG5leHQpKG5ldyBIdHRwRXhjZXB0aW9uKDUwMCwgJ05vIGRhdGFiYXNlJykpXG4gICAgfVxuICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUoZGJJbnN0YW5jZS5kYilcbiAgfVxuXG4gIHByaXZhdGUgZ2V0UmVsYXRpb25RdWVyaWVzKFRBQkxFX0NPTkZJRzogSVRhYmxlSW5mbywgcGFyZW50SWQ6IGFueSkge1xuICAgIGNvbnN0IHJlbGF0aW9uUXVlcmllczogQXJyYXk8Qmx1ZWJpcmQ8e30+PiA9IFtdXG4gICAgaWYgKFRBQkxFX0NPTkZJRy5yZWxhdGlvbnMgJiYgVEFCTEVfQ09ORklHLnJlbGF0aW9ucy5tYW55VG9PbmUpIHtcbiAgICAgIGNvbnN0IE1BTllfVE9fT05FID0gVEFCTEVfQ09ORklHLnJlbGF0aW9ucy5tYW55VG9PbmVcbiAgICAgIGNvbnN0IEtFWVM6IHN0cmluZ1tdID0gT2JqZWN0LmtleXMoTUFOWV9UT19PTkUpXG4gICAgICBLRVlTLmZvckVhY2goXG4gICAgICAgICh0YWJsZU5hbWUpID0+IHtcbiAgICAgICAgICByZWxhdGlvblF1ZXJpZXMucHVzaChcbiAgICAgICAgICAgIHRoaXMuZ2V0UmVsYXRlZFJvdyhcbiAgICAgICAgICAgICAgdGFibGVOYW1lLFxuICAgICAgICAgICAgICBNQU5ZX1RPX09ORVt0YWJsZU5hbWVdLFxuICAgICAgICAgICAgICBwYXJlbnRJZFxuICAgICAgICAgICAgKVxuICAgICAgICAgIClcbiAgICAgICAgfVxuICAgICAgKVxuICAgIH1cblxuICAgIHJldHVybiByZWxhdGlvblF1ZXJpZXNcbiAgfVxuXG4gIHByaXZhdGUgZ2V0UmVsYXRlZFJvdyh0YWJsZU5hbWU6IHN0cmluZywgY29sdW1uTmFtZTogc3RyaW5nLCBwYXJlbnRJZDogYW55KSB7XG4gICAgaWYgKCFkYXRhYmFzZS5kYikge1xuICAgICAgdGhyb3cgbmV3IEh0dHBFeGNlcHRpb24oNTAwLCAnTm8gZGF0YWJhc2UnKVxuICAgIH1cbiAgICBjb25zdCBUQUJMRV9OQU1FID0gdGFibGVOYW1lXG4gICAgY29uc3QgVEFCTEVfQ09ORklHID0gZ2V0VGFibGVDb25maWcoVEFCTEVfTkFNRSlcblxuICAgIGNvbnN0IHJlcXVlc3RlZENvbHVtbnMgPSBmaWx0ZXJWaXNpYmxlVGFibGVDb2x1bW5zKFRBQkxFX0NPTkZJRywgJ2RldGFpbCcpLmZpbHRlcihcbiAgICAgIChjb2x1bW4pID0+IGNvbHVtbiAhPT0gY29sdW1uTmFtZVxuICAgIClcbiAgICBcbiAgICByZXR1cm4gZGF0YWJhc2UuZGIuc2VsZWN0KHJlcXVlc3RlZENvbHVtbnMpXG4gICAgICAuZnJvbSh0YWJsZU5hbWUpXG4gICAgICAud2hlcmUoY29sdW1uTmFtZSwgcGFyZW50SWQpLnRoZW4oXG4gICAgICAgIChyZXN1bHRzKSA9PiAoe1xuICAgICAgICAgIHJlc3VsdHMsXG4gICAgICAgICAgdGFibGVOYW1lLFxuICAgICAgICB9KVxuICAgICAgKVxuICB9XG5cbiAgcHJpdmF0ZSBtZXJnZVJlbGF0ZWREYXRhKFtyZXN1bHRzLCAuLi5yZWxhdGlvbnNdOiBhbnkpIHtcbiAgICBpZiAocmVsYXRpb25zICYmIHJlbGF0aW9ucy5sZW5ndGgpIHtcbiAgICAgIHJlbGF0aW9ucy5mb3JFYWNoKFxuICAgICAgICAocmVsYXRpb246IHt0YWJsZU5hbWU6IHN0cmluZywgcmVzdWx0czogYW55W119KSA9PiB7XG4gICAgICAgICAgcmVzdWx0c1tyZWxhdGlvbi50YWJsZU5hbWVdID0gcmVsYXRpb24ucmVzdWx0c1xuICAgICAgICB9XG4gICAgICApXG4gICAgfVxuXG4gICAgcmV0dXJuIHJlc3VsdHNcbiAgfVxufVxuXG5leHBvcnQgZGVmYXVsdCBUYWJsZUNvbnRyb2xsZXJcbiJdfQ==