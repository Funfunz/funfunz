"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _db = _interopRequireDefault(require("../db"));

var _types = require("../types");

var _utils = require("../utils");

var _debug = _interopRequireDefault(require("debug"));

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

function _toConsumableArray(arr) { return _arrayWithoutHoles(arr) || _iterableToArray(arr) || _nonIterableSpread(); }

function _nonIterableSpread() { throw new TypeError("Invalid attempt to spread non-iterable instance"); }

function _arrayWithoutHoles(arr) { if (Array.isArray(arr)) { for (var i = 0, arr2 = new Array(arr.length); i < arr.length; i++) { arr2[i] = arr[i]; } return arr2; } }

function _toArray(arr) { return _arrayWithHoles(arr) || _iterableToArray(arr) || _nonIterableRest(); }

function _nonIterableRest() { throw new TypeError("Invalid attempt to destructure non-iterable instance"); }

function _iterableToArray(iter) { if (Symbol.iterator in Object(iter) || Object.prototype.toString.call(iter) === "[object Arguments]") return Array.from(iter); }

function _arrayWithHoles(arr) { if (Array.isArray(arr)) return arr; }

function _objectSpread(target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i] != null ? arguments[i] : {}; var ownKeys = Object.keys(source); if (typeof Object.getOwnPropertySymbols === 'function') { ownKeys = ownKeys.concat(Object.getOwnPropertySymbols(source).filter(function (sym) { return Object.getOwnPropertyDescriptor(source, sym).enumerable; })); } ownKeys.forEach(function (key) { _defineProperty(target, key, source[key]); }); } return target; }

function _defineProperty(obj, key, value) { if (key in obj) { Object.defineProperty(obj, key, { value: value, enumerable: true, configurable: true, writable: true }); } else { obj[key] = value; } return obj; }

function _classCallCheck(instance, Constructor) { if (!(instance instanceof Constructor)) { throw new TypeError("Cannot call a class as a function"); } }

function _defineProperties(target, props) { for (var i = 0; i < props.length; i++) { var descriptor = props[i]; descriptor.enumerable = descriptor.enumerable || false; descriptor.configurable = true; if ("value" in descriptor) descriptor.writable = true; Object.defineProperty(target, descriptor.key, descriptor); } }

function _createClass(Constructor, protoProps, staticProps) { if (protoProps) _defineProperties(Constructor.prototype, protoProps); if (staticProps) _defineProperties(Constructor, staticProps); return Constructor; }

var debug = (0, _debug.default)('funfunzmc:controller-table');

var TableController =
/*#__PURE__*/
function () {
  function TableController() {
    _classCallCheck(this, TableController);

    debug('Created');
  }

  _createClass(TableController, [{
    key: "getTableConfig",
    value: function getTableConfig(req, res, next) {
      var userRoles = [];

      if (req.user && req.user.roles) {
        userRoles = req.user.roles;
      }

      var TABLE_CONFIG = (0, _utils.getTableConfig)(req.params.table);
      var RESULT = {
        columns: TABLE_CONFIG.columns,
        name: TABLE_CONFIG.name,
        pk: TABLE_CONFIG.pk,
        verbose: TABLE_CONFIG.verbose
      };

      if ((0, _utils.hasAuthorization)(TABLE_CONFIG.roles, userRoles)) {
        (0, _utils.addToResponse)(res, 'results')(RESULT);
        return (0, _utils.nextAndReturn)(next)(RESULT);
      } else {
        return (0, _utils.catchMiddleware)(next)(new _types.HttpException(401, 'Not authorized'));
      }
    }
  }, {
    key: "getTableData",
    value: function getTableData(req, res, next) {
      var PAGE_NUMBER = req.query.page;
      var LIMIT = 10;
      var TABLE_NAME = req.params.table;
      var TABLE_CONFIG = (0, _utils.getTableConfig)(TABLE_NAME);
      var COLUMNS = (0, _utils.filterTableColumns)(TABLE_CONFIG, 'main');
      var userRoles = [];

      if (req.user && req.user.roles) {
        userRoles = req.user.roles;
      }

      if (!(0, _utils.hasAuthorization)(TABLE_CONFIG.roles, userRoles)) {
        return (0, _utils.catchMiddleware)(next)(new _types.HttpException(401, 'Not authorized'));
      } else {
        if (!_db.default.db) {
          return (0, _utils.catchMiddleware)(next)(new _types.HttpException(500, 'No database'));
        } else {
          var DB = _db.default.db;
          var QUERY = DB.select(COLUMNS).from(TABLE_NAME);

          if (req.query.filter) {
            var columnsByKey = {};
            TABLE_CONFIG.columns.forEach(function (column) {
              columnsByKey[column.name] = column;
            });
            var FILTERS = JSON.parse(req.query.filter);
            Object.keys(FILTERS).forEach(function (key, index) {
              if (columnsByKey[key].type === 'int(11)') {
                index === 0 ? QUERY.where(_defineProperty({}, key, FILTERS[key])) : QUERY.andWhere(_defineProperty({}, key, FILTERS[key]));
              } else {
                index === 0 ? QUERY.where(key, 'like', '%' + FILTERS[key] + '%') : QUERY.andWhere(key, 'like', '%' + FILTERS[key] + '%');
              }
            });
          }

          return QUERY.offset((PAGE_NUMBER || 0) * LIMIT).limit(LIMIT).then(function (results) {
            var toRequest = {};
            var RELATIONS = TABLE_CONFIG.columns.filter(function (column) {
              return column.relation;
            });
            results.forEach(function (row, index) {
              RELATIONS.forEach(function (column) {
                if (column.relation) {
                  if (!toRequest[column.relation.table]) {
                    toRequest[column.relation.table] = {
                      values: {},
                      key: column.relation.key,
                      display: column.relation.display,
                      parentColumn: column.name
                    };
                  }

                  if (toRequest[column.relation.table].values[row[column.name]] === undefined) {
                    toRequest[column.relation.table].values = _objectSpread({}, toRequest[column.relation.table].values, _defineProperty({}, row[column.name], index));
                  }
                }
              });
            });
            var relationQueries = [];
            Object.keys(toRequest).forEach(function (tableName) {
              relationQueries.push(DB.select(toRequest[tableName].display).from(tableName).whereIn(toRequest[tableName].key, Object.keys(toRequest[tableName].values)));
            });
            return Promise.all([results, toRequest].concat(relationQueries));
          }).then(function (_ref) {
            var _ref2 = _toArray(_ref),
                results = _ref2[0],
                toRequest = _ref2[1],
                relationResults = _ref2.slice(2);

            return results.map(function (row) {
              Object.keys(toRequest).forEach(function (tableName, index) {
                var ROW_KEY = toRequest[tableName].parentColumn;
                var ROW_INDEX = toRequest[tableName].values[row[ROW_KEY]];
                console.log(toRequest);
                console.log(ROW_KEY, ROW_INDEX, relationResults[index]);
                row[ROW_KEY] = relationResults[index][ROW_INDEX][toRequest[tableName].display];
              });
              return row;
            });
          }).then(function (results) {
            return (0, _utils.runHook)(TABLE_CONFIG, 'getTableData', 'after', req, res, _db.default.db, results);
          }).then((0, _utils.addToResponse)(res, 'results')).then((0, _utils.nextAndReturn)(next));
        }
      }
    }
  }, {
    key: "getTableCount",
    value: function getTableCount(req, res, next) {
      var TABLE_NAME = req.params.table;
      var TABLE_CONFIG = (0, _utils.getTableConfig)(TABLE_NAME);
      var userRoles = [];

      if (req.user && req.user.roles) {
        userRoles = req.user.roles;
      }

      if (!(0, _utils.hasAuthorization)(TABLE_CONFIG.roles, userRoles)) {
        return (0, _utils.catchMiddleware)(next)(new _types.HttpException(401, 'Not authorized'));
      } else {
        if (!_db.default.db) {
          return (0, _utils.catchMiddleware)(next)(new _types.HttpException(500, 'No database'));
        } else {
          return _db.default.db.select('*').from(TABLE_NAME).then(function (results) {
            (0, _utils.runHook)(TABLE_CONFIG, 'getTableCount', 'after', req, res, _db.default.db, results).then((0, _utils.addToResponse)(res, 'count')).then((0, _utils.nextAndReturn)(next));
          });
        }
      }
    }
  }, {
    key: "getRow",
    value: function getRow(req, res, next) {
      var _this = this;

      var TABLE_NAME = req.params.table;
      var TABLE_CONFIG = (0, _utils.getTableConfig)(TABLE_NAME);
      var userRoles = [];

      if (req.user && req.user.roles) {
        userRoles = req.user.roles;
      }

      if (!(0, _utils.hasAuthorization)(TABLE_CONFIG.roles, userRoles)) {
        return (0, _utils.catchMiddleware)(next)(new _types.HttpException(401, 'Not authorized'));
      } else {
        if (!_db.default.db) {
          return (0, _utils.catchMiddleware)(next)(new _types.HttpException(500, 'No database'));
        } else {
          var requestedColumns = (0, _utils.filterTableColumns)(TABLE_CONFIG, 'detail');

          var query = _db.default.db.select(requestedColumns).from("".concat(req.params.table)).where("id", req.params.id);

          return query.then(function (results) {
            var relationQueries = [];

            if (req.query.includeRelations) {
              relationQueries = _this.getRelationQueries(TABLE_CONFIG, results[0].id);
            }

            if (relationQueries.length) {
              return Promise.all([results[0]].concat(_toConsumableArray(relationQueries)));
            }

            return Promise.all([results[0]]);
          }).then(this.mergeRelatedData).then((0, _utils.addToResponse)(res, 'result')).then((0, _utils.nextAndReturn)(next));
        }
      }
    }
  }, {
    key: "insertRow",
    value: function insertRow(req, res, next) {
      if (!_db.default.db) {
        return (0, _utils.catchMiddleware)(next)(new _types.HttpException(500, 'No database'));
      } else {
        return _db.default.db(req.params.table).insert(req.body.data).then((0, _utils.addToResponse)(res, 'results')).then((0, _utils.nextAndReturn)(next));
      }
    }
  }, {
    key: "updateRow",
    value: function updateRow(req, res, next) {
      if (!_db.default.db) {
        return (0, _utils.catchMiddleware)(next)(new _types.HttpException(500, 'No database'));
      } else {
        return _db.default.db(req.body.table).where('id', req.body.id).update(req.body.data).then((0, _utils.addToResponse)(res, 'results')).then((0, _utils.nextAndReturn)(next));
      }
    }
  }, {
    key: "deleteRow",
    value: function deleteRow(req, res, next) {
      if (!_db.default.db) {
        return (0, _utils.catchMiddleware)(next)(new _types.HttpException(500, 'No database'));
      } else {
        return _db.default.db(req.params.table).where('id', req.params.id).del().then((0, _utils.addToResponse)(res, 'results')).then((0, _utils.nextAndReturn)(next));
      }
    }
  }, {
    key: "getRelationQueries",
    value: function getRelationQueries(TABLE_CONFIG, parentId) {
      var _this2 = this;

      var relationQueries = [];

      if (TABLE_CONFIG.relations && TABLE_CONFIG.relations.manyToOne) {
        var MANY_TO_ONE = TABLE_CONFIG.relations.manyToOne;
        var KEYS = Object.keys(MANY_TO_ONE);
        KEYS.forEach(function (tableName) {
          relationQueries.push(_this2.getRelatedRow(tableName, MANY_TO_ONE[tableName], parentId));
        });
      }

      return relationQueries;
    }
  }, {
    key: "getRelatedRow",
    value: function getRelatedRow(tableName, columnName, parentId) {
      if (!_db.default.db) {
        throw new _types.HttpException(500, 'No database');
      }

      var TABLE_NAME = tableName;
      var TABLE_CONFIG = (0, _utils.getTableConfig)(TABLE_NAME);
      var requestedColumns = (0, _utils.filterTableColumns)(TABLE_CONFIG, 'detail');
      return _db.default.db.select(requestedColumns).from(tableName).where(columnName, parentId).then(function (results) {
        return {
          results: results,
          tableName: tableName
        };
      });
    }
  }, {
    key: "mergeRelatedData",
    value: function mergeRelatedData(_ref3) {
      var _ref4 = _toArray(_ref3),
          results = _ref4[0],
          relations = _ref4.slice(1);

      if (relations && relations.length) {
        relations.forEach(function (relation) {
          results[relation.tableName] = relation.results;
        });
      }

      return results;
    }
  }]);

  return TableController;
}();

var _default = TableController;
exports.default = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9hcGkvY29udHJvbGxlcnMvVGFibGVDb250cm9sbGVyLnRzIl0sIm5hbWVzIjpbImRlYnVnIiwiVGFibGVDb250cm9sbGVyIiwicmVxIiwicmVzIiwibmV4dCIsInVzZXJSb2xlcyIsInVzZXIiLCJyb2xlcyIsIlRBQkxFX0NPTkZJRyIsInBhcmFtcyIsInRhYmxlIiwiUkVTVUxUIiwiY29sdW1ucyIsIm5hbWUiLCJwayIsInZlcmJvc2UiLCJIdHRwRXhjZXB0aW9uIiwiUEFHRV9OVU1CRVIiLCJxdWVyeSIsInBhZ2UiLCJMSU1JVCIsIlRBQkxFX05BTUUiLCJDT0xVTU5TIiwiZGF0YWJhc2UiLCJkYiIsIkRCIiwiUVVFUlkiLCJzZWxlY3QiLCJmcm9tIiwiZmlsdGVyIiwiY29sdW1uc0J5S2V5IiwiZm9yRWFjaCIsImNvbHVtbiIsIkZJTFRFUlMiLCJKU09OIiwicGFyc2UiLCJPYmplY3QiLCJrZXlzIiwia2V5IiwiaW5kZXgiLCJ0eXBlIiwid2hlcmUiLCJhbmRXaGVyZSIsIm9mZnNldCIsImxpbWl0IiwidGhlbiIsInJlc3VsdHMiLCJ0b1JlcXVlc3QiLCJSRUxBVElPTlMiLCJyZWxhdGlvbiIsInJvdyIsInZhbHVlcyIsImRpc3BsYXkiLCJwYXJlbnRDb2x1bW4iLCJ1bmRlZmluZWQiLCJyZWxhdGlvblF1ZXJpZXMiLCJ0YWJsZU5hbWUiLCJwdXNoIiwid2hlcmVJbiIsIlByb21pc2UiLCJhbGwiLCJyZWxhdGlvblJlc3VsdHMiLCJtYXAiLCJST1dfS0VZIiwiUk9XX0lOREVYIiwiY29uc29sZSIsImxvZyIsInJlcXVlc3RlZENvbHVtbnMiLCJpZCIsImluY2x1ZGVSZWxhdGlvbnMiLCJnZXRSZWxhdGlvblF1ZXJpZXMiLCJsZW5ndGgiLCJtZXJnZVJlbGF0ZWREYXRhIiwiaW5zZXJ0IiwiYm9keSIsImRhdGEiLCJ1cGRhdGUiLCJkZWwiLCJwYXJlbnRJZCIsInJlbGF0aW9ucyIsIm1hbnlUb09uZSIsIk1BTllfVE9fT05FIiwi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VSxFQUFvQk4sUSxFQUFlO0FBQzFFLFVBQUksQ0FBQ3ZELFlBQVNDLEVBQWQsRUFBa0I7QUFDaEIsY0FBTSxJQUFJUixvQkFBSixDQUFrQixHQUFsQixFQUF1QixhQUF2QixDQUFOO0FBQ0Q7O0FBQ0QsVUFBTUssVUFBVSxHQUFHbUMsU0FBbkI7QUFDQSxVQUFNaEQsWUFBWSxHQUFHLDJCQUFlYSxVQUFmLENBQXJCO0FBRUEsVUFBTThDLGdCQUFnQixHQUFHLCtCQUFtQjNELFlBQW5CLEVBQWlDLFFBQWpDLENBQXpCO0FBQ0EsYUFBT2UsWUFBU0MsRUFBVCxDQUFZRyxNQUFaLENBQW1Cd0MsZ0JBQW5CLEVBQ0p2QyxJQURJLENBQ0M0QixTQURELEVBRUpmLEtBRkksQ0FFRTJDLFVBRkYsRUFFY04sUUFGZCxFQUV3QmpDLElBRnhCLENBR0gsVUFBQ0MsT0FBRDtBQUFBLGVBQWM7QUFDWkEsVUFBQUEsT0FBTyxFQUFQQSxPQURZO0FBRVpVLFVBQUFBLFNBQVMsRUFBVEE7QUFGWSxTQUFkO0FBQUEsT0FIRyxDQUFQO0FBUUQ7Ozs0Q0FFc0Q7QUFBQTtBQUFBLFVBQTdCVixPQUE2QjtBQUFBLFVBQWpCaUMsU0FBaUI7O0FBQ3JELFVBQUlBLFNBQVMsSUFBSUEsU0FBUyxDQUFDUixNQUEzQixFQUFtQztBQUNqQ1EsUUFBQUEsU0FBUyxDQUFDaEQsT0FBVixDQUNFLFVBQUNrQixRQUFELEVBQW1EO0FBQ2pESCxVQUFBQSxPQUFPLENBQUNHLFFBQVEsQ0FBQ08sU0FBVixDQUFQLEdBQThCUCxRQUFRLENBQUNILE9BQXZDO0FBQ0QsU0FISDtBQUtEOztBQUVELGFBQU9BLE9BQVA7QUFDRDs7Ozs7O2VBR1k3QyxlIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IGRhdGFiYXNlIGZyb20gJ0Byb290L2FwaS9kYidcbmltcG9ydCB7IEh0dHBFeGNlcHRpb24sIElNQ1JlcXVlc3QsIElNQ1Jlc3BvbnNlIH0gZnJvbSAnQHJvb3QvYXBpL3R5cGVzJ1xuaW1wb3J0IHtcbiAgYWRkVG9SZXNwb25zZSxcbiAgY2F0Y2hNaWRkbGV3YXJlLFxuICBmaWx0ZXJUYWJsZUNvbHVtbnMsXG4gIGdldFRhYmxlQ29uZmlnLFxuICBoYXNBdXRob3JpemF0aW9uLFxuICBuZXh0QW5kUmV0dXJuLFxuICBydW5Ib29rXG59IGZyb20gJ0Byb290L2FwaS91dGlscydcbmltcG9ydCB7IElDb2x1bW5JbmZvLCBJVGFibGVJbmZvIH0gZnJvbSAnQHJvb3QvY29uZmlnR2VuZXJhdG9yJ1xuaW1wb3J0IEJsdWViaXJkIGZyb20gJ2JsdWViaXJkJ1xuaW1wb3J0IERlYnVnIGZyb20gJ2RlYnVnJ1xuaW1wb3J0IHsgTmV4dEZ1bmN0aW9uLCBSZXF1ZXN0IH0gZnJvbSAnZXhwcmVzcydcbmltcG9ydCBLbmV4IGZyb20gJ0tuZXgnXG5cbmNvbnN0IGRlYnVnID0gRGVidWcoJ2Z1bmZ1bnptYzpjb250cm9sbGVyLXRhYmxlJylcblxuaW50ZXJmYWNlIElUb1JlcXVlc3Qge1xuICBba2V5OiBzdHJpbmddOiB7XG4gICAgdmFsdWVzOiB7XG4gICAgICBba2V5OiBzdHJpbmddOiB0cnVlLFxuICAgIH0sXG4gICAga2V5OiBzdHJpbmcsXG4gICAgZGlzcGxheTogc3RyaW5nLFxuICAgIHBhcmVudENvbHVtbjogc3RyaW5nXG4gIH0sXG59XG5cbmNsYXNzIFRhYmxlQ29udHJvbGxlciB7XG4gIGNvbnN0cnVjdG9yKCkge1xuICAgIGRlYnVnKCdDcmVhdGVkJylcbiAgfVxuXG4gIHB1YmxpYyBnZXRUYWJsZUNvbmZpZyhyZXE6IElNQ1JlcXVlc3QsIHJlczogSU1DUmVzcG9uc2UsIG5leHQ6IE5leHRGdW5jdGlvbikge1xuICAgIGxldCB1c2VyUm9sZXM6IHN0cmluZ1tdID0gW11cbiAgICBpZiAocmVxLnVzZXIgJiYgcmVxLnVzZXIucm9sZXMpIHtcbiAgICAgIHVzZXJSb2xlcyA9IHJlcS51c2VyLnJvbGVzXG4gICAgfVxuXG4gICAgY29uc3QgVEFCTEVfQ09ORklHID0gZ2V0VGFibGVDb25maWcocmVxLnBhcmFtcy50YWJsZSlcbiAgICBjb25zdCBSRVNVTFQgPSB7XG4gICAgICBjb2x1bW5zOiBUQUJMRV9DT05GSUcuY29sdW1ucyxcbiAgICAgIG5hbWU6IFRBQkxFX0NPTkZJRy5uYW1lLFxuICAgICAgcGs6IFRBQkxFX0NPTkZJRy5wayxcbiAgICAgIHZlcmJvc2U6IFRBQkxFX0NPTkZJRy52ZXJib3NlLFxuICAgIH1cblxuICAgIGlmIChoYXNBdXRob3JpemF0aW9uKFRBQkxFX0NPTkZJRy5yb2xlcywgdXNlclJvbGVzKSkge1xuICAgICAgYWRkVG9SZXNwb25zZShyZXMsICdyZXN1bHRzJykoUkVTVUxUKVxuICAgICAgcmV0dXJuIG5leHRBbmRSZXR1cm4obmV4dCkoUkVTVUxUKVxuICAgIH0gZWxzZSB7XG4gICAgICByZXR1cm4gY2F0Y2hNaWRkbGV3YXJlKG5leHQpKG5ldyBIdHRwRXhjZXB0aW9uKDQwMSwgJ05vdCBhdXRob3JpemVkJykpXG4gICAgfVxuICB9XG5cbiAgcHVibGljIGdldFRhYmxlRGF0YShyZXE6IElNQ1JlcXVlc3QsIHJlczogSU1DUmVzcG9uc2UsIG5leHQ6IE5leHRGdW5jdGlvbikge1xuICAgIGNvbnN0IFBBR0VfTlVNQkVSID0gcmVxLnF1ZXJ5LnBhZ2VcbiAgICBjb25zdCBMSU1JVCA9IDEwXG4gICAgY29uc3QgVEFCTEVfTkFNRSA9IHJlcS5wYXJhbXMudGFibGVcblxuICAgIGNvbnN0IFRBQkxFX0NPTkZJRyA9IGdldFRhYmxlQ29uZmlnKFRBQkxFX05BTUUpXG5cbiAgICBjb25zdCBDT0xVTU5TID0gZmlsdGVyVGFibGVDb2x1bW5zKFRBQkxFX0NPTkZJRywgJ21haW4nKVxuXG4gICAgbGV0IHVzZXJSb2xlczogc3RyaW5nW10gPSBbXVxuICAgIGlmIChyZXEudXNlciAmJiByZXEudXNlci5yb2xlcykge1xuICAgICAgdXNlclJvbGVzID0gcmVxLnVzZXIucm9sZXNcbiAgICB9XG5cbiAgICBpZiAoIWhhc0F1dGhvcml6YXRpb24oVEFCTEVfQ09ORklHLnJvbGVzLCB1c2VyUm9sZXMpKSB7XG4gICAgICByZXR1cm4gY2F0Y2hNaWRkbGV3YXJlKG5leHQpKG5ldyBIdHRwRXhjZXB0aW9uKDQwMSwgJ05vdCBhdXRob3JpemVkJykpXG4gICAgfSBlbHNlIHtcbiAgICAgIGlmICghZGF0YWJhc2UuZGIpIHtcbiAgICAgICAgcmV0dXJuIGNhdGNoTWlkZGxld2FyZShuZXh0KShuZXcgSHR0cEV4Y2VwdGlvbig1MDAsICdObyBkYXRhYmFzZScpKVxuICAgICAgfSBlbHNlIHtcbiAgICAgICAgY29uc3QgREIgPSBkYXRhYmFzZS5kYlxuICAgICAgICBjb25zdCBRVUVSWSA9IERCLnNlbGVjdChDT0xVTU5TKS5mcm9tKFRBQkxFX05BTUUpXG4gICAgICAgIGlmIChyZXEucXVlcnkuZmlsdGVyKSB7XG4gICAgICAgICAgY29uc3QgY29sdW1uc0J5S2V5OiB7XG4gICAgICAgICAgICBba2V5OiBzdHJpbmddOiBJQ29sdW1uSW5mb1xuICAgICAgICAgIH0gPSB7fVxuXG4gICAgICAgICAgVEFCTEVfQ09ORklHLmNvbHVtbnMuZm9yRWFjaChcbiAgICAgICAgICAgIChjb2x1bW4pID0+IHtcbiAgICAgICAgICAgICAgY29sdW1uc0J5S2V5W2NvbHVtbi5uYW1lXSA9IGNvbHVtblxuICAgICAgICAgICAgfVxuICAgICAgICAgIClcblxuICAgICAgICAgIGNvbnN0IEZJTFRFUlMgPSBKU09OLnBhcnNlKHJlcS5xdWVyeS5maWx0ZXIpXG4gICAgICAgICAgT2JqZWN0LmtleXMoRklMVEVSUykuZm9yRWFjaChcbiAgICAgICAgICAgIChrZXksIGluZGV4KSA9PiB7XG4gICAgICAgICAgICAgIGlmIChjb2x1bW5zQnlLZXlba2V5XS50eXBlID09PSAnaW50KDExKScpIHtcbiAgICAgICAgICAgICAgICBpbmRleCA9PT0gMCA/XG4gICAgICAgICAgICAgICAgICBRVUVSWS53aGVyZSh7XG4gICAgICAgICAgICAgICAgICAgIFtrZXldOiBGSUxURVJTW2tleV0sXG4gICAgICAgICAgICAgICAgICB9KSA6XG4gICAgICAgICAgICAgICAgICBRVUVSWS5hbmRXaGVyZSh7XG4gICAgICAgICAgICAgICAgICAgIFtrZXldOiBGSUxURVJTW2tleV0sXG4gICAgICAgICAgICAgICAgICB9KVxuICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIGluZGV4ID09PSAwID9cbiAgICAgICAgICAgICAgICAgIFFVRVJZLndoZXJlKGtleSwgJ2xpa2UnLCAnJScgKyBGSUxURVJTW2tleV0gKyAnJScpIDpcbiAgICAgICAgICAgICAgICAgIFFVRVJZLmFuZFdoZXJlKGtleSwgJ2xpa2UnLCAnJScgKyBGSUxURVJTW2tleV0gKyAnJScpXG4gICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgICApXG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIFFVRVJZXG4gICAgICAgICAgLm9mZnNldCgoUEFHRV9OVU1CRVIgfHwgMCkgKiBMSU1JVClcbiAgICAgICAgICAubGltaXQoTElNSVQpXG4gICAgICAgICAgLnRoZW4oXG4gICAgICAgICAgKHJlc3VsdHMpID0+IHtcbiAgICAgICAgICAgIGNvbnN0IHRvUmVxdWVzdDogSVRvUmVxdWVzdCA9IHt9XG4gICAgICAgICAgICBjb25zdCBSRUxBVElPTlMgPSBUQUJMRV9DT05GSUcuY29sdW1ucy5maWx0ZXIoXG4gICAgICAgICAgICAgIChjb2x1bW4pID0+IGNvbHVtbi5yZWxhdGlvblxuICAgICAgICAgICAgKVxuICAgICAgICAgICAgcmVzdWx0cy5mb3JFYWNoKFxuICAgICAgICAgICAgICAocm93OiBhbnksIGluZGV4OiBudW1iZXIpID0+IHtcbiAgICAgICAgICAgICAgICBSRUxBVElPTlMuZm9yRWFjaChcbiAgICAgICAgICAgICAgICAgIChjb2x1bW4pID0+IHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKGNvbHVtbi5yZWxhdGlvbikge1xuICAgICAgICAgICAgICAgICAgICAgIGlmICghdG9SZXF1ZXN0W2NvbHVtbi5yZWxhdGlvbi50YWJsZV0pIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHRvUmVxdWVzdFtjb2x1bW4ucmVsYXRpb24udGFibGVdID0ge1xuICAgICAgICAgICAgICAgICAgICAgICAgICB2YWx1ZXM6IHt9LFxuICAgICAgICAgICAgICAgICAgICAgICAgICBrZXk6IGNvbHVtbi5yZWxhdGlvbi5rZXksXG4gICAgICAgICAgICAgICAgICAgICAgICAgIGRpc3BsYXk6IGNvbHVtbi5yZWxhdGlvbi5kaXNwbGF5LFxuICAgICAgICAgICAgICAgICAgICAgICAgICBwYXJlbnRDb2x1bW46IGNvbHVtbi5uYW1lLFxuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgICAgICAgIFxuXG4gICAgICAgICAgICAgICAgICAgICAgaWYgKHRvUmVxdWVzdFtjb2x1bW4ucmVsYXRpb24udGFibGVdLnZhbHVlc1tyb3dbY29sdW1uLm5hbWVdXSA9PT0gdW5kZWZpbmVkKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICB0b1JlcXVlc3RbY29sdW1uLnJlbGF0aW9uLnRhYmxlXS52YWx1ZXMgPSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgIC4uLnRvUmVxdWVzdFtjb2x1bW4ucmVsYXRpb24udGFibGVdLnZhbHVlcyxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgW3Jvd1tjb2x1bW4ubmFtZV1dOiBpbmRleCxcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICApXG4gICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIClcblxuICAgICAgICAgICAgY29uc3QgcmVsYXRpb25RdWVyaWVzOiBLbmV4LlF1ZXJ5QnVpbGRlcltdID0gW11cbiAgICAgICAgICAgIE9iamVjdC5rZXlzKHRvUmVxdWVzdCkuZm9yRWFjaChcbiAgICAgICAgICAgICAgKHRhYmxlTmFtZSkgPT4ge1xuICAgICAgICAgICAgICAgIHJlbGF0aW9uUXVlcmllcy5wdXNoKFxuICAgICAgICAgICAgICAgICAgREIuc2VsZWN0KHRvUmVxdWVzdFt0YWJsZU5hbWVdLmRpc3BsYXkpXG4gICAgICAgICAgICAgICAgICAgIC5mcm9tKHRhYmxlTmFtZSlcbiAgICAgICAgICAgICAgICAgICAgLndoZXJlSW4odG9SZXF1ZXN0W3RhYmxlTmFtZV0ua2V5LCBPYmplY3Qua2V5cyh0b1JlcXVlc3RbdGFibGVOYW1lXS52YWx1ZXMpKVxuICAgICAgICAgICAgICAgIClcbiAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgKVxuXG4gICAgICAgICAgICByZXR1cm4gUHJvbWlzZS5hbGwoW3Jlc3VsdHMsIHRvUmVxdWVzdCwgLi4ucmVsYXRpb25RdWVyaWVzXSlcbiAgICAgICAgICB9XG4gICAgICAgICkudGhlbihcbiAgICAgICAgICAoW3Jlc3VsdHMsIHRvUmVxdWVzdCwgLi4ucmVsYXRpb25SZXN1bHRzXSkgPT4ge1xuICAgICAgICAgICAgcmV0dXJuIHJlc3VsdHMubWFwKFxuICAgICAgICAgICAgICAocm93OiBhbnkpID0+IHtcbiAgICAgICAgICAgICAgICBPYmplY3Qua2V5cyh0b1JlcXVlc3QpLmZvckVhY2goXG4gICAgICAgICAgICAgICAgICAodGFibGVOYW1lLCBpbmRleCkgPT4ge1xuICAgICAgICAgICAgICAgICAgICBjb25zdCBST1dfS0VZID0gdG9SZXF1ZXN0W3RhYmxlTmFtZV0ucGFyZW50Q29sdW1uXG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IFJPV19JTkRFWCA9IHRvUmVxdWVzdFt0YWJsZU5hbWVdLnZhbHVlc1tyb3dbUk9XX0tFWV1dXG4gICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKHRvUmVxdWVzdClcbiAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coUk9XX0tFWSwgUk9XX0lOREVYLCByZWxhdGlvblJlc3VsdHNbaW5kZXhdKVxuICAgICAgICAgICAgICAgICAgICByb3dbUk9XX0tFWV0gPSByZWxhdGlvblJlc3VsdHNbaW5kZXhdW1JPV19JTkRFWF1bdG9SZXF1ZXN0W3RhYmxlTmFtZV0uZGlzcGxheV1cbiAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICApXG4gICAgICAgICAgICAgICAgcmV0dXJuIHJvd1xuICAgICAgICAgICAgICB9XG4gICAgICAgICAgICApXG4gICAgICAgICAgfVxuICAgICAgICApLnRoZW4oXG4gICAgICAgICAgKHJlc3VsdHMpID0+IHtcbiAgICAgICAgICAgIHJldHVybiBydW5Ib29rKFRBQkxFX0NPTkZJRywgJ2dldFRhYmxlRGF0YScsICdhZnRlcicsIHJlcSwgcmVzLCBkYXRhYmFzZS5kYiwgcmVzdWx0cylcbiAgICAgICAgICB9XG4gICAgICAgICkudGhlbihcbiAgICAgICAgICBhZGRUb1Jlc3BvbnNlKHJlcywgJ3Jlc3VsdHMnKVxuICAgICAgICApLnRoZW4oXG4gICAgICAgICAgbmV4dEFuZFJldHVybihuZXh0KVxuICAgICAgICApXG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgcHVibGljIGdldFRhYmxlQ291bnQocmVxOiBJTUNSZXF1ZXN0LCByZXM6IElNQ1Jlc3BvbnNlLCBuZXh0OiBOZXh0RnVuY3Rpb24pIHtcbiAgICBjb25zdCBUQUJMRV9OQU1FID0gcmVxLnBhcmFtcy50YWJsZVxuICAgIGNvbnN0IFRBQkxFX0NPTkZJRyA9IGdldFRhYmxlQ29uZmlnKFRBQkxFX05BTUUpXG5cbiAgICBsZXQgdXNlclJvbGVzOiBzdHJpbmdbXSA9IFtdXG4gICAgaWYgKHJlcS51c2VyICYmIHJlcS51c2VyLnJvbGVzKSB7XG4gICAgICB1c2VyUm9sZXMgPSByZXEudXNlci5yb2xlc1xuICAgIH1cblxuICAgIGlmICghaGFzQXV0aG9yaXphdGlvbihUQUJMRV9DT05GSUcucm9sZXMsIHVzZXJSb2xlcykpIHtcbiAgICAgIHJldHVybiBjYXRjaE1pZGRsZXdhcmUobmV4dCkobmV3IEh0dHBFeGNlcHRpb24oNDAxLCAnTm90IGF1dGhvcml6ZWQnKSlcbiAgICB9IGVsc2Uge1xuICAgICAgaWYgKCFkYXRhYmFzZS5kYikge1xuICAgICAgICByZXR1cm4gY2F0Y2hNaWRkbGV3YXJlKG5leHQpKG5ldyBIdHRwRXhjZXB0aW9uKDUwMCwgJ05vIGRhdGFiYXNlJykpXG4gICAgICB9IGVsc2Uge1xuICAgICAgICByZXR1cm4gZGF0YWJhc2UuZGIuc2VsZWN0KCcqJykuZnJvbShUQUJMRV9OQU1FKS50aGVuKFxuICAgICAgICAgIChyZXN1bHRzKSA9PiB7XG4gICAgICAgICAgICBydW5Ib29rKFRBQkxFX0NPTkZJRywgJ2dldFRhYmxlQ291bnQnLCAnYWZ0ZXInLCByZXEsIHJlcywgZGF0YWJhc2UuZGIsIHJlc3VsdHMpLnRoZW4oXG4gICAgICAgICAgICAgIGFkZFRvUmVzcG9uc2UocmVzLCAnY291bnQnKVxuICAgICAgICAgICAgKS50aGVuKFxuICAgICAgICAgICAgICBuZXh0QW5kUmV0dXJuKG5leHQpXG4gICAgICAgICAgICApXG4gICAgICAgICAgfVxuICAgICAgICApXG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgcHVibGljIGdldFJvdyhyZXE6IElNQ1JlcXVlc3QsIHJlczogSU1DUmVzcG9uc2UsIG5leHQ6IE5leHRGdW5jdGlvbikge1xuICAgIGNvbnN0IFRBQkxFX05BTUUgPSByZXEucGFyYW1zLnRhYmxlXG4gICAgY29uc3QgVEFCTEVfQ09ORklHID0gZ2V0VGFibGVDb25maWcoVEFCTEVfTkFNRSlcblxuICAgIGxldCB1c2VyUm9sZXM6IHN0cmluZ1tdID0gW11cbiAgICBpZiAocmVxLnVzZXIgJiYgcmVxLnVzZXIucm9sZXMpIHtcbiAgICAgIHVzZXJSb2xlcyA9IHJlcS51c2VyLnJvbGVzXG4gICAgfVxuXG4gICAgaWYgKCFoYXNBdXRob3JpemF0aW9uKFRBQkxFX0NPTkZJRy5yb2xlcywgdXNlclJvbGVzKSkge1xuICAgICAgcmV0dXJuIGNhdGNoTWlkZGxld2FyZShuZXh0KShuZXcgSHR0cEV4Y2VwdGlvbig0MDEsICdOb3QgYXV0aG9yaXplZCcpKVxuICAgIH0gZWxzZSB7XG4gICAgICBpZiAoIWRhdGFiYXNlLmRiKSB7XG4gICAgICAgIHJldHVybiBjYXRjaE1pZGRsZXdhcmUobmV4dCkobmV3IEh0dHBFeGNlcHRpb24oNTAwLCAnTm8gZGF0YWJhc2UnKSlcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGNvbnN0IHJlcXVlc3RlZENvbHVtbnMgPSBmaWx0ZXJUYWJsZUNvbHVtbnMoVEFCTEVfQ09ORklHLCAnZGV0YWlsJylcblxuICAgICAgICBjb25zdCBxdWVyeSA9IGRhdGFiYXNlLmRiLnNlbGVjdChyZXF1ZXN0ZWRDb2x1bW5zKVxuICAgICAgICAgIC5mcm9tKGAke3JlcS5wYXJhbXMudGFibGV9YClcbiAgICAgICAgICAud2hlcmUoYGlkYCwgcmVxLnBhcmFtcy5pZClcblxuICAgICAgICByZXR1cm4gcXVlcnkudGhlbihcbiAgICAgICAgICAocmVzdWx0cykgPT4ge1xuICAgICAgICAgICAgbGV0IHJlbGF0aW9uUXVlcmllczogQXJyYXk8Qmx1ZWJpcmQ8e30+PiA9IFtdXG4gICAgICAgICAgICBpZiAocmVxLnF1ZXJ5LmluY2x1ZGVSZWxhdGlvbnMpIHtcbiAgICAgICAgICAgICAgcmVsYXRpb25RdWVyaWVzID0gdGhpcy5nZXRSZWxhdGlvblF1ZXJpZXMoVEFCTEVfQ09ORklHLCByZXN1bHRzWzBdLmlkKVxuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBpZiAocmVsYXRpb25RdWVyaWVzLmxlbmd0aCkge1xuICAgICAgICAgICAgICByZXR1cm4gUHJvbWlzZS5hbGwoW1xuICAgICAgICAgICAgICAgIHJlc3VsdHNbMF0sXG4gICAgICAgICAgICAgICAgLi4ucmVsYXRpb25RdWVyaWVzLFxuICAgICAgICAgICAgICBdKVxuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICByZXR1cm4gUHJvbWlzZS5hbGwoW1xuICAgICAgICAgICAgICByZXN1bHRzWzBdLFxuICAgICAgICAgICAgXSlcbiAgICAgICAgICB9XG4gICAgICAgICkudGhlbihcbiAgICAgICAgICB0aGlzLm1lcmdlUmVsYXRlZERhdGFcbiAgICAgICAgKS50aGVuKFxuICAgICAgICAgIGFkZFRvUmVzcG9uc2UocmVzLCAncmVzdWx0JylcbiAgICAgICAgKS50aGVuKFxuICAgICAgICAgIG5leHRBbmRSZXR1cm4obmV4dClcbiAgICAgICAgKVxuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIHB1YmxpYyBpbnNlcnRSb3cocmVxOiBSZXF1ZXN0LCByZXM6IElNQ1Jlc3BvbnNlLCBuZXh0OiBOZXh0RnVuY3Rpb24pIHtcbiAgICBpZiAoIWRhdGFiYXNlLmRiKSB7XG4gICAgICByZXR1cm4gY2F0Y2hNaWRkbGV3YXJlKG5leHQpKG5ldyBIdHRwRXhjZXB0aW9uKDUwMCwgJ05vIGRhdGFiYXNlJykpXG4gICAgfSBlbHNlIHtcbiAgICAgIHJldHVybiBkYXRhYmFzZS5kYihyZXEucGFyYW1zLnRhYmxlKS5pbnNlcnQocmVxLmJvZHkuZGF0YSkudGhlbihcbiAgICAgICAgYWRkVG9SZXNwb25zZShyZXMsICdyZXN1bHRzJylcbiAgICAgICkudGhlbihcbiAgICAgICAgbmV4dEFuZFJldHVybihuZXh0KVxuICAgICAgKVxuICAgIH1cbiAgfVxuXG4gIHB1YmxpYyB1cGRhdGVSb3cocmVxOiBSZXF1ZXN0LCByZXM6IElNQ1Jlc3BvbnNlLCBuZXh0OiBOZXh0RnVuY3Rpb24pIHtcbiAgICBpZiAoIWRhdGFiYXNlLmRiKSB7XG4gICAgICByZXR1cm4gY2F0Y2hNaWRkbGV3YXJlKG5leHQpKG5ldyBIdHRwRXhjZXB0aW9uKDUwMCwgJ05vIGRhdGFiYXNlJykpXG4gICAgfSBlbHNlIHtcbiAgICAgIHJldHVybiBkYXRhYmFzZS5kYihyZXEuYm9keS50YWJsZSkud2hlcmUoJ2lkJywgcmVxLmJvZHkuaWQpLnVwZGF0ZShyZXEuYm9keS5kYXRhKS50aGVuKFxuICAgICAgICBhZGRUb1Jlc3BvbnNlKHJlcywgJ3Jlc3VsdHMnKVxuICAgICAgKS50aGVuKFxuICAgICAgICBuZXh0QW5kUmV0dXJuKG5leHQpXG4gICAgICApXG4gICAgfVxuICB9XG5cbiAgcHVibGljIGRlbGV0ZVJvdyhyZXE6IFJlcXVlc3QsIHJlczogSU1DUmVzcG9uc2UsIG5leHQ6IE5leHRGdW5jdGlvbikge1xuICAgIGlmICghZGF0YWJhc2UuZGIpIHtcbiAgICAgIHJldHVybiBjYXRjaE1pZGRsZXdhcmUobmV4dCkobmV3IEh0dHBFeGNlcHRpb24oNTAwLCAnTm8gZGF0YWJhc2UnKSlcbiAgICB9IGVsc2Uge1xuICAgICAgcmV0dXJuIGRhdGFiYXNlLmRiKHJlcS5wYXJhbXMudGFibGUpLndoZXJlKCdpZCcsIHJlcS5wYXJhbXMuaWQpLmRlbCgpLnRoZW4oXG4gICAgICAgIGFkZFRvUmVzcG9uc2UocmVzLCAncmVzdWx0cycpXG4gICAgICApLnRoZW4oXG4gICAgICAgIG5leHRBbmRSZXR1cm4obmV4dClcbiAgICAgIClcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIGdldFJlbGF0aW9uUXVlcmllcyhUQUJMRV9DT05GSUc6IElUYWJsZUluZm8sIHBhcmVudElkOiBhbnkpIHtcbiAgICBjb25zdCByZWxhdGlvblF1ZXJpZXM6IEFycmF5PEJsdWViaXJkPHt9Pj4gPSBbXVxuICAgIGlmIChUQUJMRV9DT05GSUcucmVsYXRpb25zICYmIFRBQkxFX0NPTkZJRy5yZWxhdGlvbnMubWFueVRvT25lKSB7XG4gICAgICBjb25zdCBNQU5ZX1RPX09ORSA9IFRBQkxFX0NPTkZJRy5yZWxhdGlvbnMubWFueVRvT25lXG4gICAgICBjb25zdCBLRVlTOiBzdHJpbmdbXSA9IE9iamVjdC5rZXlzKE1BTllfVE9fT05FKVxuICAgICAgS0VZUy5mb3JFYWNoKFxuICAgICAgICAodGFibGVOYW1lKSA9PiB7XG4gICAgICAgICAgcmVsYXRpb25RdWVyaWVzLnB1c2goXG4gICAgICAgICAgICB0aGlzLmdldFJlbGF0ZWRSb3coXG4gICAgICAgICAgICAgIHRhYmxlTmFtZSxcbiAgICAgICAgICAgICAgTUFOWV9UT19PTkVbdGFibGVOYW1lXSxcbiAgICAgICAgICAgICAgcGFyZW50SWRcbiAgICAgICAgICAgIClcbiAgICAgICAgICApXG4gICAgICAgIH1cbiAgICAgIClcbiAgICB9XG5cbiAgICByZXR1cm4gcmVsYXRpb25RdWVyaWVzXG4gIH1cblxuICBwcml2YXRlIGdldFJlbGF0ZWRSb3codGFibGVOYW1lOiBzdHJpbmcsIGNvbHVtbk5hbWU6IHN0cmluZywgcGFyZW50SWQ6IGFueSkge1xuICAgIGlmICghZGF0YWJhc2UuZGIpIHtcbiAgICAgIHRocm93IG5ldyBIdHRwRXhjZXB0aW9uKDUwMCwgJ05vIGRhdGFiYXNlJylcbiAgICB9XG4gICAgY29uc3QgVEFCTEVfTkFNRSA9IHRhYmxlTmFtZVxuICAgIGNvbnN0IFRBQkxFX0NPTkZJRyA9IGdldFRhYmxlQ29uZmlnKFRBQkxFX05BTUUpXG5cbiAgICBjb25zdCByZXF1ZXN0ZWRDb2x1bW5zID0gZmlsdGVyVGFibGVDb2x1bW5zKFRBQkxFX0NPTkZJRywgJ2RldGFpbCcpXG4gICAgcmV0dXJuIGRhdGFiYXNlLmRiLnNlbGVjdChyZXF1ZXN0ZWRDb2x1bW5zKVxuICAgICAgLmZyb20odGFibGVOYW1lKVxuICAgICAgLndoZXJlKGNvbHVtbk5hbWUsIHBhcmVudElkKS50aGVuKFxuICAgICAgICAocmVzdWx0cykgPT4gKHtcbiAgICAgICAgICByZXN1bHRzLFxuICAgICAgICAgIHRhYmxlTmFtZSxcbiAgICAgICAgfSlcbiAgICAgIClcbiAgfVxuXG4gIHByaXZhdGUgbWVyZ2VSZWxhdGVkRGF0YShbcmVzdWx0cywgLi4ucmVsYXRpb25zXTogYW55KSB7XG4gICAgaWYgKHJlbGF0aW9ucyAmJiByZWxhdGlvbnMubGVuZ3RoKSB7XG4gICAgICByZWxhdGlvbnMuZm9yRWFjaChcbiAgICAgICAgKHJlbGF0aW9uOiB7dGFibGVOYW1lOiBzdHJpbmcsIHJlc3VsdHM6IGFueVtdfSkgPT4ge1xuICAgICAgICAgIHJlc3VsdHNbcmVsYXRpb24udGFibGVOYW1lXSA9IHJlbGF0aW9uLnJlc3VsdHNcbiAgICAgICAgfVxuICAgICAgKVxuICAgIH1cblxuICAgIHJldHVybiByZXN1bHRzXG4gIH1cbn1cblxuZXhwb3J0IGRlZmF1bHQgVGFibGVDb250cm9sbGVyXG4iXX0=