"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _db = _interopRequireDefault(require("../db"));

var _types = require("../types");

var _utils = require("../utils");

var _debug = _interopRequireDefault(require("debug"));

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

function _toArray(arr) { return _arrayWithHoles(arr) || _iterableToArray(arr) || _nonIterableRest(); }

function _toConsumableArray(arr) { return _arrayWithoutHoles(arr) || _iterableToArray(arr) || _nonIterableSpread(); }

function _nonIterableSpread() { throw new TypeError("Invalid attempt to spread non-iterable instance"); }

function _iterableToArray(iter) { if (Symbol.iterator in Object(iter) || Object.prototype.toString.call(iter) === "[object Arguments]") return Array.from(iter); }

function _arrayWithoutHoles(arr) { if (Array.isArray(arr)) { for (var i = 0, arr2 = new Array(arr.length); i < arr.length; i++) { arr2[i] = arr[i]; } return arr2; } }

function _slicedToArray(arr, i) { return _arrayWithHoles(arr) || _iterableToArrayLimit(arr, i) || _nonIterableRest(); }

function _nonIterableRest() { throw new TypeError("Invalid attempt to destructure non-iterable instance"); }

function _iterableToArrayLimit(arr, i) { var _arr = []; var _n = true; var _d = false; var _e = undefined; try { for (var _i = arr[Symbol.iterator](), _s; !(_n = (_s = _i.next()).done); _n = true) { _arr.push(_s.value); if (i && _arr.length === i) break; } } catch (err) { _d = true; _e = err; } finally { try { if (!_n && _i["return"] != null) _i["return"](); } finally { if (_d) throw _e; } } return _arr; }

function _arrayWithHoles(arr) { if (Array.isArray(arr)) return arr; }

function _classCallCheck(instance, Constructor) { if (!(instance instanceof Constructor)) { throw new TypeError("Cannot call a class as a function"); } }

function _defineProperties(target, props) { for (var i = 0; i < props.length; i++) { var descriptor = props[i]; descriptor.enumerable = descriptor.enumerable || false; descriptor.configurable = true; if ("value" in descriptor) descriptor.writable = true; Object.defineProperty(target, descriptor.key, descriptor); } }

function _createClass(Constructor, protoProps, staticProps) { if (protoProps) _defineProperties(Constructor.prototype, protoProps); if (staticProps) _defineProperties(Constructor, staticProps); return Constructor; }

var debug = (0, _debug.default)('funfunzmc:controller-table');

function toRequestBuilder(relation, columnName) {
  return {
    values: new Set(),
    key: relation.key,
    display: relation.display,
    foreignKeyColumn: columnName
  };
}

var TableController =
/*#__PURE__*/
function () {
  function TableController() {
    _classCallCheck(this, TableController);

    debug('Created');
  }

  _createClass(TableController, [{
    key: "getTableConfig",
    value: function getTableConfig(req, res, next) {
      var TABLE_CONFIG = (0, _utils.getTableConfig)(req.params.table);
      var RESULT = {
        columns: TABLE_CONFIG.columns,
        name: TABLE_CONFIG.name,
        pk: TABLE_CONFIG.pk,
        verbose: TABLE_CONFIG.verbose,
        chips: TABLE_CONFIG.chips || []
      };

      if (!(0, _utils.hasAuthorization)(TABLE_CONFIG.roles, req.user)) {
        return (0, _utils.catchMiddleware)(next)(new _types.HttpException(401, 'Not authorized'));
      }

      (0, _utils.addToResponse)(res, 'results')(RESULT);
      return (0, _utils.nextAndReturn)(next)(RESULT);
    }
  }, {
    key: "getTableData",
    value: function getTableData(req, res, next) {
      var _this = this;

      var PAGE_NUMBER = req.query.page || 0;
      var TABLE_NAME = req.params.table;
      var ORDER = req.query.order || null;
      var TABLE_CONFIG = (0, _utils.getTableConfig)(TABLE_NAME);
      var COLUMNS = (0, _utils.filterVisibleTableColumns)(TABLE_CONFIG, 'main');
      var LIMIT = 10;

      if (!(0, _utils.hasAuthorization)(TABLE_CONFIG.roles, req.user)) {
        return (0, _utils.catchMiddleware)(next)(new _types.HttpException(401, 'Not authorized'));
      }

      if (!_db.default.db) {
        return (0, _utils.catchMiddleware)(next)(new _types.HttpException(500, 'No database'));
      }

      var DB = _db.default.db;
      var QUERY = DB.select(COLUMNS).from(TABLE_NAME);

      if (req.query.filter) {
        QUERY = (0, _utils.applyQueryFilters)(QUERY, req.query.filter, TABLE_CONFIG);
      }

      if (req.query.search) {
        QUERY = (0, _utils.applyQuerySearch)(QUERY, req.query.search, TABLE_CONFIG);
      }

      if (ORDER) {
        var ORDER_OBJ = JSON.parse(ORDER);

        if (Array.isArray(ORDER_OBJ)) {
          QUERY.orderBy(ORDER_OBJ);
        } else {
          QUERY.orderBy(ORDER_OBJ.column, ORDER_OBJ.order);
        }
      }

      if (req.query.limit) {
        LIMIT = parseInt(req.query.limit, 10);
      }

      if (LIMIT > 0) {
        QUERY.offset(PAGE_NUMBER * LIMIT).limit(LIMIT);
      }

      return (0, _utils.runHook)(TABLE_CONFIG, 'getTableData', 'before', req, res, _db.default.db).then(function (hookResult) {
        if (hookResult) {
          if (hookResult.filter) {
            Object.keys(hookResult.filter).forEach(function (column) {
              if (Array.isArray(hookResult.filter[column])) {
                QUERY.whereIn(column, hookResult.filter[column]);
              }
            });
          }
        }

        return QUERY;
      }).then(function (results) {
        if (req.query.friendlyData) {
          return _this.addVerboseRelatedData(results, TABLE_CONFIG, DB);
        }

        return results;
      }).then(function (results) {
        return (0, _utils.runHook)(TABLE_CONFIG, 'getTableData', 'after', req, res, _db.default.db, results);
      }).then((0, _utils.addToResponse)(res, 'results')).then((0, _utils.nextAndReturn)(next));
    }
  }, {
    key: "getTableCount",
    value: function getTableCount(req, res, next) {
      var TABLE_NAME = req.params.table;
      var TABLE_CONFIG = (0, _utils.getTableConfig)(TABLE_NAME);
      return this.requirementsCheck(TABLE_CONFIG, req.user, _db.default, next).then(function (DB) {
        var QUERY = DB(TABLE_NAME).select('*');

        if (req.query.search) {
          QUERY = (0, _utils.applyQuerySearch)(QUERY, req.query.search, TABLE_CONFIG);
        }

        return Promise.all([DB, QUERY]);
      }).then(function (_ref) {
        var _ref2 = _slicedToArray(_ref, 2),
            DB = _ref2[0],
            results = _ref2[1];

        return (0, _utils.runHook)(TABLE_CONFIG, 'getTableCount', 'after', req, res, DB, results);
      }).then((0, _utils.addToResponse)(res, 'count')).then((0, _utils.nextAndReturn)(next)).catch((0, _utils.catchMiddleware)(next));
    }
  }, {
    key: "getRow",
    value: function getRow(req, res, next) {
      var _this2 = this;

      var TABLE_NAME = req.params.table;
      var TABLE_CONFIG = (0, _utils.getTableConfig)(TABLE_NAME);
      return this.requirementsCheck(TABLE_CONFIG, req.user, _db.default, next).then(function (DB) {
        var requestedColumns = (0, _utils.filterVisibleTableColumns)(TABLE_CONFIG, 'detail');
        return DB.select(requestedColumns).from("".concat(req.params.table)).where('id', req.params.id);
      }).then(function (results) {
        var relationQueries = [];

        if (req.query.includeRelations) {
          relationQueries = _this2.getRelationQueries(TABLE_CONFIG, results[0].id);
        }

        if (relationQueries.length) {
          return Promise.all([results[0]].concat(_toConsumableArray(relationQueries)));
        }

        return Promise.all([results[0]]);
      }).then(this.mergeRelatedData).then((0, _utils.addToResponse)(res, 'results')).then((0, _utils.nextAndReturn)(next)).catch((0, _utils.catchMiddleware)(next));
    }
  }, {
    key: "insertRow",
    value: function insertRow(req, res, next) {
      var TABLE_NAME = req.params.table;
      var TABLE_CONFIG = (0, _utils.getTableConfig)(TABLE_NAME);
      return this.requirementsCheck(TABLE_CONFIG, req.user, _db.default, next).then(function (DB) {
        TABLE_CONFIG.columns.forEach(function (column) {
          if (column.type === 'datetime') {
            req.body.data[column.name] = new Date(req.body.data[column.name] || null);
          } else if (column.type === 'tinyint(1)') {
            req.body.data[column.name] = column.type ? 1 : 0;
          }
        });
        return DB(req.params.table).insert(req.body.data);
      }).then(function (results) {
        (0, _utils.addToResponse)(res, 'results')(results);
      }).then((0, _utils.nextAndReturn)(next)).catch((0, _utils.catchMiddleware)(next));
    }
  }, {
    key: "updateRow",
    value: function updateRow(req, res, next) {
      var TABLE_NAME = req.params.table;
      var TABLE_CONFIG = (0, _utils.getTableConfig)(TABLE_NAME);
      return this.requirementsCheck(TABLE_CONFIG, req.user, _db.default, next).then(function (DB) {
        TABLE_CONFIG.columns.forEach(function (column) {
          if (column.type === 'datetime') {
            req.body.data[column.name] = new Date(req.body.data[column.name] || null);
          }
        });
        return DB(TABLE_NAME).where('id', req.params.id).update(req.body.data);
      }).then((0, _utils.addToResponse)(res, 'results')).then((0, _utils.nextAndReturn)(next)).catch((0, _utils.catchMiddleware)(next));
    }
  }, {
    key: "deleteRow",
    value: function deleteRow(req, res, next) {
      var TABLE_NAME = req.params.table;
      var TABLE_CONFIG = (0, _utils.getTableConfig)(TABLE_NAME);
      return this.requirementsCheck(TABLE_CONFIG, req.user, _db.default, next).then(function (DB) {
        return DB(TABLE_NAME).where('id', req.params.id).del();
      }).then((0, _utils.addToResponse)(res, 'results')).then((0, _utils.nextAndReturn)(next)).catch((0, _utils.catchMiddleware)(next));
    }
  }, {
    key: "addVerboseRelatedData",
    value: function addVerboseRelatedData(results, TABLE_CONFIG, DB) {
      var toRequest = {};
      var COLUMNS_WITH_RELATIONS = (0, _utils.getColumnsWithRelations)(TABLE_CONFIG);
      results.forEach(function (row, index) {
        COLUMNS_WITH_RELATIONS.forEach(function (column) {
          if (!column.relation) {
            throw new _types.HttpException(500, 'Column should have a relation');
          }

          var RELATION_TABLE_NAME = column.relation.table;

          if (!toRequest[RELATION_TABLE_NAME]) {
            toRequest[RELATION_TABLE_NAME] = toRequestBuilder(column.relation, column.name);
          }

          toRequest[RELATION_TABLE_NAME].values.add(row[column.name]);
        });
      });
      var relationQueries = [];
      Object.keys(toRequest).forEach(function (tableName) {
        relationQueries.push(DB.select(toRequest[tableName].display, toRequest[tableName].key).from(tableName).whereIn(toRequest[tableName].key, Array.from(toRequest[tableName].values.values())));
      });
      return Promise.all(relationQueries).then(function (relationResults) {
        var MATCHER = {};
        Object.values(toRequest).forEach(function (requestedTable, index) {
          var FOREIGN_KEY_COLUMN = requestedTable.foreignKeyColumn;
          MATCHER[FOREIGN_KEY_COLUMN] = {};
          relationResults[index].forEach(function (relationRow) {
            var CURRENT_VALUE = relationRow[requestedTable.key];
            var VALUE_TO_DISPLAY = relationRow[requestedTable.display];
            MATCHER[FOREIGN_KEY_COLUMN][CURRENT_VALUE] = VALUE_TO_DISPLAY;
          });
        });
        return results.map(function (row) {
          Object.values(toRequest).forEach(function (requestedTable) {
            var ROW_KEY = requestedTable.foreignKeyColumn;
            row[ROW_KEY] = MATCHER[ROW_KEY][row[ROW_KEY]];
          });
          return row;
        });
      });
    }
  }, {
    key: "requirementsCheck",
    value: function requirementsCheck(tableConfig, user, dbInstance, next) {
      if (!(0, _utils.hasAuthorization)(tableConfig.roles, user)) {
        return Promise.reject(new _types.HttpException(401, 'Not authorized'));
      }

      if (!dbInstance.db) {
        return (0, _utils.catchMiddleware)(next)(new _types.HttpException(500, 'No database'));
      }

      return Promise.resolve(dbInstance.db);
    }
  }, {
    key: "getRelationQueries",
    value: function getRelationQueries(TABLE_CONFIG, parentId) {
      var _this3 = this;

      var relationQueries = [];

      if (TABLE_CONFIG.relations && TABLE_CONFIG.relations.manyToOne) {
        var MANY_TO_ONE = TABLE_CONFIG.relations.manyToOne;
        var KEYS = Object.keys(MANY_TO_ONE);
        KEYS.forEach(function (tableName) {
          relationQueries.push(_this3.getRelatedRow(tableName, MANY_TO_ONE[tableName], parentId));
        });
      }

      return relationQueries;
    }
  }, {
    key: "getRelatedRow",
    value: function getRelatedRow(tableName, columnName, parentId) {
      if (!_db.default.db) {
        throw new _types.HttpException(500, 'No database');
      }

      var TABLE_NAME = tableName;
      var TABLE_CONFIG = (0, _utils.getTableConfig)(TABLE_NAME);
      var requestedColumns = (0, _utils.filterVisibleTableColumns)(TABLE_CONFIG, 'detail');
      return _db.default.db.select(requestedColumns).from(tableName).where(columnName, parentId).then(function (results) {
        return {
          results: results,
          tableName: tableName
        };
      });
    }
  }, {
    key: "mergeRelatedData",
    value: function mergeRelatedData(_ref3) {
      var _ref4 = _toArray(_ref3),
          results = _ref4[0],
          relations = _ref4.slice(1);

      if (relations && relations.length) {
        relations.forEach(function (relation) {
          results[relation.tableName] = relation.results;
        });
      }

      return results;
    }
  }]);

  return TableController;
}();

var _default = TableController;
exports.default = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9hcGkvY29udHJvbGxlcnMvVGFibGVDb250cm9sbGVyLnRzIl0sIm5hbWVzIjpbImRlYnVnIiwidG9SZXF1ZXN0QnVpbGRlciIsInJlbGF0aW9uIiwiY29sdW1uTmFtZSIsInZhbHVlcyIsIlNldCIsImtleSIsImRpc3BsYXkiLCJmb3JlaWduS2V5Q29sdW1uIiwiVGFibGVDb250cm9sbGVyIiwicmVxIiwicmVzIiwibmV4dCIsIlRBQkxFX0NPTkZJRyIsInBhcmFtcyIsInRhYmxlIiwiUkVTVUxUIiwiY29sdW1ucyIsIm5hbWUiLCJwayIsInZlcmJvc2UiLCJjaGlwcyIsInJvbGVzIiwidXNlciIsIkh0dHBFeGNlcHRpb24iLCJQQUdFX05VTUJFUiIsInF1ZXJ5IiwicGFnZSIsIlRBQkxFX05BTUUiLCJPUkRFUiIsIm9yZGVyIiwiQ09MVU1OUyIsIkxJTUlUIiwiZGF0YWJhc2UiLCJkYiIsIkRCIiwiUVVFUlkiLCJzZWxlY3QiLCJmcm9tIiwiZmlsdGVyIiwic2VhcmNoIiwiT1JERVJfT0JKIiwiSlNPTiIsInBhcnNlIiwiQXJyYXkiLCJpc0FycmF5Iiwib3JkZXJCeSIsImNvbHVtbiIsImxpbWl0IiwicGFyc2VJbnQiLCJvZmZzZXQiLCJ0aGVuIiwiaG9va1Jlc3VsdCIsIk9iamVjdCIsImtleXMiLCJmb3JFYWNoIiwid2hlcmVJbiIsInJlc3VsdHMiLCJmcmllbmRseURhdGEiLCJhZGRWZXJib3NlUmVsYXRlZERhdGEiLCJyZXF1aXJlbWVudHNDaGVjayIsIlByb21pc2UiLCJhbGwiLCJjYXRjaCIsInJlcXVlc3RlZENvbHVtbnMiLCJ3aGVyZSIsImlkIiwicmVsYXRpb25RdWVyaWVzIiwiaW5jbHVkZVJlbGF0aW9ucyIsImdldFJlbGF0aW9uUXVlcmllcyIsImxlbmd0aCIsIm1lcmdlUmVsYXRlZERhdGEiLCJ0eXBlIiwiYm9keSIsImRhdGEiLCJEYXRlIiwiaW5zZXJ0IiwidXBkYXRlIiwiZGVsIiwidG9SZXF1ZXN0IiwiQ09MVU1OU19XSVRIX1JFTEFUSU9OUyIsInJvdyIsImluZGV4IiwiUkVMQVRJT05fVEFCTEVfTkFNRSIsImFkZCIsInRhYmxlTmFtZSIsInB1c2giLCJyZWxhdGlvblJlc3VsdHMiLCJNQVRDSEVSIiwicmVxdWVzdGVkVGFibGUiLCJGT1JFSUdOX0tFWV9DT0xVTU4iLCJyZWxhdGlvblJvdyIsIkNVUlJFTlRfVkFMVUUiLCJWQUxVRV9UT19ESVNQTEFZIiwibWFwIiwiUk9XX0tFWSIsInRhYmxlQ29uZmlnIiwiZGJJbnN0YW5jZSIsInJlamVjdCIsInJlc29sdmUiLCJwYXJlbnRJZCIsInJlbGF0aW9ucyIsIm1hbnlUb09uZSIsIk1BTllfVE9fT05FIiwiS0VZUyIsImdldFJlbGF0ZWRSb3ciXSwibWFwcGluZ3MiOiI7Ozs7Ozs7QUFBQTs7QUFDQTs7QUFDQTs7QUFjQTs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OztBQUlBLElBQU1BLEtBQUssR0FBRyxvQkFBTSw0QkFBTixDQUFkOztBQWFBLFNBQVNDLGdCQUFULENBQTBCQyxRQUExQixFQUFxREMsVUFBckQsRUFBeUY7QUFDdkYsU0FBTztBQUNMQyxJQUFBQSxNQUFNLEVBQUUsSUFBSUMsR0FBSixFQURIO0FBRUxDLElBQUFBLEdBQUcsRUFBRUosUUFBUSxDQUFDSSxHQUZUO0FBR0xDLElBQUFBLE9BQU8sRUFBRUwsUUFBUSxDQUFDSyxPQUhiO0FBSUxDLElBQUFBLGdCQUFnQixFQUFFTDtBQUpiLEdBQVA7QUFNRDs7SUFFS00sZTs7O0FBQ0osNkJBQWM7QUFBQTs7QUFDWlQsSUFBQUEsS0FBSyxDQUFDLFNBQUQsQ0FBTDtBQUNEOzs7O21DQUVxQlUsRyxFQUFpQkMsRyxFQUFrQkMsSSxFQUFvQjtBQUMzRSxVQUFNQyxZQUFZLEdBQUcsMkJBQWVILEdBQUcsQ0FBQ0ksTUFBSixDQUFXQyxLQUExQixDQUFyQjtBQUNBLFVBQU1DLE1BQU0sR0FBRztBQUNiQyxRQUFBQSxPQUFPLEVBQUVKLFlBQVksQ0FBQ0ksT0FEVDtBQUViQyxRQUFBQSxJQUFJLEVB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cGkvZGInXG5pbXBvcnQgeyBIdHRwRXhjZXB0aW9uLCBJTUNSZXF1ZXN0LCBJTUNSZXNwb25zZSwgSVVzZXIgfSBmcm9tICdAcm9vdC9hcGkvdHlwZXMnXG5pbXBvcnQge1xuICBhZGRUb1Jlc3BvbnNlLFxuICBhcHBseVF1ZXJ5RmlsdGVycyxcbiAgYXBwbHlRdWVyeVNlYXJjaCxcbiAgY2F0Y2hNaWRkbGV3YXJlLFxuICBmaWx0ZXJWaXNpYmxlVGFibGVDb2x1bW5zLFxuICBnZXRDb2x1bW5zV2l0aFJlbGF0aW9ucyxcbiAgZ2V0VGFibGVDb25maWcsXG4gIGhhc0F1dGhvcml6YXRpb24sXG4gIG5leHRBbmRSZXR1cm4sXG4gIHJ1bkhvb2tcbn0gZnJvbSAnQHJvb3QvYXBpL3V0aWxzJ1xuaW1wb3J0IHsgSUNvbHVtblJlbGF0aW9uLCBJVGFibGVJbmZvIH0gZnJvbSAnQHJvb3QvY29uZmlnR2VuZXJhdG9yJ1xuaW1wb3J0IEJsdWViaXJkIGZyb20gJ2JsdWViaXJkJ1xuaW1wb3J0IERlYnVnIGZyb20gJ2RlYnVnJ1xuaW1wb3J0IHsgTmV4dEZ1bmN0aW9uLCBSZXF1ZXN0IH0gZnJvbSAnZXhwcmVzcydcbmltcG9ydCBLbmV4IGZyb20gJ0tuZXgnXG5cbmNvbnN0IGRlYnVnID0gRGVidWcoJ2Z1bmZ1bnptYzpjb250cm9sbGVyLXRhYmxlJylcblxuaW50ZXJmYWNlIElUb1JlcXVlc3RJdGVtIHtcbiAgdmFsdWVzOiBTZXQ8bnVtYmVyPixcbiAga2V5OiBzdHJpbmcsXG4gIGRpc3BsYXk6IHN0cmluZyxcbiAgZm9yZWlnbktleUNvbHVtbjogc3RyaW5nXG59XG5cbmludGVyZmFjZSBJVG9SZXF1ZXN0IHtcbiAgW2tleTogc3RyaW5nXTogSVRvUmVxdWVzdEl0ZW0sXG59XG5cbmZ1bmN0aW9uIHRvUmVxdWVzdEJ1aWxkZXIocmVsYXRpb246IElDb2x1bW5SZWxhdGlvbiwgY29sdW1uTmFtZTogc3RyaW5nKTogSVRvUmVxdWVzdEl0ZW0ge1xuICByZXR1cm4ge1xuICAgIHZhbHVlczogbmV3IFNldDxudW1iZXI+KCksXG4gICAga2V5OiByZWxhdGlvbi5rZXksXG4gICAgZGlzcGxheTogcmVsYXRpb24uZGlzcGxheSxcbiAgICBmb3JlaWduS2V5Q29sdW1uOiBjb2x1bW5OYW1lLFxuICB9XG59XG5cbmNsYXNzIFRhYmxlQ29udHJvbGxlciB7XG4gIGNvbnN0cnVjdG9yKCkge1xuICAgIGRlYnVnKCdDcmVhdGVkJylcbiAgfVxuXG4gIHB1YmxpYyBnZXRUYWJsZUNvbmZpZyhyZXE6IElNQ1JlcXVlc3QsIHJlczogSU1DUmVzcG9uc2UsIG5leHQ6IE5leHRGdW5jdGlvbikge1xuICAgIGNvbnN0IFRBQkxFX0NPTkZJRyA9IGdldFRhYmxlQ29uZmlnKHJlcS5wYXJhbXMudGFibGUpXG4gICAgY29uc3QgUkVTVUxUID0ge1xuICAgICAgY29sdW1uczogVEFCTEVfQ09ORklHLmNvbHVtbnMsXG4gICAgICBuYW1lOiBUQUJMRV9DT05GSUcubmFtZSxcbiAgICAgIHBrOiBUQUJMRV9DT05GSUcucGssXG4gICAgICB2ZXJib3NlOiBUQUJMRV9DT05GSUcudmVyYm9zZSxcbiAgICAgIGNoaXBzOiBUQUJMRV9DT05GSUcuY2hpcHMgfHwgW10sXG4gICAgfVxuXG4gICAgaWYgKCFoYXNBdXRob3JpemF0aW9uKFRBQkxFX0NPTkZJRy5yb2xlcywgcmVxLnVzZXIpKSB7XG4gICAgICByZXR1cm4gY2F0Y2hNaWRkbGV3YXJlKG5leHQpKG5ldyBIdHRwRXhjZXB0aW9uKDQwMSwgJ05vdCBhdXRob3JpemVkJykpXG4gICAgfVxuICAgIGFkZFRvUmVzcG9uc2UocmVzLCAncmVzdWx0cycpKFJFU1VMVClcbiAgICByZXR1cm4gbmV4dEFuZFJldHVybihuZXh0KShSRVNVTFQpXG4gIH1cblxuICBwdWJsaWMgZ2V0VGFibGVEYXRhKHJlcTogSU1DUmVxdWVzdCwgcmVzOiBJTUNSZXNwb25zZSwgbmV4dDogTmV4dEZ1bmN0aW9uKSB7XG4gICAgY29uc3QgUEFHRV9OVU1CRVIgPSByZXEucXVlcnkucGFnZSB8fCAwXG4gICAgY29uc3QgVEFCTEVfTkFNRSA9IHJlcS5wYXJhbXMudGFibGVcbiAgICBjb25zdCBPUkRFUiA9IHJlcS5xdWVyeS5vcmRlciB8fCBudWxsXG4gICAgY29uc3QgVEFCTEVfQ09ORklHID0gZ2V0VGFibGVDb25maWcoVEFCTEVfTkFNRSlcbiAgICBjb25zdCBDT0xVTU5TID0gZmlsdGVyVmlzaWJsZVRhYmxlQ29sdW1ucyhUQUJMRV9DT05GSUcsICdtYWluJylcbiAgICBsZXQgTElNSVQgPSAxMFxuXG4gICAgaWYgKCFoYXNBdXRob3JpemF0aW9uKFRBQkxFX0NPTkZJRy5yb2xlcywgcmVxLnVzZXIpKSB7XG4gICAgICByZXR1cm4gY2F0Y2hNaWRkbGV3YXJlKG5leHQpKG5ldyBIdHRwRXhjZXB0aW9uKDQwMSwgJ05vdCBhdXRob3JpemVkJykpXG4gICAgfVxuICAgIGlmICghZGF0YWJhc2UuZGIpIHtcbiAgICAgIHJldHVybiBjYXRjaE1pZGRsZXdhcmUobmV4dCkobmV3IEh0dHBFeGNlcHRpb24oNTAwLCAnTm8gZGF0YWJhc2UnKSlcbiAgICB9XG4gICAgY29uc3QgREIgPSBkYXRhYmFzZS5kYlxuICAgIGxldCBRVUVSWSA9IERCLnNlbGVjdChDT0xVTU5TKS5mcm9tKFRBQkxFX05BTUUpXG4gICAgaWYgKHJlcS5xdWVyeS5maWx0ZXIpIHtcbiAgICAgIFFVRVJZID0gYXBwbHlRdWVyeUZpbHRlcnMoUVVFUlksIHJlcS5xdWVyeS5maWx0ZXIsIFRBQkxFX0NPTkZJRylcbiAgICB9XG5cbiAgICBpZiAocmVxLnF1ZXJ5LnNlYXJjaCkge1xuICAgICAgUVVFUlkgPSBhcHBseVF1ZXJ5U2VhcmNoKFFVRVJZLCByZXEucXVlcnkuc2VhcmNoLCBUQUJMRV9DT05GSUcpXG4gICAgfVxuXG4gICAgaWYgKE9SREVSKSB7XG4gICAgICBjb25zdCBPUkRFUl9PQkogPSBKU09OLnBhcnNlKE9SREVSKVxuICAgICAgaWYgKEFycmF5LmlzQXJyYXkoT1JERVJfT0JKKSkge1xuICAgICAgICBRVUVSWS5vcmRlckJ5KE9SREVSX09CSilcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIFFVRVJZLm9yZGVyQnkoT1JERVJfT0JKLmNvbHVtbiwgT1JERVJfT0JKLm9yZGVyKVxuICAgICAgfVxuICAgIH1cblxuICAgIGlmIChyZXEucXVlcnkubGltaXQpIHtcbiAgICAgIExJTUlUID0gcGFyc2VJbnQocmVxLnF1ZXJ5LmxpbWl0LCAxMClcbiAgICB9XG4gICAgaWYgKExJTUlUID4gMCkge1xuICAgICAgUVVFUlkub2Zmc2V0KChQQUdFX05VTUJFUikgKiBMSU1JVCkubGltaXQoTElNSVQpXG4gICAgfVxuXG4gICAgcmV0dXJuIHJ1bkhvb2soVEFCTEVfQ09ORklHLCAnZ2V0VGFibGVEYXRhJywgJ2JlZm9yZScsIHJlcSwgcmVzLCBkYXRhYmFzZS5kYikudGhlbihcbiAgICAgIChob29rUmVzdWx0KSA9PiB7XG4gICAgICAgIGlmIChob29rUmVzdWx0KSB7XG4gICAgICAgICAgaWYgKGhvb2tSZXN1bHQuZmlsdGVyKSB7XG4gICAgICAgICAgICBPYmplY3Qua2V5cyhob29rUmVzdWx0LmZpbHRlcikuZm9yRWFjaChcbiAgICAgICAgICAgICAgKGNvbHVtbikgPT4ge1xuICAgICAgICAgICAgICAgIGlmIChBcnJheS5pc0FycmF5KGhvb2tSZXN1bHQuZmlsdGVyW2NvbHVtbl0pKSB7XG4gICAgICAgICAgICAgICAgICBRVUVSWS53aGVyZUluKGNvbHVtbiwgaG9va1Jlc3VsdC5maWx0ZXJbY29sdW1uXSlcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIClcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIFFVRVJZXG4gICAgICB9XG4gICAgKS50aGVuKFxuICAgICAgKHJlc3VsdHMpID0+IHtcbiAgICAgICAgaWYgKHJlcS5xdWVyeS5mcmllbmRseURhdGEpIHtcbiAgICAgICAgICByZXR1cm4gdGhpcy5hZGRWZXJib3NlUmVsYXRlZERhdGEocmVzdWx0cywgVEFCTEVfQ09ORklHLCBEQilcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gcmVzdWx0c1xuICAgICAgfVxuICAgICkudGhlbihcbiAgICAgIChyZXN1bHRzKSA9PiB7XG4gICAgICAgIHJldHVybiBydW5Ib29rKFRBQkxFX0NPTkZJRywgJ2dldFRhYmxlRGF0YScsICdhZnRlcicsIHJlcSwgcmVzLCBkYXRhYmFzZS5kYiwgcmVzdWx0cylcbiAgICAgIH1cbiAgICApLnRoZW4oXG4gICAgICBhZGRUb1Jlc3BvbnNlKHJlcywgJ3Jlc3VsdHMnKVxuICAgICkudGhlbihcbiAgICAgIG5leHRBbmRSZXR1cm4obmV4dClcbiAgICApXG4gIH1cblxuICBwdWJsaWMgZ2V0VGFibGVDb3VudChyZXE6IElNQ1JlcXVlc3QsIHJlczogSU1DUmVzcG9uc2UsIG5leHQ6IE5leHRGdW5jdGlvbikge1xuICAgIGNvbnN0IFRBQkxFX05BTUUgPSByZXEucGFyYW1zLnRhYmxlXG4gICAgY29uc3QgVEFCTEVfQ09ORklHID0gZ2V0VGFibGVDb25maWcoVEFCTEVfTkFNRSlcblxuICAgIHJldHVybiB0aGlzLnJlcXVpcmVtZW50c0NoZWNrKFRBQkxFX0NPTkZJRywgcmVxLnVzZXIsIGRhdGFiYXNlLCBuZXh0KS50aGVuKFxuICAgICAgKERCKSA9PiB7XG4gICAgICAgIGxldCBRVUVSWSA9IERCKFRBQkxFX05BTUUpLnNlbGVjdCgnKicpXG4gICAgICAgIGlmIChyZXEucXVlcnkuc2VhcmNoKSB7XG4gICAgICAgICAgUVVFUlkgPSBhcHBseVF1ZXJ5U2VhcmNoKFFVRVJZLCByZXEucXVlcnkuc2VhcmNoLCBUQUJMRV9DT05GSUcpXG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIFByb21pc2UuYWxsKFtEQiwgUVVFUlldKVxuICAgICAgfVxuICAgICkudGhlbihcbiAgICAgIChbREIsIHJlc3VsdHNdKSA9PiB7XG4gICAgICAgIHJldHVybiBydW5Ib29rKFRBQkxFX0NPTkZJRywgJ2dldFRhYmxlQ291bnQnLCAnYWZ0ZXInLCByZXEsIHJlcywgREIsIHJlc3VsdHMpXG4gICAgICB9XG4gICAgKS50aGVuKFxuICAgICAgYWRkVG9SZXNwb25zZShyZXMsICdjb3VudCcpXG4gICAgKS50aGVuKFxuICAgICAgbmV4dEFuZFJldHVybihuZXh0KVxuICAgICkuY2F0Y2goXG4gICAgICBjYXRjaE1pZGRsZXdhcmUobmV4dClcbiAgICApXG4gIH1cblxuICBwdWJsaWMgZ2V0Um93KHJlcTogSU1DUmVxdWVzdCwgcmVzOiBJTUNSZXNwb25zZSwgbmV4dDogTmV4dEZ1bmN0aW9uKSB7XG4gICAgY29uc3QgVEFCTEVfTkFNRSA9IHJlcS5wYXJhbXMudGFibGVcbiAgICBjb25zdCBUQUJMRV9DT05GSUcgPSBnZXRUYWJsZUNvbmZpZyhUQUJMRV9OQU1FKVxuXG4gICAgcmV0dXJuIHRoaXMucmVxdWlyZW1lbnRzQ2hlY2soVEFCTEVfQ09ORklHLCByZXEudXNlciwgZGF0YWJhc2UsIG5leHQpLnRoZW4oXG4gICAgICAoREIpID0+IHtcbiAgICAgICAgY29uc3QgcmVxdWVzdGVkQ29sdW1ucyA9IGZpbHRlclZpc2libGVUYWJsZUNvbHVtbnMoVEFCTEVfQ09ORklHLCAnZGV0YWlsJylcblxuICAgICAgICByZXR1cm4gREIuc2VsZWN0KHJlcXVlc3RlZENvbHVtbnMpXG4gICAgICAgICAgLmZyb20oYCR7cmVxLnBhcmFtcy50YWJsZX1gKVxuICAgICAgICAgIC53aGVyZSgnaWQnLCByZXEucGFyYW1zLmlkKVxuICAgICAgfVxuICAgICkudGhlbihcbiAgICAgIChyZXN1bHRzKSA9PiB7XG4gICAgICAgIGxldCByZWxhdGlvblF1ZXJpZXM6IEFycmF5PEJsdWViaXJkPHt9Pj4gPSBbXVxuICAgICAgICBpZiAocmVxLnF1ZXJ5LmluY2x1ZGVSZWxhdGlvbnMpIHtcbiAgICAgICAgICByZWxhdGlvblF1ZXJpZXMgPSB0aGlzLmdldFJlbGF0aW9uUXVlcmllcyhUQUJMRV9DT05GSUcsIHJlc3VsdHNbMF0uaWQpXG4gICAgICAgIH1cblxuICAgICAgICBpZiAocmVsYXRpb25RdWVyaWVzLmxlbmd0aCkge1xuICAgICAgICAgIHJldHVybiBQcm9taXNlLmFsbChbXG4gICAgICAgICAgICByZXN1bHRzWzBdLFxuICAgICAgICAgICAgLi4ucmVsYXRpb25RdWVyaWVzLFxuICAgICAgICAgIF0pXG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gUHJvbWlzZS5hbGwoW1xuICAgICAgICAgIHJlc3VsdHNbMF0sXG4gICAgICAgIF0pXG4gICAgICB9XG4gICAgKS50aGVuKFxuICAgICAgdGhpcy5tZXJnZVJlbGF0ZWREYXRhXG4gICAgKS50aGVuKFxuICAgICAgYWRkVG9SZXNwb25zZShyZXMsICdyZXN1bHRzJylcbiAgICApLnRoZW4oXG4gICAgICBuZXh0QW5kUmV0dXJuKG5leHQpXG4gICAgKS5jYXRjaChcbiAgICAgIGNhdGNoTWlkZGxld2FyZShuZXh0KVxuICAgIClcbiAgfVxuXG4gIHB1YmxpYyBpbnNlcnRSb3cocmVxOiBJTUNSZXF1ZXN0LCByZXM6IElNQ1Jlc3BvbnNlLCBuZXh0OiBOZXh0RnVuY3Rpb24pIHtcbiAgICBjb25zdCBUQUJMRV9OQU1FID0gcmVxLnBhcmFtcy50YWJsZVxuICAgIGNvbnN0IFRBQkxFX0NPTkZJRyA9IGdldFRhYmxlQ29uZmlnKFRBQkxFX05BTUUpXG5cbiAgICByZXR1cm4gdGhpcy5yZXF1aXJlbWVudHNDaGVjayhUQUJMRV9DT05GSUcsIHJlcS51c2VyLCBkYXRhYmFzZSwgbmV4dCkudGhlbihcbiAgICAgIChEQikgPT4ge1xuICAgICAgICBUQUJMRV9DT05GSUcuY29sdW1ucy5mb3JFYWNoKFxuICAgICAgICAgIChjb2x1bW4pID0+IHtcbiAgICAgICAgICAgIGlmIChjb2x1bW4udHlwZSA9PT0gJ2RhdGV0aW1lJykge1xuICAgICAgICAgICAgICByZXEuYm9keS5kYXRhW2NvbHVtbi5uYW1lXSA9IG5ldyBEYXRlKHJlcS5ib2R5LmRhdGFbY29sdW1uLm5hbWVdIHx8IG51bGwpXG4gICAgICAgICAgICB9IGVsc2UgaWYgKGNvbHVtbi50eXBlID09PSAndGlueWludCgxKScpIHtcbiAgICAgICAgICAgICAgcmVxLmJvZHkuZGF0YVtjb2x1bW4ubmFtZV0gPSBjb2x1bW4udHlwZSA/IDEgOiAwXG4gICAgICAgICAgICB9XG4gICAgICAgICAgfVxuICAgICAgICApXG4gICAgICAgIHJldHVybiBEQihyZXEucGFyYW1zLnRhYmxlKS5pbnNlcnQocmVxLmJvZHkuZGF0YSlcbiAgICAgIH1cbiAgICApLnRoZW4oXG4gICAgICAocmVzdWx0cykgPT4ge1xuICAgICAgICBhZGRUb1Jlc3BvbnNlKHJlcywgJ3Jlc3VsdHMnKShyZXN1bHRzKVxuICAgICAgfVxuICAgICkudGhlbihcbiAgICAgIG5leHRBbmRSZXR1cm4obmV4dClcbiAgICApLmNhdGNoKFxuICAgICAgY2F0Y2hNaWRkbGV3YXJlKG5leHQpXG4gICAgKVxuICB9XG5cbiAgcHVibGljIHVwZGF0ZVJvdyhyZXE6IElNQ1JlcXVlc3QsIHJlczogSU1DUmVzcG9uc2UsIG5leHQ6IE5leHRGdW5jdGlvbikge1xuICAgIGNvbnN0IFRBQkxFX05BTUUgPSByZXEucGFyYW1zLnRhYmxlXG4gICAgY29uc3QgVEFCTEVfQ09ORklHID0gZ2V0VGFibGVDb25maWcoVEFCTEVfTkFNRSlcblxuICAgIHJldHVybiB0aGlzLnJlcXVpcmVtZW50c0NoZWNrKFRBQkxFX0NPTkZJRywgcmVxLnVzZXIsIGRhdGFiYXNlLCBuZXh0KS50aGVuKFxuICAgICAgKERCKSA9PiB7XG4gICAgICAgIFRBQkxFX0NPTkZJRy5jb2x1bW5zLmZvckVhY2goXG4gICAgICAgICAgKGNvbHVtbikgPT4ge1xuICAgICAgICAgICAgaWYgKGNvbHVtbi50eXBlID09PSAnZGF0ZXRpbWUnKSB7XG4gICAgICAgICAgICAgIHJlcS5ib2R5LmRhdGFbY29sdW1uLm5hbWVdID0gbmV3IERhdGUocmVxLmJvZHkuZGF0YVtjb2x1bW4ubmFtZV0gfHwgbnVsbClcbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9XG4gICAgICAgIClcblxuICAgICAgICByZXR1cm4gREIoVEFCTEVfTkFNRSkud2hlcmUoJ2lkJywgcmVxLnBhcmFtcy5pZCkudXBkYXRlKHJlcS5ib2R5LmRhdGEpXG4gICAgICB9XG4gICAgKS50aGVuKFxuICAgICAgYWRkVG9SZXNwb25zZShyZXMsICdyZXN1bHRzJylcbiAgICApLnRoZW4oXG4gICAgICBuZXh0QW5kUmV0dXJuKG5leHQpXG4gICAgKS5jYXRjaChcbiAgICAgIGNhdGNoTWlkZGxld2FyZShuZXh0KVxuICAgIClcbiAgfVxuXG4gIHB1YmxpYyBkZWxldGVSb3cocmVxOiBJTUNSZXF1ZXN0LCByZXM6IElNQ1Jlc3BvbnNlLCBuZXh0OiBOZXh0RnVuY3Rpb24pIHtcbiAgICBjb25zdCBUQUJMRV9OQU1FID0gcmVxLnBhcmFtcy50YWJsZVxuICAgIGNvbnN0IFRBQkxFX0NPTkZJRyA9IGdldFRhYmxlQ29uZmlnKFRBQkxFX05BTUUpXG5cbiAgICByZXR1cm4gdGhpcy5yZXF1aXJlbWVudHNDaGVjayhUQUJMRV9DT05GSUcsIHJlcS51c2VyLCBkYXRhYmFzZSwgbmV4dCkudGhlbihcbiAgICAgIChEQikgPT4ge1xuICAgICAgICByZXR1cm4gREIoVEFCTEVfTkFNRSkud2hlcmUoJ2lkJywgcmVxLnBhcmFtcy5pZCkuZGVsKClcbiAgICAgIH1cbiAgICApLnRoZW4oXG4gICAgICBhZGRUb1Jlc3BvbnNlKHJlcywgJ3Jlc3VsdHMnKVxuICAgICkudGhlbihcbiAgICAgIG5leHRBbmRSZXR1cm4obmV4dClcbiAgICApLmNhdGNoKFxuICAgICAgY2F0Y2hNaWRkbGV3YXJlKG5leHQpXG4gICAgKVxuICB9XG5cbiAgcHJpdmF0ZSBhZGRWZXJib3NlUmVsYXRlZERhdGEocmVzdWx0czogYW55W10sIFRBQkxFX0NPTkZJRzogSVRhYmxlSW5mbywgREI6IEtuZXgpIHtcbiAgICBjb25zdCB0b1JlcXVlc3Q6IElUb1JlcXVlc3QgPSB7fVxuICAgIGNvbnN0IENPTFVNTlNfV0lUSF9SRUxBVElPTlMgPSBnZXRDb2x1bW5zV2l0aFJlbGF0aW9ucyhUQUJMRV9DT05GSUcpXG4gICAgcmVzdWx0cy5mb3JFYWNoKFxuICAgICAgKHJvdzogYW55LCBpbmRleDogbnVtYmVyKSA9PiB7XG4gICAgICAgIENPTFVNTlNfV0lUSF9SRUxBVElPTlMuZm9yRWFjaChcbiAgICAgICAgICAoY29sdW1uKSA9PiB7XG4gICAgICAgICAgICBpZiAoIWNvbHVtbi5yZWxhdGlvbikge1xuICAgICAgICAgICAgICB0aHJvdyBuZXcgSHR0cEV4Y2VwdGlvbig1MDAsICdDb2x1bW4gc2hvdWxkIGhhdmUgYSByZWxhdGlvbicpXG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBjb25zdCBSRUxBVElPTl9UQUJMRV9OQU1FID0gY29sdW1uLnJlbGF0aW9uLnRhYmxlXG5cbiAgICAgICAgICAgIGlmICghdG9SZXF1ZXN0W1JFTEFUSU9OX1RBQkxFX05BTUVdKSB7XG4gICAgICAgICAgICAgIHRvUmVxdWVzdFtSRUxBVElPTl9UQUJMRV9OQU1FXSA9IHRvUmVxdWVzdEJ1aWxkZXIoY29sdW1uLnJlbGF0aW9uLCBjb2x1bW4ubmFtZSlcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgdG9SZXF1ZXN0W1JFTEFUSU9OX1RBQkxFX05BTUVdLnZhbHVlcy5hZGQocm93W2NvbHVtbi5uYW1lXSlcbiAgICAgICAgICB9XG4gICAgICAgIClcbiAgICAgIH1cbiAgICApXG5cbiAgICBjb25zdCByZWxhdGlvblF1ZXJpZXM6IEtuZXguUXVlcnlCdWlsZGVyW10gPSBbXVxuICAgIE9iamVjdC5rZXlzKHRvUmVxdWVzdCkuZm9yRWFjaChcbiAgICAgICh0YWJsZU5hbWUpID0+IHtcbiAgICAgICAgcmVsYXRpb25RdWVyaWVzLnB1c2goXG4gICAgICAgICAgREIuc2VsZWN0KHRvUmVxdWVzdFt0YWJsZU5hbWVdLmRpc3BsYXksIHRvUmVxdWVzdFt0YWJsZU5hbWVdLmtleSlcbiAgICAgICAgICAgIC5mcm9tKHRhYmxlTmFtZSlcbiAgICAgICAgICAgIC53aGVyZUluKHRvUmVxdWVzdFt0YWJsZU5hbWVdLmtleSwgQXJyYXkuZnJvbSh0b1JlcXVlc3RbdGFibGVOYW1lXS52YWx1ZXMudmFsdWVzKCkpKVxuICAgICAgICApXG4gICAgICB9XG4gICAgKVxuXG4gICAgcmV0dXJuIFByb21pc2UuYWxsPGFueVtdPihyZWxhdGlvblF1ZXJpZXMpLnRoZW4oXG4gICAgICAocmVsYXRpb25SZXN1bHRzKSA9PiB7XG4gICAgICAgIGNvbnN0IE1BVENIRVI6IHtcbiAgICAgICAgICBbZm9yZWlnbktleUNvbHVtbjogc3RyaW5nXToge1xuICAgICAgICAgICAgW3ZhbHVlOiBzdHJpbmddOiBzdHJpbmdcbiAgICAgICAgICB9XG4gICAgICAgIH0gPSB7fVxuICAgICAgICBPYmplY3QudmFsdWVzKHRvUmVxdWVzdCkuZm9yRWFjaChcbiAgICAgICAgICAocmVxdWVzdGVkVGFibGUsIGluZGV4KSA9PiB7XG4gICAgICAgICAgICBjb25zdCBGT1JFSUdOX0tFWV9DT0xVTU4gPSByZXF1ZXN0ZWRUYWJsZS5mb3JlaWduS2V5Q29sdW1uXG4gICAgICAgICAgICBNQVRDSEVSW0ZPUkVJR05fS0VZX0NPTFVNTl0gPSB7fVxuICAgICAgICAgICAgcmVsYXRpb25SZXN1bHRzW2luZGV4XS5mb3JFYWNoKFxuICAgICAgICAgICAgICAocmVsYXRpb25Sb3c6IGFueSkgPT4ge1xuICAgICAgICAgICAgICAgIGNvbnN0IENVUlJFTlRfVkFMVUUgPSByZWxhdGlvblJvd1tyZXF1ZXN0ZWRUYWJsZS5rZXldXG4gICAgICAgICAgICAgICAgY29uc3QgVkFMVUVfVE9fRElTUExBWSA9IHJlbGF0aW9uUm93W3JlcXVlc3RlZFRhYmxlLmRpc3BsYXldXG4gICAgICAgICAgICAgICAgTUFUQ0hFUltGT1JFSUdOX0tFWV9DT0xVTU5dW0NVUlJFTlRfVkFMVUVdID0gVkFMVUVfVE9fRElTUExBWVxuICAgICAgICAgICAgICB9XG4gICAgICAgICAgICApXG4gICAgICAgICAgfVxuICAgICAgICApXG4gICAgICAgIHJldHVybiByZXN1bHRzLm1hcChcbiAgICAgICAgICAocm93OiBhbnkpID0+IHtcbiAgICAgICAgICAgIE9iamVjdC52YWx1ZXModG9SZXF1ZXN0KS5mb3JFYWNoKFxuICAgICAgICAgICAgICAocmVxdWVzdGVkVGFibGUpID0+IHtcbiAgICAgICAgICAgICAgICBjb25zdCBST1dfS0VZID0gcmVxdWVzdGVkVGFibGUuZm9yZWlnbktleUNvbHVtblxuICAgICAgICAgICAgICAgIHJvd1tST1dfS0VZXSA9IE1BVENIRVJbUk9XX0tFWV1bcm93W1JPV19LRVldXVxuICAgICAgICAgICAgICB9XG4gICAgICAgICAgICApXG4gICAgICAgICAgICByZXR1cm4gcm93XG4gICAgICAgICAgfVxuICAgICAgICApXG4gICAgICB9XG4gICAgKVxuICB9XG5cbiAgcHJpdmF0ZSByZXF1aXJlbWVudHNDaGVjayhcbiAgICB0YWJsZUNvbmZpZzogSVRhYmxlSW5mbyxcbiAgICB1c2VyOiBJVXNlciB8IHVuZGVmaW5lZCxcbiAgICBkYkluc3RhbmNlOiBEYXRhYmFzZSxcbiAgICBuZXh0OiAocGFyYW0/OiBhbnkpID0+IHZvaWRcbiAgKSB7XG4gICAgaWYgKCFoYXNBdXRob3JpemF0aW9uKHRhYmxlQ29uZmlnLnJvbGVzLCB1c2VyKSkge1xuICAgICAgcmV0dXJuIFByb21pc2UucmVqZWN0KG5ldyBIdHRwRXhjZXB0aW9uKDQwMSwgJ05vdCBhdXRob3JpemVkJykpXG4gICAgfVxuICAgIGlmICghZGJJbnN0YW5jZS5kYikge1xuICAgICAgcmV0dXJuIGNhdGNoTWlkZGxld2FyZShuZXh0KShuZXcgSHR0cEV4Y2VwdGlvbig1MDAsICdObyBkYXRhYmFzZScpKVxuICAgIH1cbiAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKGRiSW5zdGFuY2UuZGIpXG4gIH1cblxuICBwcml2YXRlIGdldFJlbGF0aW9uUXVlcmllcyhUQUJMRV9DT05GSUc6IElUYWJsZUluZm8sIHBhcmVudElkOiBhbnkpIHtcbiAgICBjb25zdCByZWxhdGlvblF1ZXJpZXM6IEFycmF5PEJsdWViaXJkPHt9Pj4gPSBbXVxuICAgIGlmIChUQUJMRV9DT05GSUcucmVsYXRpb25zICYmIFRBQkxFX0NPTkZJRy5yZWxhdGlvbnMubWFueVRvT25lKSB7XG4gICAgICBjb25zdCBNQU5ZX1RPX09ORSA9IFRBQkxFX0NPTkZJRy5yZWxhdGlvbnMubWFueVRvT25lXG4gICAgICBjb25zdCBLRVlTOiBzdHJpbmdbXSA9IE9iamVjdC5rZXlzKE1BTllfVE9fT05FKVxuICAgICAgS0VZUy5mb3JFYWNoKFxuICAgICAgICAodGFibGVOYW1lKSA9PiB7XG4gICAgICAgICAgcmVsYXRpb25RdWVyaWVzLnB1c2goXG4gICAgICAgICAgICB0aGlzLmdldFJlbGF0ZWRSb3coXG4gICAgICAgICAgICAgIHRhYmxlTmFtZSxcbiAgICAgICAgICAgICAgTUFOWV9UT19PTkVbdGFibGVOYW1lXSxcbiAgICAgICAgICAgICAgcGFyZW50SWRcbiAgICAgICAgICAgIClcbiAgICAgICAgICApXG4gICAgICAgIH1cbiAgICAgIClcbiAgICB9XG5cbiAgICByZXR1cm4gcmVsYXRpb25RdWVyaWVzXG4gIH1cblxuICBwcml2YXRlIGdldFJlbGF0ZWRSb3codGFibGVOYW1lOiBzdHJpbmcsIGNvbHVtbk5hbWU6IHN0cmluZywgcGFyZW50SWQ6IGFueSkge1xuICAgIGlmICghZGF0YWJhc2UuZGIpIHtcbiAgICAgIHRocm93IG5ldyBIdHRwRXhjZXB0aW9uKDUwMCwgJ05vIGRhdGFiYXNlJylcbiAgICB9XG4gICAgY29uc3QgVEFCTEVfTkFNRSA9IHRhYmxlTmFtZVxuICAgIGNvbnN0IFRBQkxFX0NPTkZJRyA9IGdldFRhYmxlQ29uZmlnKFRBQkxFX05BTUUpXG5cbiAgICBjb25zdCByZXF1ZXN0ZWRDb2x1bW5zID0gZmlsdGVyVmlzaWJsZVRhYmxlQ29sdW1ucyhUQUJMRV9DT05GSUcsICdkZXRhaWwnKVxuICAgIHJldHVybiBkYXRhYmFzZS5kYi5zZWxlY3QocmVxdWVzdGVkQ29sdW1ucylcbiAgICAgIC5mcm9tKHRhYmxlTmFtZSlcbiAgICAgIC53aGVyZShjb2x1bW5OYW1lLCBwYXJlbnRJZCkudGhlbihcbiAgICAgICAgKHJlc3VsdHMpID0+ICh7XG4gICAgICAgICAgcmVzdWx0cyxcbiAgICAgICAgICB0YWJsZU5hbWUsXG4gICAgICAgIH0pXG4gICAgICApXG4gIH1cblxuICBwcml2YXRlIG1lcmdlUmVsYXRlZERhdGEoW3Jlc3VsdHMsIC4uLnJlbGF0aW9uc106IGFueSkge1xuICAgIGlmIChyZWxhdGlvbnMgJiYgcmVsYXRpb25zLmxlbmd0aCkge1xuICAgICAgcmVsYXRpb25zLmZvckVhY2goXG4gICAgICAgIChyZWxhdGlvbjoge3RhYmxlTmFtZTogc3RyaW5nLCByZXN1bHRzOiBhbnlbXX0pID0+IHtcbiAgICAgICAgICByZXN1bHRzW3JlbGF0aW9uLnRhYmxlTmFtZV0gPSByZWxhdGlvbi5yZXN1bHRzXG4gICAgICAgIH1cbiAgICAgIClcbiAgICB9XG5cbiAgICByZXR1cm4gcmVzdWx0c1xuICB9XG59XG5cbmV4cG9ydCBkZWZhdWx0IFRhYmxlQ29udHJvbGxlclxuIl19