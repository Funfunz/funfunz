"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _db = _interopRequireDefault(require("../db"));

var _types = require("../types");

var _utils = require("../utils");

var _debug = _interopRequireDefault(require("debug"));

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

function _toArray(arr) { return _arrayWithHoles(arr) || _iterableToArray(arr) || _nonIterableRest(); }

function _toConsumableArray(arr) { return _arrayWithoutHoles(arr) || _iterableToArray(arr) || _nonIterableSpread(); }

function _nonIterableSpread() { throw new TypeError("Invalid attempt to spread non-iterable instance"); }

function _iterableToArray(iter) { if (Symbol.iterator in Object(iter) || Object.prototype.toString.call(iter) === "[object Arguments]") return Array.from(iter); }

function _arrayWithoutHoles(arr) { if (Array.isArray(arr)) { for (var i = 0, arr2 = new Array(arr.length); i < arr.length; i++) { arr2[i] = arr[i]; } return arr2; } }

function _slicedToArray(arr, i) { return _arrayWithHoles(arr) || _iterableToArrayLimit(arr, i) || _nonIterableRest(); }

function _nonIterableRest() { throw new TypeError("Invalid attempt to destructure non-iterable instance"); }

function _iterableToArrayLimit(arr, i) { var _arr = []; var _n = true; var _d = false; var _e = undefined; try { for (var _i = arr[Symbol.iterator](), _s; !(_n = (_s = _i.next()).done); _n = true) { _arr.push(_s.value); if (i && _arr.length === i) break; } } catch (err) { _d = true; _e = err; } finally { try { if (!_n && _i["return"] != null) _i["return"](); } finally { if (_d) throw _e; } } return _arr; }

function _arrayWithHoles(arr) { if (Array.isArray(arr)) return arr; }

function _classCallCheck(instance, Constructor) { if (!(instance instanceof Constructor)) { throw new TypeError("Cannot call a class as a function"); } }

function _defineProperties(target, props) { for (var i = 0; i < props.length; i++) { var descriptor = props[i]; descriptor.enumerable = descriptor.enumerable || false; descriptor.configurable = true; if ("value" in descriptor) descriptor.writable = true; Object.defineProperty(target, descriptor.key, descriptor); } }

function _createClass(Constructor, protoProps, staticProps) { if (protoProps) _defineProperties(Constructor.prototype, protoProps); if (staticProps) _defineProperties(Constructor, staticProps); return Constructor; }

var debug = (0, _debug.default)('funfunzmc:controller-table');

function toRequestBuilder(relation, columnName) {
  return {
    values: new Set(),
    key: relation.key,
    display: relation.display,
    foreignKeyColumn: columnName
  };
}

var TableController =
/*#__PURE__*/
function () {
  function TableController() {
    _classCallCheck(this, TableController);

    debug('Created');
  }

  _createClass(TableController, [{
    key: "getTableConfig",
    value: function getTableConfig(req, res, next) {
      var TABLE_CONFIG = (0, _utils.getTableConfig)(req.params.table);
      var RESULT = {
        columns: TABLE_CONFIG.columns,
        name: TABLE_CONFIG.name,
        pk: TABLE_CONFIG.pk,
        verbose: TABLE_CONFIG.verbose,
        chips: TABLE_CONFIG.chips || [],
        itemTitle: TABLE_CONFIG.itemTitle
      };

      if (!(0, _utils.hasAuthorization)(TABLE_CONFIG.roles, req.user)) {
        return (0, _utils.catchMiddleware)(next)(new _types.HttpException(401, 'Not authorized'));
      }

      (0, _utils.addToResponse)(res, 'results')(RESULT);
      return (0, _utils.nextAndReturn)(next)(RESULT);
    }
  }, {
    key: "getTableData",
    value: function getTableData(req, res, next) {
      var _this = this;

      var PAGE_NUMBER = req.query.page || 0;
      var TABLE_NAME = req.params.table;
      var ORDER = req.query.order || null;
      var TABLE_CONFIG = (0, _utils.getTableConfig)(TABLE_NAME);
      var COLUMNS = (0, _utils.filterVisibleTableColumns)(TABLE_CONFIG, 'main');
      var LIMIT = 10;

      if (!(0, _utils.hasAuthorization)(TABLE_CONFIG.roles, req.user)) {
        return (0, _utils.catchMiddleware)(next)(new _types.HttpException(401, 'Not authorized'));
      }

      if (!_db.default.db) {
        return (0, _utils.catchMiddleware)(next)(new _types.HttpException(500, 'No database'));
      }

      var DB = _db.default.db;
      var QUERY = DB.select(COLUMNS).from(TABLE_NAME);

      if (req.query.filter) {
        QUERY = (0, _utils.applyQueryFilters)(QUERY, req.query.filter, TABLE_CONFIG);
      }

      if (req.query.search) {
        QUERY = (0, _utils.applyQuerySearch)(QUERY, req.query.search, TABLE_CONFIG);
      }

      if (ORDER) {
        var ORDER_OBJ = JSON.parse(ORDER);

        if (Array.isArray(ORDER_OBJ)) {
          QUERY.orderBy(ORDER_OBJ);
        } else {
          QUERY.orderBy(ORDER_OBJ.column, ORDER_OBJ.order);
        }
      }

      if (req.query.limit) {
        LIMIT = parseInt(req.query.limit, 10);
      }

      if (LIMIT > 0) {
        QUERY.offset(PAGE_NUMBER * LIMIT).limit(LIMIT);
      }

      return (0, _utils.runHook)(TABLE_CONFIG, 'getTableData', 'before', req, res, _db.default.db).then(function (hookResult) {
        if (hookResult) {
          if (hookResult.filter) {
            Object.keys(hookResult.filter).forEach(function (column) {
              if (Array.isArray(hookResult.filter[column])) {
                QUERY.whereIn(column, hookResult.filter[column]);
              }
            });
          }
        }

        console.log(QUERY.toQuery());
        return QUERY;
      }).then(function (results) {
        if (req.query.friendlyData) {
          return _this.addVerboseRelatedData(results, TABLE_CONFIG, DB);
        }

        return results;
      }).then(function (results) {
        return (0, _utils.runHook)(TABLE_CONFIG, 'getTableData', 'after', req, res, _db.default.db, results);
      }).then((0, _utils.addToResponse)(res, 'results')).then((0, _utils.nextAndReturn)(next));
    }
  }, {
    key: "getTableCount",
    value: function getTableCount(req, res, next) {
      var TABLE_NAME = req.params.table;
      var TABLE_CONFIG = (0, _utils.getTableConfig)(TABLE_NAME);
      return this.requirementsCheck(TABLE_CONFIG, req.user, _db.default, next).then(function (DB) {
        var QUERY = DB(TABLE_NAME).select('*');

        if (req.query.search) {
          QUERY = (0, _utils.applyQuerySearch)(QUERY, req.query.search, TABLE_CONFIG);
        }

        return Promise.all([DB, QUERY]);
      }).then(function (_ref) {
        var _ref2 = _slicedToArray(_ref, 2),
            DB = _ref2[0],
            results = _ref2[1];

        return (0, _utils.runHook)(TABLE_CONFIG, 'getTableCount', 'after', req, res, DB, results);
      }).then((0, _utils.addToResponse)(res, 'count')).then((0, _utils.nextAndReturn)(next)).catch((0, _utils.catchMiddleware)(next));
    }
  }, {
    key: "getRow",
    value: function getRow(req, res, next) {
      var _this2 = this;

      var TABLE_NAME = req.params.table;
      var TABLE_CONFIG = (0, _utils.getTableConfig)(TABLE_NAME);
      return this.requirementsCheck(TABLE_CONFIG, req.user, _db.default, next).then(function (DB) {
        var requestedColumns = (0, _utils.filterVisibleTableColumns)(TABLE_CONFIG, 'detail');
        return DB.select(requestedColumns).from("".concat(req.params.table)).where('id', req.params.id);
      }).then(function (results) {
        var relationQueries = [];

        if (req.query.includeRelations) {
          relationQueries = _this2.getRelationQueries(TABLE_CONFIG, results[0].id);
        }

        if (relationQueries.length) {
          return Promise.all([results[0]].concat(_toConsumableArray(relationQueries)));
        }

        return Promise.all([results[0]]);
      }).then(this.mergeRelatedData).then(function (results) {
        return (0, _utils.runHook)(TABLE_CONFIG, 'getRow', 'after', req, res, _db.default.db, results);
      }).then((0, _utils.addToResponse)(res, 'results')).then((0, _utils.nextAndReturn)(next)).catch((0, _utils.catchMiddleware)(next));
    }
  }, {
    key: "insertRow",
    value: function insertRow(req, res, next) {
      var TABLE_NAME = req.params.table;
      var TABLE_CONFIG = (0, _utils.getTableConfig)(TABLE_NAME);
      return this.requirementsCheck(TABLE_CONFIG, req.user, _db.default, next).then(function (DB) {
        TABLE_CONFIG.columns.forEach(function (column) {
          if (column.type === 'datetime') {
            req.body.data[column.name] = new Date(req.body.data[column.name] || null);
          } else if (column.type === 'tinyint(1)') {
            req.body.data[column.name] = column.type ? 1 : 0;
          }
        });
        return DB(req.params.table).insert(req.body.data);
      }).then(function (results) {
        return (0, _utils.runHook)(TABLE_CONFIG, 'insertRow', 'after', req, res, _db.default.db, results);
      }).then(function (results) {
        (0, _utils.addToResponse)(res, 'results')(results);
      }).then((0, _utils.nextAndReturn)(next)).catch((0, _utils.catchMiddleware)(next));
    }
  }, {
    key: "updateRow",
    value: function updateRow(req, res, next) {
      var TABLE_NAME = req.params.table;
      var TABLE_CONFIG = (0, _utils.getTableConfig)(TABLE_NAME);
      return this.requirementsCheck(TABLE_CONFIG, req.user, _db.default, next).then(function (DB) {
        TABLE_CONFIG.columns.forEach(function (column) {
          if (column.type === 'datetime') {
            req.body.data[column.name] = new Date(req.body.data[column.name] || null);
          }
        });
        return DB(TABLE_NAME).where('id', req.params.id).update(req.body.data);
      }).then(function (results) {
        return (0, _utils.runHook)(TABLE_CONFIG, 'updateRow', 'after', req, res, _db.default.db, results);
      }).then((0, _utils.addToResponse)(res, 'results')).then((0, _utils.nextAndReturn)(next)).catch((0, _utils.catchMiddleware)(next));
    }
  }, {
    key: "deleteRow",
    value: function deleteRow(req, res, next) {
      var TABLE_NAME = req.params.table;
      var TABLE_CONFIG = (0, _utils.getTableConfig)(TABLE_NAME);
      return this.requirementsCheck(TABLE_CONFIG, req.user, _db.default, next).then(function (DB) {
        return DB(TABLE_NAME).where('id', req.params.id).del();
      }).then(function (results) {
        return (0, _utils.runHook)(TABLE_CONFIG, 'deleteRow', 'after', req, res, _db.default.db, results);
      }).then((0, _utils.addToResponse)(res, 'results')).then((0, _utils.nextAndReturn)(next)).catch((0, _utils.catchMiddleware)(next));
    }
  }, {
    key: "addVerboseRelatedData",
    value: function addVerboseRelatedData(results, TABLE_CONFIG, DB) {
      var toRequest = {};
      var COLUMNS_WITH_RELATIONS = (0, _utils.getColumnsWithRelations)(TABLE_CONFIG);
      results.forEach(function (row, index) {
        COLUMNS_WITH_RELATIONS.forEach(function (column) {
          if (!column.relation) {
            throw new _types.HttpException(500, 'Column should have a relation');
          }

          var RELATION_TABLE_NAME = column.relation.table;

          if (!toRequest[RELATION_TABLE_NAME]) {
            toRequest[RELATION_TABLE_NAME] = toRequestBuilder(column.relation, column.name);
          }

          toRequest[RELATION_TABLE_NAME].values.add(row[column.name]);
        });
      });
      var relationQueries = [];
      Object.keys(toRequest).forEach(function (tableName) {
        relationQueries.push(DB.select(toRequest[tableName].display, toRequest[tableName].key).from(tableName).whereIn(toRequest[tableName].key, Array.from(toRequest[tableName].values.values())));
      });
      return Promise.all(relationQueries).then(function (relationResults) {
        var MATCHER = {};
        Object.values(toRequest).forEach(function (requestedTable, index) {
          var FOREIGN_KEY_COLUMN = requestedTable.foreignKeyColumn;
          MATCHER[FOREIGN_KEY_COLUMN] = {};
          relationResults[index].forEach(function (relationRow) {
            var CURRENT_VALUE = relationRow[requestedTable.key];
            var VALUE_TO_DISPLAY = relationRow[requestedTable.display];
            MATCHER[FOREIGN_KEY_COLUMN][CURRENT_VALUE] = VALUE_TO_DISPLAY;
          });
        });
        return results.map(function (row) {
          Object.values(toRequest).forEach(function (requestedTable) {
            var ROW_KEY = requestedTable.foreignKeyColumn;
            row[ROW_KEY] = MATCHER[ROW_KEY][row[ROW_KEY]];
          });
          return row;
        });
      });
    }
  }, {
    key: "requirementsCheck",
    value: function requirementsCheck(tableConfig, user, dbInstance, next) {
      if (!(0, _utils.hasAuthorization)(tableConfig.roles, user)) {
        return Promise.reject(new _types.HttpException(401, 'Not authorized'));
      }

      if (!dbInstance.db) {
        return (0, _utils.catchMiddleware)(next)(new _types.HttpException(500, 'No database'));
      }

      return Promise.resolve(dbInstance.db);
    }
  }, {
    key: "getRelationQueries",
    value: function getRelationQueries(TABLE_CONFIG, parentId) {
      var _this3 = this;

      var relationQueries = [];

      if (TABLE_CONFIG.relations && TABLE_CONFIG.relations.manyToOne) {
        var MANY_TO_ONE = TABLE_CONFIG.relations.manyToOne;
        var KEYS = Object.keys(MANY_TO_ONE);
        KEYS.forEach(function (tableName) {
          relationQueries.push(_this3.getRelatedRow(tableName, MANY_TO_ONE[tableName], parentId));
        });
      }

      return relationQueries;
    }
  }, {
    key: "getRelatedRow",
    value: function getRelatedRow(tableName, columnName, parentId) {
      if (!_db.default.db) {
        throw new _types.HttpException(500, 'No database');
      }

      var TABLE_NAME = tableName;
      var TABLE_CONFIG = (0, _utils.getTableConfig)(TABLE_NAME);
      var requestedColumns = (0, _utils.filterVisibleTableColumns)(TABLE_CONFIG, 'detail').filter(function (column) {
        return column !== columnName;
      });
      return _db.default.db.select(requestedColumns).from(tableName).where(columnName, parentId).then(function (results) {
        return {
          results: results,
          tableName: tableName
        };
      });
    }
  }, {
    key: "mergeRelatedData",
    value: function mergeRelatedData(_ref3) {
      var _ref4 = _toArray(_ref3),
          results = _ref4[0],
          relations = _ref4.slice(1);

      if (relations && relations.length) {
        relations.forEach(function (relation) {
          results[relation.tableName] = relation.results;
        });
      }

      return results;
    }
  }]);

  return TableController;
}();

var _default = TableController;
exports.default = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9hcGkvY29udHJvbGxlcnMvVGFibGVDb250cm9sbGVyLnRzIl0sIm5hbWVzIjpbImRlYnVnIiwidG9SZXF1ZXN0QnVpbGRlciIsInJlbGF0aW9uIiwiY29sdW1uTmFtZSIsInZhbHVlcyIsIlNldCIsImtleSIsImRpc3BsYXkiLCJmb3JlaWduS2V5Q29sdW1uIiwiVGFibGVDb250cm9sbGVyIiwicmVxIiwicmVzIiwibmV4dCIsIlRBQkxFX0NPTkZJRyIsInBhcmFtcyIsInRhYmxlIiwiUkVTVUxUIiwiY29sdW1ucyIsIm5hbWUiLCJwayIsInZlcmJvc2UiLCJjaGlwcyIsIml0ZW1UaXRsZSIsInJvbGVzIiwidXNlciIsIkh0dHBFeGNlcHRpb24iLCJQQUdFX05VTUJFUiIsInF1ZXJ5IiwicGFnZSIsIlRBQkxFX05BTUUiLCJPUkRFUiIsIm9yZGVyIiwiQ09MVU1OUyIsIkxJTUlUIiwiZGF0YWJhc2UiLCJkYiIsIkRCIiwiUVVFUlkiLCJzZWxlY3QiLCJmcm9tIiwiZmlsdGVyIiwic2VhcmNoIiwiT1JERVJfT0JKIiwiSlNPTiIsInBhcnNlIiwiQXJyYXkiLCJpc0FycmF5Iiwib3JkZXJCeSIsImNvbHVtbiIsImxpbWl0IiwicGFyc2VJbnQiLCJvZmZzZXQiLCJ0aGVuIiwiaG9va1Jlc3VsdCIsIk9iamVjdCIsImtleXMiLCJmb3JFYWNoIiwid2hlcmVJbiIsImNvbnNvbGUiLCJsb2ciLCJ0b1F1ZXJ5IiwicmVzdWx0cyIsImZyaWVuZGx5RGF0YSIsImFkZFZlcmJvc2VSZWxhdGVkRGF0YSIsInJlcXVpcmVtZW50c0NoZWNrIiwiUHJvbWlzZSIsImFsbCIsImNhdGNoIiwicmVxdWVzdGVkQ29sdW1ucyIsIndoZXJlIiwiaWQiLCJyZWxhdGlvblF1ZXJpZXMiLCJpbmNsdWRlUmVsYXRpb25zIiwiZ2V0UmVsYXRpb25RdWVyaWVzIiwibGVuZ3RoIiwibWVyZ2VSZWxhdGVkRGF0YSIsInR5cGUiLCJib2R5IiwiZGF0YSIsIkRhdGUiLCJpbnNlcnQiLCJ1cGRhdGUiLCJkZWwiLCJ0b1JlcXVlc3QiLCJDT0xVTU5TX1dJVEhfUkVMQVRJT05TIiwicm93IiwiaW5kZXgiLCJSRUxBVElPTl9UQUJMRV9OQU1FIiwiYWRkIiwidGFibGVOYW1lIiwicHVzaCIsInJlbGF0aW9uUmVzdWx0cyIsIk1BVENIRVIiLCJyZXF1ZXN0ZWRUYWJsZSIsIkZPUkVJR05fS0VZX0NPTFVNTiIsInJlbGF0aW9uUm93IiwiQ1VSUkVOVF9WQUxVRSIsIlZBTFVFX1RPX0RJU1BMQVkiLCJtYXAiLCJST1dfS0VZIiwidGFibGVDb25maWciLCJkYkluc3RhbmNlIiwicmVqZWN0IiwicmVzb2x2ZSIsInBhcmVudElkIiwicmVsYXRpb25zIiwibWFueVRvT25lIiwiTUFOWV9UT19PTkUiLCJLRVlTIiwiZ2V0UmVsYXRlZFJvdyJdLCJtYXBwaW5ncyI6Ijs7Ozs7OztBQUFBOztBQUNBOztBQUNBOztBQWNBOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0FBSUEsSUFBTUEsS0FBSyxHQUFHLG9CQUFNLDRCQUFOLENBQWQ7O0FBYUEsU0FBU0MsZ0JBQVQsQ0FBMEJDLFFBQTFCLEVBQXFEQyxVQUFyRCxFQUF5RjtBQUN2RixTQUFPO0FBQ0xDLElBQUFBLE1BQU0sRUFBRSxJQUFJQyxHQUFKLEVBREg7QUFFTEMsSUFBQUEsR0FBRyxFQUFFSixRQUFRLENBQUNJLEdBRlQ7QUFHTEMsSUFBQUEsT0FBTyxFQUFFTCxRQUFRLENBQUNLLE9BSGI7QUFJTEMsSUFBQUEsZ0JBQWdCLEVBQUVMO0FBSmIsR0FBUDtBQU1EOztJQUVLTSxlOzs7QUFDSiw2QkFBYztBQUFBOztBQUNaVCxJQUFBQSxLQUFLLENBQUMsU0FBRCxDQUFMO0FBQ0Q7Ozs7bUNBRXFCVSxHLEVBQWlCQyxHLEVBQWtCQyxJLEVBQW9CO0FBQzNFLFVBQU1DLFlBQVksR0FBRywyQkFBZUgsR0FBRyxDQUFDSSxNQUFKLENBQVdDLEtBQTFCLENBQXJCO0FBQ0EsVUFBTUMsTUFBTSxHQUFHO0FBQ2JDLFFBQUFBLE9BQU8sRUFB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Q3RFLFlBQVNDLEVBQWQsRUFBa0I7QUFDaEIsY0FBTSxJQUFJVixvQkFBSixDQUFrQixHQUFsQixFQUF1QixhQUF2QixDQUFOO0FBQ0Q7O0FBQ0QsVUFBTUksVUFBVSxHQUFHNEQsU0FBbkI7QUFDQSxVQUFNNUUsWUFBWSxHQUFHLDJCQUFlZ0IsVUFBZixDQUFyQjtBQUVBLFVBQU11QyxnQkFBZ0IsR0FBRyxzQ0FBMEJ2RCxZQUExQixFQUF3QyxRQUF4QyxFQUFrRDJCLE1BQWxELENBQ3ZCLFVBQUNRLE1BQUQ7QUFBQSxlQUFZQSxNQUFNLEtBQUs3QyxVQUF2QjtBQUFBLE9BRHVCLENBQXpCO0FBSUEsYUFBTytCLFlBQVNDLEVBQVQsQ0FBWUcsTUFBWixDQUFtQjhCLGdCQUFuQixFQUNKN0IsSUFESSxDQUNDa0QsU0FERCxFQUVKcEIsS0FGSSxDQUVFbEUsVUFGRixFQUVjcUcsUUFGZCxFQUV3QnBELElBRnhCLENBR0gsVUFBQ1MsT0FBRDtBQUFBLGVBQWM7QUFDWkEsVUFBQUEsT0FBTyxFQUFQQSxPQURZO0FBRVo0QixVQUFBQSxTQUFTLEVBQVRBO0FBRlksU0FBZDtBQUFBLE9BSEcsQ0FBUDtBQVFEOzs7NENBRXNEO0FBQUE7QUFBQSxVQUE3QjVCLE9BQTZCO0FBQUEsVUFBakI0QyxTQUFpQjs7QUFDckQsVUFBSUEsU0FBUyxJQUFJQSxTQUFTLENBQUMvQixNQUEzQixFQUFtQztBQUNqQytCLFFBQUFBLFNBQVMsQ0FBQ2pELE9BQVYsQ0FDRSxVQUFDdEQsUUFBRCxFQUFtRDtBQUNqRDJELFVBQUFBLE9BQU8sQ0FBQzNELFFBQVEsQ0FBQ3VGLFNBQVYsQ0FBUCxHQUE4QnZGLFFBQVEsQ0FBQzJELE9BQXZDO0FBQ0QsU0FISDtBQUtEOztBQUVELGFBQU9BLE9BQVA7QUFDRDs7Ozs7O2VBR1lwRCxlIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IGRhdGFiYXNlLCB7IERhdGFiYXNlIH0gZnJvbSAnQHJvb3QvYXBpL2RiJ1xuaW1wb3J0IHsgSHR0cEV4Y2VwdGlvbiwgSU1DUmVxdWVzdCwgSU1DUmVzcG9uc2UsIElVc2VyIH0gZnJvbSAnQHJvb3QvYXBpL3R5cGVzJ1xuaW1wb3J0IHtcbiAgYWRkVG9SZXNwb25zZSxcbiAgYXBwbHlRdWVyeUZpbHRlcnMsXG4gIGFwcGx5UXVlcnlTZWFyY2gsXG4gIGNhdGNoTWlkZGxld2FyZSxcbiAgZmlsdGVyVmlzaWJsZVRhYmxlQ29sdW1ucyxcbiAgZ2V0Q29sdW1uc1dpdGhSZWxhdGlvbnMsXG4gIGdldFRhYmxlQ29uZmlnLFxuICBoYXNBdXRob3JpemF0aW9uLFxuICBuZXh0QW5kUmV0dXJuLFxuICBydW5Ib29rXG59IGZyb20gJ0Byb290L2FwaS91dGlscydcbmltcG9ydCB7IElDb2x1bW5SZWxhdGlvbiwgSVRhYmxlSW5mbyB9IGZyb20gJ0Byb290L2NvbmZpZ0dlbmVyYXRvcidcbmltcG9ydCBCbHVlYmlyZCBmcm9tICdibHVlYmlyZCdcbmltcG9ydCBEZWJ1ZyBmcm9tICdkZWJ1ZydcbmltcG9ydCB7IE5leHRGdW5jdGlvbiwgUmVxdWVzdCB9IGZyb20gJ2V4cHJlc3MnXG5pbXBvcnQgS25leCBmcm9tICdrbmV4J1xuXG5jb25zdCBkZWJ1ZyA9IERlYnVnKCdmdW5mdW56bWM6Y29udHJvbGxlci10YWJsZScpXG5cbmludGVyZmFjZSBJVG9SZXF1ZXN0SXRlbSB7XG4gIHZhbHVlczogU2V0PG51bWJlcj4sXG4gIGtleTogc3RyaW5nLFxuICBkaXNwbGF5OiBzdHJpbmcsXG4gIGZvcmVpZ25LZXlDb2x1bW46IHN0cmluZ1xufVxuXG5pbnRlcmZhY2UgSVRvUmVxdWVzdCB7XG4gIFtrZXk6IHN0cmluZ106IElUb1JlcXVlc3RJdGVtLFxufVxuXG5mdW5jdGlvbiB0b1JlcXVlc3RCdWlsZGVyKHJlbGF0aW9uOiBJQ29sdW1uUmVsYXRpb24sIGNvbHVtbk5hbWU6IHN0cmluZyk6IElUb1JlcXVlc3RJdGVtIHtcbiAgcmV0dXJuIHtcbiAgICB2YWx1ZXM6IG5ldyBTZXQ8bnVtYmVyPigpLFxuICAgIGtleTogcmVsYXRpb24ua2V5LFxuICAgIGRpc3BsYXk6IHJlbGF0aW9uLmRpc3BsYXksXG4gICAgZm9yZWlnbktleUNvbHVtbjogY29sdW1uTmFtZSxcbiAgfVxufVxuXG5jbGFzcyBUYWJsZUNvbnRyb2xsZXIge1xuICBjb25zdHJ1Y3RvcigpIHtcbiAgICBkZWJ1ZygnQ3JlYXRlZCcpXG4gIH1cblxuICBwdWJsaWMgZ2V0VGFibGVDb25maWcocmVxOiBJTUNSZXF1ZXN0LCByZXM6IElNQ1Jlc3BvbnNlLCBuZXh0OiBOZXh0RnVuY3Rpb24pIHtcbiAgICBjb25zdCBUQUJMRV9DT05GSUcgPSBnZXRUYWJsZUNvbmZpZyhyZXEucGFyYW1zLnRhYmxlKVxuICAgIGNvbnN0IFJFU1VMVCA9IHtcbiAgICAgIGNvbHVtbnM6IFRBQkxFX0NPTkZJRy5jb2x1bW5zLFxuICAgICAgbmFtZTogVEFCTEVfQ09ORklHLm5hbWUsXG4gICAgICBwazogVEFCTEVfQ09ORklHLnBrLFxuICAgICAgdmVyYm9zZTogVEFCTEVfQ09ORklHLnZlcmJvc2UsXG4gICAgICBjaGlwczogVEFCTEVfQ09ORklHLmNoaXBzIHx8IFtdLFxuICAgICAgaXRlbVRpdGxlOiBUQUJMRV9DT05GSUcuaXRlbVRpdGxlLFxuICAgIH1cblxuICAgIGlmICghaGFzQXV0aG9yaXphdGlvbihUQUJMRV9DT05GSUcucm9sZXMsIHJlcS51c2VyKSkge1xuICAgICAgcmV0dXJuIGNhdGNoTWlkZGxld2FyZShuZXh0KShuZXcgSHR0cEV4Y2VwdGlvbig0MDEsICdOb3QgYXV0aG9yaXplZCcpKVxuICAgIH1cbiAgICBhZGRUb1Jlc3BvbnNlKHJlcywgJ3Jlc3VsdHMnKShSRVNVTFQpXG4gICAgcmV0dXJuIG5leHRBbmRSZXR1cm4obmV4dCkoUkVTVUxUKVxuICB9XG5cbiAgcHVibGljIGdldFRhYmxlRGF0YShyZXE6IElNQ1JlcXVlc3QsIHJlczogSU1DUmVzcG9uc2UsIG5leHQ6IE5leHRGdW5jdGlvbikge1xuICAgIGNvbnN0IFBBR0VfTlVNQkVSID0gcmVxLnF1ZXJ5LnBhZ2UgfHwgMFxuICAgIGNvbnN0IFRBQkxFX05BTUUgPSByZXEucGFyYW1zLnRhYmxlXG4gICAgY29uc3QgT1JERVIgPSByZXEucXVlcnkub3JkZXIgfHwgbnVsbFxuICAgIGNvbnN0IFRBQkxFX0NPTkZJRyA9IGdldFRhYmxlQ29uZmlnKFRBQkxFX05BTUUpXG4gICAgY29uc3QgQ09MVU1OUyA9IGZpbHRlclZpc2libGVUYWJsZUNvbHVtbnMoVEFCTEVfQ09ORklHLCAnbWFpbicpXG4gICAgbGV0IExJTUlUID0gMTBcblxuICAgIGlmICghaGFzQXV0aG9yaXphdGlvbihUQUJMRV9DT05GSUcucm9sZXMsIHJlcS51c2VyKSkge1xuICAgICAgcmV0dXJuIGNhdGNoTWlkZGxld2FyZShuZXh0KShuZXcgSHR0cEV4Y2VwdGlvbig0MDEsICdOb3QgYXV0aG9yaXplZCcpKVxuICAgIH1cbiAgICBpZiAoIWRhdGFiYXNlLmRiKSB7XG4gICAgICByZXR1cm4gY2F0Y2hNaWRkbGV3YXJlKG5leHQpKG5ldyBIdHRwRXhjZXB0aW9uKDUwMCwgJ05vIGRhdGFiYXNlJykpXG4gICAgfVxuICAgIGNvbnN0IERCID0gZGF0YWJhc2UuZGJcbiAgICBsZXQgUVVFUlkgPSBEQi5zZWxlY3QoQ09MVU1OUykuZnJvbShUQUJMRV9OQU1FKVxuICAgIGlmIChyZXEucXVlcnkuZmlsdGVyKSB7XG4gICAgICBRVUVSWSA9IGFwcGx5UXVlcnlGaWx0ZXJzKFFVRVJZLCByZXEucXVlcnkuZmlsdGVyLCBUQUJMRV9DT05GSUcpXG4gICAgfVxuXG4gICAgaWYgKHJlcS5xdWVyeS5zZWFyY2gpIHtcbiAgICAgIFFVRVJZID0gYXBwbHlRdWVyeVNlYXJjaChRVUVSWSwgcmVxLnF1ZXJ5LnNlYXJjaCwgVEFCTEVfQ09ORklHKVxuICAgIH1cblxuICAgIGlmIChPUkRFUikge1xuICAgICAgY29uc3QgT1JERVJfT0JKID0gSlNPTi5wYXJzZShPUkRFUilcbiAgICAgIGlmIChBcnJheS5pc0FycmF5KE9SREVSX09CSikpIHtcbiAgICAgICAgUVVFUlkub3JkZXJCeShPUkRFUl9PQkopXG4gICAgICB9IGVsc2Uge1xuICAgICAgICBRVUVSWS5vcmRlckJ5KE9SREVSX09CSi5jb2x1bW4sIE9SREVSX09CSi5vcmRlcilcbiAgICAgIH1cbiAgICB9XG5cbiAgICBpZiAocmVxLnF1ZXJ5LmxpbWl0KSB7XG4gICAgICBMSU1JVCA9IHBhcnNlSW50KHJlcS5xdWVyeS5saW1pdCwgMTApXG4gICAgfVxuICAgIGlmIChMSU1JVCA+IDApIHtcbiAgICAgIFFVRVJZLm9mZnNldCgoUEFHRV9OVU1CRVIpICogTElNSVQpLmxpbWl0KExJTUlUKVxuICAgIH1cblxuICAgIHJldHVybiBydW5Ib29rKFRBQkxFX0NPTkZJRywgJ2dldFRhYmxlRGF0YScsICdiZWZvcmUnLCByZXEsIHJlcywgZGF0YWJhc2UuZGIpLnRoZW4oXG4gICAgICAoaG9va1Jlc3VsdCkgPT4ge1xuICAgICAgICBpZiAoaG9va1Jlc3VsdCkge1xuICAgICAgICAgIGlmIChob29rUmVzdWx0LmZpbHRlcikge1xuICAgICAgICAgICAgT2JqZWN0LmtleXMoaG9va1Jlc3VsdC5maWx0ZXIpLmZvckVhY2goXG4gICAgICAgICAgICAgIChjb2x1bW4pID0+IHtcbiAgICAgICAgICAgICAgICBpZiAoQXJyYXkuaXNBcnJheShob29rUmVzdWx0LmZpbHRlcltjb2x1bW5dKSkge1xuICAgICAgICAgICAgICAgICAgUVVFUlkud2hlcmVJbihjb2x1bW4sIGhvb2tSZXN1bHQuZmlsdGVyW2NvbHVtbl0pXG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICB9XG4gICAgICAgICAgICApXG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIGNvbnNvbGUubG9nKFFVRVJZLnRvUXVlcnkoKSlcbiAgICAgICAgcmV0dXJuIFFVRVJZXG4gICAgICB9XG4gICAgKS50aGVuKFxuICAgICAgKHJlc3VsdHMpID0+IHtcbiAgICAgICAgaWYgKHJlcS5xdWVyeS5mcmllbmRseURhdGEpIHtcbiAgICAgICAgICByZXR1cm4gdGhpcy5hZGRWZXJib3NlUmVsYXRlZERhdGEocmVzdWx0cywgVEFCTEVfQ09ORklHLCBEQilcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gcmVzdWx0c1xuICAgICAgfVxuICAgICkudGhlbihcbiAgICAgIChyZXN1bHRzKSA9PiB7XG4gICAgICAgIHJldHVybiBydW5Ib29rKFRBQkxFX0NPTkZJRywgJ2dldFRhYmxlRGF0YScsICdhZnRlcicsIHJlcSwgcmVzLCBkYXRhYmFzZS5kYiwgcmVzdWx0cylcbiAgICAgIH1cbiAgICApLnRoZW4oXG4gICAgICBhZGRUb1Jlc3BvbnNlKHJlcywgJ3Jlc3VsdHMnKVxuICAgICkudGhlbihcbiAgICAgIG5leHRBbmRSZXR1cm4obmV4dClcbiAgICApXG4gIH1cblxuICBwdWJsaWMgZ2V0VGFibGVDb3VudChyZXE6IElNQ1JlcXVlc3QsIHJlczogSU1DUmVzcG9uc2UsIG5leHQ6IE5leHRGdW5jdGlvbikge1xuICAgIGNvbnN0IFRBQkxFX05BTUUgPSByZXEucGFyYW1zLnRhYmxlXG4gICAgY29uc3QgVEFCTEVfQ09ORklHID0gZ2V0VGFibGVDb25maWcoVEFCTEVfTkFNRSlcblxuICAgIHJldHVybiB0aGlzLnJlcXVpcmVtZW50c0NoZWNrKFRBQkxFX0NPTkZJRywgcmVxLnVzZXIsIGRhdGFiYXNlLCBuZXh0KS50aGVuKFxuICAgICAgKERCKSA9PiB7XG4gICAgICAgIGxldCBRVUVSWSA9IERCKFRBQkxFX05BTUUpLnNlbGVjdCgnKicpXG4gICAgICAgIGlmIChyZXEucXVlcnkuc2VhcmNoKSB7XG4gICAgICAgICAgUVVFUlkgPSBhcHBseVF1ZXJ5U2VhcmNoKFFVRVJZLCByZXEucXVlcnkuc2VhcmNoLCBUQUJMRV9DT05GSUcpXG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIFByb21pc2UuYWxsKFtEQiwgUVVFUlldKVxuICAgICAgfVxuICAgICkudGhlbihcbiAgICAgIChbREIsIHJlc3VsdHNdKSA9PiB7XG4gICAgICAgIHJldHVybiBydW5Ib29rKFRBQkxFX0NPTkZJRywgJ2dldFRhYmxlQ291bnQnLCAnYWZ0ZXInLCByZXEsIHJlcywgREIsIHJlc3VsdHMpXG4gICAgICB9XG4gICAgKS50aGVuKFxuICAgICAgYWRkVG9SZXNwb25zZShyZXMsICdjb3VudCcpXG4gICAgKS50aGVuKFxuICAgICAgbmV4dEFuZFJldHVybihuZXh0KVxuICAgICkuY2F0Y2goXG4gICAgICBjYXRjaE1pZGRsZXdhcmUobmV4dClcbiAgICApXG4gIH1cblxuICBwdWJsaWMgZ2V0Um93KHJlcTogSU1DUmVxdWVzdCwgcmVzOiBJTUNSZXNwb25zZSwgbmV4dDogTmV4dEZ1bmN0aW9uKSB7XG4gICAgY29uc3QgVEFCTEVfTkFNRSA9IHJlcS5wYXJhbXMudGFibGVcbiAgICBjb25zdCBUQUJMRV9DT05GSUcgPSBnZXRUYWJsZUNvbmZpZyhUQUJMRV9OQU1FKVxuXG4gICAgcmV0dXJuIHRoaXMucmVxdWlyZW1lbnRzQ2hlY2soVEFCTEVfQ09ORklHLCByZXEudXNlciwgZGF0YWJhc2UsIG5leHQpLnRoZW4oXG4gICAgICAoREIpID0+IHtcbiAgICAgICAgY29uc3QgcmVxdWVzdGVkQ29sdW1ucyA9IGZpbHRlclZpc2libGVUYWJsZUNvbHVtbnMoVEFCTEVfQ09ORklHLCAnZGV0YWlsJylcblxuICAgICAgICByZXR1cm4gREIuc2VsZWN0KHJlcXVlc3RlZENvbHVtbnMpXG4gICAgICAgICAgLmZyb20oYCR7cmVxLnBhcmFtcy50YWJsZX1gKVxuICAgICAgICAgIC53aGVyZSgnaWQnLCByZXEucGFyYW1zLmlkKVxuICAgICAgfVxuICAgICkudGhlbihcbiAgICAgIChyZXN1bHRzKSA9PiB7XG4gICAgICAgIGxldCByZWxhdGlvblF1ZXJpZXM6IEFycmF5PEJsdWViaXJkPHt9Pj4gPSBbXVxuICAgICAgICBpZiAocmVxLnF1ZXJ5LmluY2x1ZGVSZWxhdGlvbnMpIHtcbiAgICAgICAgICByZWxhdGlvblF1ZXJpZXMgPSB0aGlzLmdldFJlbGF0aW9uUXVlcmllcyhUQUJMRV9DT05GSUcsIHJlc3VsdHNbMF0uaWQpXG4gICAgICAgIH1cblxuICAgICAgICBpZiAocmVsYXRpb25RdWVyaWVzLmxlbmd0aCkge1xuICAgICAgICAgIHJldHVybiBQcm9taXNlLmFsbChbXG4gICAgICAgICAgICByZXN1bHRzWzBdLFxuICAgICAgICAgICAgLi4ucmVsYXRpb25RdWVyaWVzLFxuICAgICAgICAgIF0pXG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gUHJvbWlzZS5hbGwoW1xuICAgICAgICAgIHJlc3VsdHNbMF0sXG4gICAgICAgIF0pXG4gICAgICB9XG4gICAgKS50aGVuKFxuICAgICAgdGhpcy5tZXJnZVJlbGF0ZWREYXRhXG4gICAgKS50aGVuKFxuICAgICAgKHJlc3VsdHMpID0+IHtcbiAgICAgICAgcmV0dXJuIHJ1bkhvb2soVEFCTEVfQ09ORklHLCAnZ2V0Um93JywgJ2FmdGVyJywgcmVxLCByZXMsIGRhdGFiYXNlLmRiLCByZXN1bHRzKVxuICAgICAgfVxuICAgICkudGhlbihcbiAgICAgIGFkZFRvUmVzcG9uc2UocmVzLCAncmVzdWx0cycpXG4gICAgKS50aGVuKFxuICAgICAgbmV4dEFuZFJldHVybihuZXh0KVxuICAgICkuY2F0Y2goXG4gICAgICBjYXRjaE1pZGRsZXdhcmUobmV4dClcbiAgICApXG4gIH1cblxuICBwdWJsaWMgaW5zZXJ0Um93KHJlcTogSU1DUmVxdWVzdCwgcmVzOiBJTUNSZXNwb25zZSwgbmV4dDogTmV4dEZ1bmN0aW9uKSB7XG4gICAgY29uc3QgVEFCTEVfTkFNRSA9IHJlcS5wYXJhbXMudGFibGVcbiAgICBjb25zdCBUQUJMRV9DT05GSUcgPSBnZXRUYWJsZUNvbmZpZyhUQUJMRV9OQU1FKVxuXG4gICAgcmV0dXJuIHRoaXMucmVxdWlyZW1lbnRzQ2hlY2soVEFCTEVfQ09ORklHLCByZXEudXNlciwgZGF0YWJhc2UsIG5leHQpLnRoZW4oXG4gICAgICAoREIpID0+IHtcbiAgICAgICAgVEFCTEVfQ09ORklHLmNvbHVtbnMuZm9yRWFjaChcbiAgICAgICAgICAoY29sdW1uKSA9PiB7XG4gICAgICAgICAgICBpZiAoY29sdW1uLnR5cGUgPT09ICdkYXRldGltZScpIHtcbiAgICAgICAgICAgICAgcmVxLmJvZHkuZGF0YVtjb2x1bW4ubmFtZV0gPSBuZXcgRGF0ZShyZXEuYm9keS5kYXRhW2NvbHVtbi5uYW1lXSB8fCBudWxsKVxuICAgICAgICAgICAgfSBlbHNlIGlmIChjb2x1bW4udHlwZSA9PT0gJ3RpbnlpbnQoMSknKSB7XG4gICAgICAgICAgICAgIHJlcS5ib2R5LmRhdGFbY29sdW1uLm5hbWVdID0gY29sdW1uLnR5cGUgPyAxIDogMFxuICAgICAgICAgICAgfVxuICAgICAgICAgIH1cbiAgICAgICAgKVxuICAgICAgICByZXR1cm4gREIocmVxLnBhcmFtcy50YWJsZSkuaW5zZXJ0KHJlcS5ib2R5LmRhdGEpXG4gICAgICB9XG4gICAgKS50aGVuKFxuICAgICAgKHJlc3VsdHMpID0+IHtcbiAgICAgICAgcmV0dXJuIHJ1bkhvb2soVEFCTEVfQ09ORklHLCAnaW5zZXJ0Um93JywgJ2FmdGVyJywgcmVxLCByZXMsIGRhdGFiYXNlLmRiLCByZXN1bHRzKVxuICAgICAgfVxuICAgICkudGhlbihcbiAgICAgIChyZXN1bHRzKSA9PiB7XG4gICAgICAgIGFkZFRvUmVzcG9uc2UocmVzLCAncmVzdWx0cycpKHJlc3VsdHMpXG4gICAgICB9XG4gICAgKS50aGVuKFxuICAgICAgbmV4dEFuZFJldHVybihuZXh0KVxuICAgICkuY2F0Y2goXG4gICAgICBjYXRjaE1pZGRsZXdhcmUobmV4dClcbiAgICApXG4gIH1cblxuICBwdWJsaWMgdXBkYXRlUm93KHJlcTogSU1DUmVxdWVzdCwgcmVzOiBJTUNSZXNwb25zZSwgbmV4dDogTmV4dEZ1bmN0aW9uKSB7XG4gICAgY29uc3QgVEFCTEVfTkFNRSA9IHJlcS5wYXJhbXMudGFibGVcbiAgICBjb25zdCBUQUJMRV9DT05GSUcgPSBnZXRUYWJsZUNvbmZpZyhUQUJMRV9OQU1FKVxuXG4gICAgcmV0dXJuIHRoaXMucmVxdWlyZW1lbnRzQ2hlY2soVEFCTEVfQ09ORklHLCByZXEudXNlciwgZGF0YWJhc2UsIG5leHQpLnRoZW4oXG4gICAgICAoREIpID0+IHtcbiAgICAgICAgVEFCTEVfQ09ORklHLmNvbHVtbnMuZm9yRWFjaChcbiAgICAgICAgICAoY29sdW1uKSA9PiB7XG4gICAgICAgICAgICBpZiAoY29sdW1uLnR5cGUgPT09ICdkYXRldGltZScpIHtcbiAgICAgICAgICAgICAgcmVxLmJvZHkuZGF0YVtjb2x1bW4ubmFtZV0gPSBuZXcgRGF0ZShyZXEuYm9keS5kYXRhW2NvbHVtbi5uYW1lXSB8fCBudWxsKVxuICAgICAgICAgICAgfVxuICAgICAgICAgIH1cbiAgICAgICAgKVxuXG4gICAgICAgIHJldHVybiBEQihUQUJMRV9OQU1FKS53aGVyZSgnaWQnLCByZXEucGFyYW1zLmlkKS51cGRhdGUocmVxLmJvZHkuZGF0YSlcbiAgICAgIH1cbiAgICApLnRoZW4oXG4gICAgICAocmVzdWx0cykgPT4ge1xuICAgICAgICByZXR1cm4gcnVuSG9vayhUQUJMRV9DT05GSUcsICd1cGRhdGVSb3cnLCAnYWZ0ZXInLCByZXEsIHJlcywgZGF0YWJhc2UuZGIsIHJlc3VsdHMpXG4gICAgICB9XG4gICAgKS50aGVuKFxuICAgICAgYWRkVG9SZXNwb25zZShyZXMsICdyZXN1bHRzJylcbiAgICApLnRoZW4oXG4gICAgICBuZXh0QW5kUmV0dXJuKG5leHQpXG4gICAgKS5jYXRjaChcbiAgICAgIGNhdGNoTWlkZGxld2FyZShuZXh0KVxuICAgIClcbiAgfVxuXG4gIHB1YmxpYyBkZWxldGVSb3cocmVxOiBJTUNSZXF1ZXN0LCByZXM6IElNQ1Jlc3BvbnNlLCBuZXh0OiBOZXh0RnVuY3Rpb24pIHtcbiAgICBjb25zdCBUQUJMRV9OQU1FID0gcmVxLnBhcmFtcy50YWJsZVxuICAgIGNvbnN0IFRBQkxFX0NPTkZJRyA9IGdldFRhYmxlQ29uZmlnKFRBQkxFX05BTUUpXG5cbiAgICByZXR1cm4gdGhpcy5yZXF1aXJlbWVudHNDaGVjayhUQUJMRV9DT05GSUcsIHJlcS51c2VyLCBkYXRhYmFzZSwgbmV4dCkudGhlbihcbiAgICAgIChEQikgPT4ge1xuICAgICAgICByZXR1cm4gREIoVEFCTEVfTkFNRSkud2hlcmUoJ2lkJywgcmVxLnBhcmFtcy5pZCkuZGVsKClcbiAgICAgIH1cbiAgICApLnRoZW4oXG4gICAgICAocmVzdWx0cykgPT4ge1xuICAgICAgICByZXR1cm4gcnVuSG9vayhUQUJMRV9DT05GSUcsICdkZWxldGVSb3cnLCAnYWZ0ZXInLCByZXEsIHJlcywgZGF0YWJhc2UuZGIsIHJlc3VsdHMpXG4gICAgICB9XG4gICAgKS50aGVuKFxuICAgICAgYWRkVG9SZXNwb25zZShyZXMsICdyZXN1bHRzJylcbiAgICApLnRoZW4oXG4gICAgICBuZXh0QW5kUmV0dXJuKG5leHQpXG4gICAgKS5jYXRjaChcbiAgICAgIGNhdGNoTWlkZGxld2FyZShuZXh0KVxuICAgIClcbiAgfVxuXG4gIHByaXZhdGUgYWRkVmVyYm9zZVJlbGF0ZWREYXRhKHJlc3VsdHM6IGFueVtdLCBUQUJMRV9DT05GSUc6IElUYWJsZUluZm8sIERCOiBLbmV4KSB7XG4gICAgY29uc3QgdG9SZXF1ZXN0OiBJVG9SZXF1ZXN0ID0ge31cbiAgICBjb25zdCBDT0xVTU5TX1dJVEhfUkVMQVRJT05TID0gZ2V0Q29sdW1uc1dpdGhSZWxhdGlvbnMoVEFCTEVfQ09ORklHKVxuICAgIHJlc3VsdHMuZm9yRWFjaChcbiAgICAgIChyb3c6IGFueSwgaW5kZXg6IG51bWJlcikgPT4ge1xuICAgICAgICBDT0xVTU5TX1dJVEhfUkVMQVRJT05TLmZvckVhY2goXG4gICAgICAgICAgKGNvbHVtbikgPT4ge1xuICAgICAgICAgICAgaWYgKCFjb2x1bW4ucmVsYXRpb24pIHtcbiAgICAgICAgICAgICAgdGhyb3cgbmV3IEh0dHBFeGNlcHRpb24oNTAwLCAnQ29sdW1uIHNob3VsZCBoYXZlIGEgcmVsYXRpb24nKVxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgY29uc3QgUkVMQVRJT05fVEFCTEVfTkFNRSA9IGNvbHVtbi5yZWxhdGlvbi50YWJsZVxuXG4gICAgICAgICAgICBpZiAoIXRvUmVxdWVzdFtSRUxBVElPTl9UQUJMRV9OQU1FXSkge1xuICAgICAgICAgICAgICB0b1JlcXVlc3RbUkVMQVRJT05fVEFCTEVfTkFNRV0gPSB0b1JlcXVlc3RCdWlsZGVyKGNvbHVtbi5yZWxhdGlvbiwgY29sdW1uLm5hbWUpXG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIHRvUmVxdWVzdFtSRUxBVElPTl9UQUJMRV9OQU1FXS52YWx1ZXMuYWRkKHJvd1tjb2x1bW4ubmFtZV0pXG4gICAgICAgICAgfVxuICAgICAgICApXG4gICAgICB9XG4gICAgKVxuXG4gICAgY29uc3QgcmVsYXRpb25RdWVyaWVzOiBLbmV4LlF1ZXJ5QnVpbGRlcltdID0gW11cbiAgICBPYmplY3Qua2V5cyh0b1JlcXVlc3QpLmZvckVhY2goXG4gICAgICAodGFibGVOYW1lKSA9PiB7XG4gICAgICAgIHJlbGF0aW9uUXVlcmllcy5wdXNoKFxuICAgICAgICAgIERCLnNlbGVjdCh0b1JlcXVlc3RbdGFibGVOYW1lXS5kaXNwbGF5LCB0b1JlcXVlc3RbdGFibGVOYW1lXS5rZXkpXG4gICAgICAgICAgICAuZnJvbSh0YWJsZU5hbWUpXG4gICAgICAgICAgICAud2hlcmVJbih0b1JlcXVlc3RbdGFibGVOYW1lXS5rZXksIEFycmF5LmZyb20odG9SZXF1ZXN0W3RhYmxlTmFtZV0udmFsdWVzLnZhbHVlcygpKSlcbiAgICAgICAgKVxuICAgICAgfVxuICAgIClcblxuICAgIHJldHVybiBQcm9taXNlLmFsbDxhbnlbXT4ocmVsYXRpb25RdWVyaWVzKS50aGVuKFxuICAgICAgKHJlbGF0aW9uUmVzdWx0cykgPT4ge1xuICAgICAgICBjb25zdCBNQVRDSEVSOiB7XG4gICAgICAgICAgW2ZvcmVpZ25LZXlDb2x1bW46IHN0cmluZ106IHtcbiAgICAgICAgICAgIFt2YWx1ZTogc3RyaW5nXTogc3RyaW5nXG4gICAgICAgICAgfVxuICAgICAgICB9ID0ge31cbiAgICAgICAgT2JqZWN0LnZhbHVlcyh0b1JlcXVlc3QpLmZvckVhY2goXG4gICAgICAgICAgKHJlcXVlc3RlZFRhYmxlLCBpbmRleCkgPT4ge1xuICAgICAgICAgICAgY29uc3QgRk9SRUlHTl9LRVlfQ09MVU1OID0gcmVxdWVzdGVkVGFibGUuZm9yZWlnbktleUNvbHVtblxuICAgICAgICAgICAgTUFUQ0hFUltGT1JFSUdOX0tFWV9DT0xVTU5dID0ge31cbiAgICAgICAgICAgIHJlbGF0aW9uUmVzdWx0c1tpbmRleF0uZm9yRWFjaChcbiAgICAgICAgICAgICAgKHJlbGF0aW9uUm93OiBhbnkpID0+IHtcbiAgICAgICAgICAgICAgICBjb25zdCBDVVJSRU5UX1ZBTFVFID0gcmVsYXRpb25Sb3dbcmVxdWVzdGVkVGFibGUua2V5XVxuICAgICAgICAgICAgICAgIGNvbnN0IFZBTFVFX1RPX0RJU1BMQVkgPSByZWxhdGlvblJvd1tyZXF1ZXN0ZWRUYWJsZS5kaXNwbGF5XVxuICAgICAgICAgICAgICAgIE1BVENIRVJbRk9SRUlHTl9LRVlfQ09MVU1OXVtDVVJSRU5UX1ZBTFVFXSA9IFZBTFVFX1RPX0RJU1BMQVlcbiAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgKVxuICAgICAgICAgIH1cbiAgICAgICAgKVxuICAgICAgICByZXR1cm4gcmVzdWx0cy5tYXAoXG4gICAgICAgICAgKHJvdzogYW55KSA9PiB7XG4gICAgICAgICAgICBPYmplY3QudmFsdWVzKHRvUmVxdWVzdCkuZm9yRWFjaChcbiAgICAgICAgICAgICAgKHJlcXVlc3RlZFRhYmxlKSA9PiB7XG4gICAgICAgICAgICAgICAgY29uc3QgUk9XX0tFWSA9IHJlcXVlc3RlZFRhYmxlLmZvcmVpZ25LZXlDb2x1bW5cbiAgICAgICAgICAgICAgICByb3dbUk9XX0tFWV0gPSBNQVRDSEVSW1JPV19LRVldW3Jvd1tST1dfS0VZXV1cbiAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgKVxuICAgICAgICAgICAgcmV0dXJuIHJvd1xuICAgICAgICAgIH1cbiAgICAgICAgKVxuICAgICAgfVxuICAgIClcbiAgfVxuXG4gIHByaXZhdGUgcmVxdWlyZW1lbnRzQ2hlY2soXG4gICAgdGFibGVDb25maWc6IElUYWJsZUluZm8sXG4gICAgdXNlcjogSVVzZXIgfCB1bmRlZmluZWQsXG4gICAgZGJJbnN0YW5jZTogRGF0YWJhc2UsXG4gICAgbmV4dDogKHBhcmFtPzogYW55KSA9PiB2b2lkXG4gICkge1xuICAgIGlmICghaGFzQXV0aG9yaXphdGlvbih0YWJsZUNvbmZpZy5yb2xlcywgdXNlcikpIHtcbiAgICAgIHJldHVybiBQcm9taXNlLnJlamVjdChuZXcgSHR0cEV4Y2VwdGlvbig0MDEsICdOb3QgYXV0aG9yaXplZCcpKVxuICAgIH1cbiAgICBpZiAoIWRiSW5zdGFuY2UuZGIpIHtcbiAgICAgIHJldHVybiBjYXRjaE1pZGRsZXdhcmUobmV4dCkobmV3IEh0dHBFeGNlcHRpb24oNTAwLCAnTm8gZGF0YWJhc2UnKSlcbiAgICB9XG4gICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZShkYkluc3RhbmNlLmRiKVxuICB9XG5cbiAgcHJpdmF0ZSBnZXRSZWxhdGlvblF1ZXJpZXMoVEFCTEVfQ09ORklHOiBJVGFibGVJbmZvLCBwYXJlbnRJZDogYW55KSB7XG4gICAgY29uc3QgcmVsYXRpb25RdWVyaWVzOiBBcnJheTxCbHVlYmlyZDx7fT4+ID0gW11cbiAgICBpZiAoVEFCTEVfQ09ORklHLnJlbGF0aW9ucyAmJiBUQUJMRV9DT05GSUcucmVsYXRpb25zLm1hbnlUb09uZSkge1xuICAgICAgY29uc3QgTUFOWV9UT19PTkUgPSBUQUJMRV9DT05GSUcucmVsYXRpb25zLm1hbnlUb09uZVxuICAgICAgY29uc3QgS0VZUzogc3RyaW5nW10gPSBPYmplY3Qua2V5cyhNQU5ZX1RPX09ORSlcbiAgICAgIEtFWVMuZm9yRWFjaChcbiAgICAgICAgKHRhYmxlTmFtZSkgPT4ge1xuICAgICAgICAgIHJlbGF0aW9uUXVlcmllcy5wdXNoKFxuICAgICAgICAgICAgdGhpcy5nZXRSZWxhdGVkUm93KFxuICAgICAgICAgICAgICB0YWJsZU5hbWUsXG4gICAgICAgICAgICAgIE1BTllfVE9fT05FW3RhYmxlTmFtZV0sXG4gICAgICAgICAgICAgIHBhcmVudElkXG4gICAgICAgICAgICApXG4gICAgICAgICAgKVxuICAgICAgICB9XG4gICAgICApXG4gICAgfVxuXG4gICAgcmV0dXJuIHJlbGF0aW9uUXVlcmllc1xuICB9XG5cbiAgcHJpdmF0ZSBnZXRSZWxhdGVkUm93KHRhYmxlTmFtZTogc3RyaW5nLCBjb2x1bW5OYW1lOiBzdHJpbmcsIHBhcmVudElkOiBhbnkpIHtcbiAgICBpZiAoIWRhdGFiYXNlLmRiKSB7XG4gICAgICB0aHJvdyBuZXcgSHR0cEV4Y2VwdGlvbig1MDAsICdObyBkYXRhYmFzZScpXG4gICAgfVxuICAgIGNvbnN0IFRBQkxFX05BTUUgPSB0YWJsZU5hbWVcbiAgICBjb25zdCBUQUJMRV9DT05GSUcgPSBnZXRUYWJsZUNvbmZpZyhUQUJMRV9OQU1FKVxuXG4gICAgY29uc3QgcmVxdWVzdGVkQ29sdW1ucyA9IGZpbHRlclZpc2libGVUYWJsZUNvbHVtbnMoVEFCTEVfQ09ORklHLCAnZGV0YWlsJykuZmlsdGVyKFxuICAgICAgKGNvbHVtbikgPT4gY29sdW1uICE9PSBjb2x1bW5OYW1lXG4gICAgKVxuXG4gICAgcmV0dXJuIGRhdGFiYXNlLmRiLnNlbGVjdChyZXF1ZXN0ZWRDb2x1bW5zKVxuICAgICAgLmZyb20odGFibGVOYW1lKVxuICAgICAgLndoZXJlKGNvbHVtbk5hbWUsIHBhcmVudElkKS50aGVuKFxuICAgICAgICAocmVzdWx0cykgPT4gKHtcbiAgICAgICAgICByZXN1bHRzLFxuICAgICAgICAgIHRhYmxlTmFtZSxcbiAgICAgICAgfSlcbiAgICAgIClcbiAgfVxuXG4gIHByaXZhdGUgbWVyZ2VSZWxhdGVkRGF0YShbcmVzdWx0cywgLi4ucmVsYXRpb25zXTogYW55KSB7XG4gICAgaWYgKHJlbGF0aW9ucyAmJiByZWxhdGlvbnMubGVuZ3RoKSB7XG4gICAgICByZWxhdGlvbnMuZm9yRWFjaChcbiAgICAgICAgKHJlbGF0aW9uOiB7dGFibGVOYW1lOiBzdHJpbmcsIHJlc3VsdHM6IGFueVtdfSkgPT4ge1xuICAgICAgICAgIHJlc3VsdHNbcmVsYXRpb24udGFibGVOYW1lXSA9IHJlbGF0aW9uLnJlc3VsdHNcbiAgICAgICAgfVxuICAgICAgKVxuICAgIH1cblxuICAgIHJldHVybiByZXN1bHRzXG4gIH1cbn1cblxuZXhwb3J0IGRlZmF1bHQgVGFibGVDb250cm9sbGVyXG4iXX0=