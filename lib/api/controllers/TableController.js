"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _db = _interopRequireDefault(require("../db"));

var _types = require("../types");

var _utils = require("../utils");

var _debug = _interopRequireDefault(require("debug"));

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

function _toArray(arr) { return _arrayWithHoles(arr) || _iterableToArray(arr) || _nonIterableRest(); }

function _nonIterableRest() { throw new TypeError("Invalid attempt to destructure non-iterable instance"); }

function _arrayWithHoles(arr) { if (Array.isArray(arr)) return arr; }

function _toConsumableArray(arr) { return _arrayWithoutHoles(arr) || _iterableToArray(arr) || _nonIterableSpread(); }

function _nonIterableSpread() { throw new TypeError("Invalid attempt to spread non-iterable instance"); }

function _iterableToArray(iter) { if (Symbol.iterator in Object(iter) || Object.prototype.toString.call(iter) === "[object Arguments]") return Array.from(iter); }

function _arrayWithoutHoles(arr) { if (Array.isArray(arr)) { for (var i = 0, arr2 = new Array(arr.length); i < arr.length; i++) { arr2[i] = arr[i]; } return arr2; } }

function _classCallCheck(instance, Constructor) { if (!(instance instanceof Constructor)) { throw new TypeError("Cannot call a class as a function"); } }

function _defineProperties(target, props) { for (var i = 0; i < props.length; i++) { var descriptor = props[i]; descriptor.enumerable = descriptor.enumerable || false; descriptor.configurable = true; if ("value" in descriptor) descriptor.writable = true; Object.defineProperty(target, descriptor.key, descriptor); } }

function _createClass(Constructor, protoProps, staticProps) { if (protoProps) _defineProperties(Constructor.prototype, protoProps); if (staticProps) _defineProperties(Constructor, staticProps); return Constructor; }

var debug = (0, _debug.default)('funfunzmc:controller-table');

function toRequestBuilder(relation, columnName) {
  return {
    values: new Set(),
    key: relation.key,
    display: relation.display,
    foreignKeyColumn: columnName
  };
}

var TableController =
/*#__PURE__*/
function () {
  function TableController() {
    _classCallCheck(this, TableController);

    debug('Created');
  }

  _createClass(TableController, [{
    key: "getTableConfig",
    value: function getTableConfig(req, res, next) {
      var TABLE_CONFIG = (0, _utils.getTableConfig)(req.params.table);
      var RESULT = {
        columns: TABLE_CONFIG.columns,
        name: TABLE_CONFIG.name,
        pk: TABLE_CONFIG.pk,
        verbose: TABLE_CONFIG.verbose
      };

      if ((0, _utils.hasAuthorization)(TABLE_CONFIG.roles, req.user)) {
        (0, _utils.addToResponse)(res, 'results')(RESULT);
        return (0, _utils.nextAndReturn)(next)(RESULT);
      } else {
        return (0, _utils.catchMiddleware)(next)(new _types.HttpException(401, 'Not authorized'));
      }
    }
  }, {
    key: "getTableData",
    value: function getTableData(req, res, next) {
      var _this = this;

      var PAGE_NUMBER = req.query.page || 0;
      var TABLE_NAME = req.params.table;
      var TABLE_CONFIG = (0, _utils.getTableConfig)(TABLE_NAME);
      var COLUMNS = (0, _utils.filterVisibleTableColumns)(TABLE_CONFIG, 'main');
      var LIMIT = 10;

      if (req.query.limit) {
        LIMIT = parseInt(req.query.limit, 10);
      }

      if (!(0, _utils.hasAuthorization)(TABLE_CONFIG.roles, req.user)) {
        return (0, _utils.catchMiddleware)(next)(new _types.HttpException(401, 'Not authorized'));
      }

      if (!_db.default.db) {
        return (0, _utils.catchMiddleware)(next)(new _types.HttpException(500, 'No database'));
      }

      var DB = _db.default.db;
      var QUERY = DB.select(COLUMNS).from(TABLE_NAME);

      if (req.query.filter) {
        QUERY = (0, _utils.applyQueryFilters)(QUERY, req.query.filter, TABLE_CONFIG);
      }

      return QUERY.offset(PAGE_NUMBER * LIMIT).limit(LIMIT).then(function (results) {
        if (req.query.friendlyData) {
          return _this.addVerboseRelatedData(results, TABLE_CONFIG, DB);
        }

        return results;
      }).then(function (results) {
        return (0, _utils.runHook)(TABLE_CONFIG, 'getTableData', 'after', req, res, _db.default.db, results);
      }).then((0, _utils.addToResponse)(res, 'results')).then((0, _utils.nextAndReturn)(next));
    }
  }, {
    key: "getTableCount",
    value: function getTableCount(req, res, next) {
      var TABLE_NAME = req.params.table;
      var TABLE_CONFIG = (0, _utils.getTableConfig)(TABLE_NAME);

      if (!(0, _utils.hasAuthorization)(TABLE_CONFIG.roles, req.user)) {
        return (0, _utils.catchMiddleware)(next)(new _types.HttpException(401, 'Not authorized'));
      } else {
        if (!_db.default.db) {
          return (0, _utils.catchMiddleware)(next)(new _types.HttpException(500, 'No database'));
        } else {
          return _db.default.db.select('*').from(TABLE_NAME).then(function (results) {
            (0, _utils.runHook)(TABLE_CONFIG, 'getTableCount', 'after', req, res, _db.default.db, results).then((0, _utils.addToResponse)(res, 'count')).then((0, _utils.nextAndReturn)(next));
          });
        }
      }
    }
  }, {
    key: "getRow",
    value: function getRow(req, res, next) {
      var _this2 = this;

      var TABLE_NAME = req.params.table;
      var TABLE_CONFIG = (0, _utils.getTableConfig)(TABLE_NAME);

      if (!(0, _utils.hasAuthorization)(TABLE_CONFIG.roles, req.user)) {
        return (0, _utils.catchMiddleware)(next)(new _types.HttpException(401, 'Not authorized'));
      } else {
        if (!_db.default.db) {
          return (0, _utils.catchMiddleware)(next)(new _types.HttpException(500, 'No database'));
        } else {
          var requestedColumns = (0, _utils.filterVisibleTableColumns)(TABLE_CONFIG, 'detail');

          var query = _db.default.db.select(requestedColumns).from("".concat(req.params.table)).where("id", req.params.id);

          return query.then(function (results) {
            var relationQueries = [];

            if (req.query.includeRelations) {
              relationQueries = _this2.getRelationQueries(TABLE_CONFIG, results[0].id);
            }

            if (relationQueries.length) {
              return Promise.all([results[0]].concat(_toConsumableArray(relationQueries)));
            }

            return Promise.all([results[0]]);
          }).then(this.mergeRelatedData).then((0, _utils.addToResponse)(res, 'result')).then((0, _utils.nextAndReturn)(next));
        }
      }
    }
  }, {
    key: "insertRow",
    value: function insertRow(req, res, next) {
      if (!_db.default.db) {
        return (0, _utils.catchMiddleware)(next)(new _types.HttpException(500, 'No database'));
      } else {
        return _db.default.db(req.params.table).insert(req.body.data).then((0, _utils.addToResponse)(res, 'results')).then((0, _utils.nextAndReturn)(next));
      }
    }
  }, {
    key: "updateRow",
    value: function updateRow(req, res, next) {
      if (!_db.default.db) {
        return (0, _utils.catchMiddleware)(next)(new _types.HttpException(500, 'No database'));
      } else {
        return _db.default.db(req.body.table).where('id', req.body.id).update(req.body.data).then((0, _utils.addToResponse)(res, 'results')).then((0, _utils.nextAndReturn)(next));
      }
    }
  }, {
    key: "deleteRow",
    value: function deleteRow(req, res, next) {
      if (!_db.default.db) {
        return (0, _utils.catchMiddleware)(next)(new _types.HttpException(500, 'No database'));
      } else {
        return _db.default.db(req.params.table).where('id', req.params.id).del().then((0, _utils.addToResponse)(res, 'results')).then((0, _utils.nextAndReturn)(next));
      }
    }
  }, {
    key: "addVerboseRelatedData",
    value: function addVerboseRelatedData(results, TABLE_CONFIG, DB) {
      var toRequest = {};
      var COLUMNS_WITH_RELATIONS = (0, _utils.getColumnsWithRelations)(TABLE_CONFIG);
      results.forEach(function (row, index) {
        COLUMNS_WITH_RELATIONS.forEach(function (column) {
          if (!column.relation) {
            throw new _types.HttpException(500, 'Column should have a relation');
          }

          var RELATION_TABLE_NAME = column.relation.table;

          if (!toRequest[RELATION_TABLE_NAME]) {
            toRequest[RELATION_TABLE_NAME] = toRequestBuilder(column.relation, column.name);
          }

          toRequest[RELATION_TABLE_NAME].values.add(row[column.name]);
        });
      });
      var relationQueries = [];
      Object.keys(toRequest).forEach(function (tableName) {
        relationQueries.push(DB.select(toRequest[tableName].display, toRequest[tableName].key).from(tableName).whereIn(toRequest[tableName].key, Array.from(toRequest[tableName].values.values())));
      });
      return Promise.all(relationQueries).then(function (relationResults) {
        var MATCHER = {};
        Object.values(toRequest).forEach(function (requestedTable, index) {
          var FOREIGN_KEY_COLUMN = requestedTable.foreignKeyColumn;
          MATCHER[FOREIGN_KEY_COLUMN] = {};
          relationResults[index].forEach(function (relationRow) {
            var CURRENT_VALUE = relationRow[requestedTable.key];
            var VALUE_TO_DISPLAY = relationRow[requestedTable.display];
            MATCHER[FOREIGN_KEY_COLUMN][CURRENT_VALUE] = VALUE_TO_DISPLAY;
          });
        });
        return results.map(function (row) {
          Object.values(toRequest).forEach(function (requestedTable) {
            var ROW_KEY = requestedTable.foreignKeyColumn;
            row[ROW_KEY] = MATCHER[ROW_KEY][row[ROW_KEY]];
          });
          return row;
        });
      });
    }
  }, {
    key: "getRelationQueries",
    value: function getRelationQueries(TABLE_CONFIG, parentId) {
      var _this3 = this;

      var relationQueries = [];

      if (TABLE_CONFIG.relations && TABLE_CONFIG.relations.manyToOne) {
        var MANY_TO_ONE = TABLE_CONFIG.relations.manyToOne;
        var KEYS = Object.keys(MANY_TO_ONE);
        KEYS.forEach(function (tableName) {
          relationQueries.push(_this3.getRelatedRow(tableName, MANY_TO_ONE[tableName], parentId));
        });
      }

      return relationQueries;
    }
  }, {
    key: "getRelatedRow",
    value: function getRelatedRow(tableName, columnName, parentId) {
      if (!_db.default.db) {
        throw new _types.HttpException(500, 'No database');
      }

      var TABLE_NAME = tableName;
      var TABLE_CONFIG = (0, _utils.getTableConfig)(TABLE_NAME);
      var requestedColumns = (0, _utils.filterVisibleTableColumns)(TABLE_CONFIG, 'detail');
      return _db.default.db.select(requestedColumns).from(tableName).where(columnName, parentId).then(function (results) {
        return {
          results: results,
          tableName: tableName
        };
      });
    }
  }, {
    key: "mergeRelatedData",
    value: function mergeRelatedData(_ref) {
      var _ref2 = _toArray(_ref),
          results = _ref2[0],
          relations = _ref2.slice(1);

      if (relations && relations.length) {
        relations.forEach(function (relation) {
          results[relation.tableName] = relation.results;
        });
      }

      return results;
    }
  }]);

  return TableController;
}();

var _default = TableController;
exports.default = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9hcGkvY29udHJvbGxlcnMvVGFibGVDb250cm9sbGVyLnRzIl0sIm5hbWVzIjpbImRlYnVnIiwidG9SZXF1ZXN0QnVpbGRlciIsInJlbGF0aW9uIiwiY29sdW1uTmFtZSIsInZhbHVlcyIsIlNldCIsImtleSIsImRpc3BsYXkiLCJmb3JlaWduS2V5Q29sdW1uIiwiVGFibGVDb250cm9sbGVyIiwicmVxIiwicmVzIiwibmV4dCIsIlRBQkxFX0NPTkZJRyIsInBhcmFtcyIsInRhYmxlIiwiUkVTVUxUIiwiY29sdW1ucyIsIm5hbWUiLCJwayIsInZlcmJvc2UiLCJyb2xlcyIsInVzZXIiLCJIdHRwRXhjZXB0aW9uIiwiUEFHRV9OVU1CRVIiLCJxdWVyeSIsInBhZ2UiLCJUQUJMRV9OQU1FIiwiQ09MVU1OUyIsIkxJTUlUIiwibGltaXQiLCJwYXJzZUludCIsImRhdGFiYXNlIiwiZGIiLCJEQiIsIlFVRVJZIiwic2VsZWN0IiwiZnJvbSIsImZpbHRlciIsIm9mZnNldCIsInRoZW4iLCJyZXN1bHRzIiwiZnJpZW5kbHlEYXRhIiwiYWRkVmVyYm9zZVJlbGF0ZWREYXRhIiwicmVxdWVzdGVkQ29sdW1ucyIsIndoZXJlIiwiaWQiLCJyZWxhdGlvblF1ZXJpZXMiLCJpbmNsdWRlUmVsYXRpb25zIiwiZ2V0UmVsYXRpb25RdWVyaWVzIiwibGVuZ3RoIiwiUHJvbWlzZSIsImFsbCIsIm1lcmdlUmVsYXRlZERhdGEiLCJpbnNlcnQiLCJib2R5IiwiZGF0YSIsInVwZGF0ZSIsImRlbCIsInRvUmVxdWVzdCIsIkNPTFVNTlNfV0lUSF9SRUxBVElPTlMiLCJmb3JFYWNoIiwicm93IiwiaW5kZXgiLCJjb2x1bW4iLCJSRUxBVElPTl9UQUJMRV9OQU1FIiwiYWRkIiwiT2JqZWN0Iiwia2V5cyIsInRhYmxlTmFtZSIsInB1c2giLCJ3aGVyZUluIiwiQXJyYXkiLCJyZWxhdGlvblJlc3VsdHMiLCJNQVRDSEVSIiwicmVxdWVzdGVkVGFibGUiLCJGT1JFSUdOX0tFWV9DT0xVTU4iLCJyZWxhdGlvblJvdyIsIkNVUlJFTlRfVkFMVUUiLCJWQUxVRV9UT19ESVNQTEFZIiwibWFwIiwiUk9XX0tFWSIsInBhcmVudElkIiwicmVsYXRpb25zIiwibWFueVRvT25lIiwiTUFOWV9UT19PTkUiLCJLRVlTIiwiZ2V0UmVsYXRlZFJvdyJdLCJtYXBwaW5ncyI6Ijs7Ozs7OztBQUFBOztBQUNBOztBQUNBOztBQWFBOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7QUFJQSxJQUFNQSxLQUFLLEdBQUcsb0JBQU0sNEJBQU4sQ0FBZDs7QUFhQSxTQUFTQyxnQkFBVCxDQUEwQkMsUUFBMUIsRUFBcURDLFVBQXJELEVBQXlGO0FBQ3ZGLFNBQU87QUFDTEMsSUFBQUEsTUFBTSxFQUFFLElBQUlDLEdBQUosRUFESDtBQUVMQyxJQUFBQSxHQUFHLEVBQUVKLFFBQVEsQ0FBQ0ksR0FGVDtBQUdMQyxJQUFBQSxPQUFPLEVBQUVMLFFBQVEsQ0FBQ0ssT0FIYjtBQUlMQyxJQUFBQSxnQkFBZ0IsRUFBRUw7QUFKYixHQUFQO0FBTUQ7O0lBRUtNLGU7OztBQUNKLDZCQUFjO0FBQUE7O0FBQ1pULElBQUFBLEtBQUssQ0FBQyxTQUFELENBQUw7QUFDRDs7OzttQ0FFcUJVLEcsRUFBaUJDLEcsRUFBa0JDLEksRUFBb0I7QUFDM0UsVUFBTUMsWUFBWSxHQUFHLDJCQUFlSCxHQUFHLENBQUNJLE1BQUosQ0FBV0MsS0FBMUIsQ0FBckI7QUFDQSxVQUFNQyxNQUFNLEdBQUc7QUFDYkMsUUFBQUEsT0FBTyxFQUFFSixZQUFZLENBQUNJLE9BRFQ7QUFFYkMsUUFBQUEsSUFBSSxFQUFFTCxZQUFZLENBQUNLLElBRk47QUFHYkMsUUFBQUEsRUFBRSxFQUFFTixZQUFZLENBQUNNLEVBSEo7QUFJYkMsUUFBQUEsT0FBTyxFQUFFUCxZQUFZLENBQUNPO0FBSlQsT0FBZjs7QUFPQSxVQUFJLDZCQUFpQlAsWUFBWSxDQUFDUSxLQUE5QixFQUFxQ1gsR0FBRyxDQUFDWSxJQUF6QyxDQUFKLEVBQW9EO0FBQ2xELGtDQUFj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T25DLGVBQVA7QUFDRDs7O2tDQUVxQnNCLFMsRUFBbUJsRSxVLEVBQW9CK0UsUSxFQUFlO0FBQzFFLFVBQUksQ0FBQ2xELFlBQVNDLEVBQWQsRUFBa0I7QUFDaEIsY0FBTSxJQUFJVixvQkFBSixDQUFrQixHQUFsQixFQUF1QixhQUF2QixDQUFOO0FBQ0Q7O0FBQ0QsVUFBTUksVUFBVSxHQUFHMEMsU0FBbkI7QUFDQSxVQUFNeEQsWUFBWSxHQUFHLDJCQUFlYyxVQUFmLENBQXJCO0FBRUEsVUFBTWlCLGdCQUFnQixHQUFHLHNDQUEwQi9CLFlBQTFCLEVBQXdDLFFBQXhDLENBQXpCO0FBQ0EsYUFBT21CLFlBQVNDLEVBQVQsQ0FBWUcsTUFBWixDQUFtQlEsZ0JBQW5CLEVBQ0pQLElBREksQ0FDQ2dDLFNBREQsRUFFSnhCLEtBRkksQ0FFRTFDLFVBRkYsRUFFYytFLFFBRmQsRUFFd0IxQyxJQUZ4QixDQUdILFVBQUNDLE9BQUQ7QUFBQSxlQUFjO0FBQ1pBLFVBQUFBLE9BQU8sRUFBUEEsT0FEWTtBQUVaNEIsVUFBQUEsU0FBUyxFQUFUQTtBQUZZLFNBQWQ7QUFBQSxPQUhHLENBQVA7QUFRRDs7OzJDQUVzRDtBQUFBO0FBQUEsVUFBN0I1QixPQUE2QjtBQUFBLFVBQWpCMEMsU0FBaUI7O0FBQ3JELFVBQUlBLFNBQVMsSUFBSUEsU0FBUyxDQUFDakMsTUFBM0IsRUFBbUM7QUFDakNpQyxRQUFBQSxTQUFTLENBQUN0QixPQUFWLENBQ0UsVUFBQzNELFFBQUQsRUFBbUQ7QUFDakR1QyxVQUFBQSxPQUFPLENBQUN2QyxRQUFRLENBQUNtRSxTQUFWLENBQVAsR0FBOEJuRSxRQUFRLENBQUN1QyxPQUF2QztBQUNELFNBSEg7QUFLRDs7QUFFRCxhQUFPQSxPQUFQO0FBQ0Q7Ozs7OztlQUdZaEMsZSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBkYXRhYmFzZSBmcm9tICdAcm9vdC9hcGkvZGInXG5pbXBvcnQgeyBIdHRwRXhjZXB0aW9uLCBJTUNSZXF1ZXN0LCBJTUNSZXNwb25zZSB9IGZyb20gJ0Byb290L2FwaS90eXBlcydcbmltcG9ydCB7XG4gIGFkZFRvUmVzcG9uc2UsXG4gIGFwcGx5UXVlcnlGaWx0ZXJzLFxuICBjYXRjaE1pZGRsZXdhcmUsXG4gIGZpbHRlclZpc2libGVUYWJsZUNvbHVtbnMsXG4gIGdldFRhYmxlQ29uZmlnLFxuICBoYXNBdXRob3JpemF0aW9uLFxuICBuZXh0QW5kUmV0dXJuLFxuICBydW5Ib29rLFxuICBnZXRDb2x1bW5zV2l0aFJlbGF0aW9uc1xufSBmcm9tICdAcm9vdC9hcGkvdXRpbHMnXG5pbXBvcnQgeyBJVGFibGVJbmZvLCBJQ29sdW1uSW5mbywgSUNvbHVtblJlbGF0aW9uIH0gZnJvbSAnQHJvb3QvY29uZmlnR2VuZXJhdG9yJ1xuaW1wb3J0IEJsdWViaXJkIGZyb20gJ2JsdWViaXJkJ1xuaW1wb3J0IERlYnVnIGZyb20gJ2RlYnVnJ1xuaW1wb3J0IHsgTmV4dEZ1bmN0aW9uLCBSZXF1ZXN0IH0gZnJvbSAnZXhwcmVzcydcbmltcG9ydCBLbmV4IGZyb20gJ0tuZXgnXG5cbmNvbnN0IGRlYnVnID0gRGVidWcoJ2Z1bmZ1bnptYzpjb250cm9sbGVyLXRhYmxlJylcblxuaW50ZXJmYWNlIElUb1JlcXVlc3RJdGVtIHtcbiAgdmFsdWVzOiBTZXQ8bnVtYmVyPixcbiAga2V5OiBzdHJpbmcsXG4gIGRpc3BsYXk6IHN0cmluZyxcbiAgZm9yZWlnbktleUNvbHVtbjogc3RyaW5nXG59XG5cbmludGVyZmFjZSBJVG9SZXF1ZXN0IHtcbiAgW2tleTogc3RyaW5nXTogSVRvUmVxdWVzdEl0ZW0sXG59XG5cbmZ1bmN0aW9uIHRvUmVxdWVzdEJ1aWxkZXIocmVsYXRpb246IElDb2x1bW5SZWxhdGlvbiwgY29sdW1uTmFtZTogc3RyaW5nKTogSVRvUmVxdWVzdEl0ZW0ge1xuICByZXR1cm4ge1xuICAgIHZhbHVlczogbmV3IFNldDxudW1iZXI+KCksXG4gICAga2V5OiByZWxhdGlvbi5rZXksXG4gICAgZGlzcGxheTogcmVsYXRpb24uZGlzcGxheSxcbiAgICBmb3JlaWduS2V5Q29sdW1uOiBjb2x1bW5OYW1lLFxuICB9XG59XG5cbmNsYXNzIFRhYmxlQ29udHJvbGxlciB7XG4gIGNvbnN0cnVjdG9yKCkge1xuICAgIGRlYnVnKCdDcmVhdGVkJylcbiAgfVxuXG4gIHB1YmxpYyBnZXRUYWJsZUNvbmZpZyhyZXE6IElNQ1JlcXVlc3QsIHJlczogSU1DUmVzcG9uc2UsIG5leHQ6IE5leHRGdW5jdGlvbikge1xuICAgIGNvbnN0IFRBQkxFX0NPTkZJRyA9IGdldFRhYmxlQ29uZmlnKHJlcS5wYXJhbXMudGFibGUpXG4gICAgY29uc3QgUkVTVUxUID0ge1xuICAgICAgY29sdW1uczogVEFCTEVfQ09ORklHLmNvbHVtbnMsXG4gICAgICBuYW1lOiBUQUJMRV9DT05GSUcubmFtZSxcbiAgICAgIHBrOiBUQUJMRV9DT05GSUcucGssXG4gICAgICB2ZXJib3NlOiBUQUJMRV9DT05GSUcudmVyYm9zZSxcbiAgICB9XG5cbiAgICBpZiAoaGFzQXV0aG9yaXphdGlvbihUQUJMRV9DT05GSUcucm9sZXMsIHJlcS51c2VyKSkge1xuICAgICAgYWRkVG9SZXNwb25zZShyZXMsICdyZXN1bHRzJykoUkVTVUxUKVxuICAgICAgcmV0dXJuIG5leHRBbmRSZXR1cm4obmV4dCkoUkVTVUxUKVxuICAgIH0gZWxzZSB7XG4gICAgICByZXR1cm4gY2F0Y2hNaWRkbGV3YXJlKG5leHQpKG5ldyBIdHRwRXhjZXB0aW9uKDQwMSwgJ05vdCBhdXRob3JpemVkJykpXG4gICAgfVxuICB9XG5cbiAgcHVibGljIGdldFRhYmxlRGF0YShyZXE6IElNQ1JlcXVlc3QsIHJlczogSU1DUmVzcG9uc2UsIG5leHQ6IE5leHRGdW5jdGlvbikge1xuICAgIGNvbnN0IFBBR0VfTlVNQkVSID0gcmVxLnF1ZXJ5LnBhZ2UgfHwgMFxuICAgIGNvbnN0IFRBQkxFX05BTUUgPSByZXEucGFyYW1zLnRhYmxlXG4gICAgY29uc3QgVEFCTEVfQ09ORklHID0gZ2V0VGFibGVDb25maWcoVEFCTEVfTkFNRSlcbiAgICBjb25zdCBDT0xVTU5TID0gZmlsdGVyVmlzaWJsZVRhYmxlQ29sdW1ucyhUQUJMRV9DT05GSUcsICdtYWluJylcbiAgICBsZXQgTElNSVQgPSAxMFxuXG4gICAgaWYgKHJlcS5xdWVyeS5saW1pdCkge1xuICAgICAgTElNSVQgPSBwYXJzZUludChyZXEucXVlcnkubGltaXQsIDEwKVxuICAgIH1cblxuICAgIGlmICghaGFzQXV0aG9yaXphdGlvbihUQUJMRV9DT05GSUcucm9sZXMsIHJlcS51c2VyKSkge1xuICAgICAgcmV0dXJuIGNhdGNoTWlkZGxld2FyZShuZXh0KShuZXcgSHR0cEV4Y2VwdGlvbig0MDEsICdOb3QgYXV0aG9yaXplZCcpKVxuICAgIH1cbiAgICBpZiAoIWRhdGFiYXNlLmRiKSB7XG4gICAgICByZXR1cm4gY2F0Y2hNaWRkbGV3YXJlKG5leHQpKG5ldyBIdHRwRXhjZXB0aW9uKDUwMCwgJ05vIGRhdGFiYXNlJykpXG4gICAgfVxuICAgIGNvbnN0IERCID0gZGF0YWJhc2UuZGJcbiAgICBsZXQgUVVFUlkgPSBEQi5zZWxlY3QoQ09MVU1OUykuZnJvbShUQUJMRV9OQU1FKVxuICAgIGlmIChyZXEucXVlcnkuZmlsdGVyKSB7XG4gICAgICBRVUVSWSA9IGFwcGx5UXVlcnlGaWx0ZXJzKFFVRVJZLCByZXEucXVlcnkuZmlsdGVyLCBUQUJMRV9DT05GSUcpXG4gICAgfVxuICAgIHJldHVybiBRVUVSWVxuICAgICAgLm9mZnNldCgoUEFHRV9OVU1CRVIpICogTElNSVQpXG4gICAgICAubGltaXQoTElNSVQpXG4gICAgICAudGhlbihcbiAgICAgIChyZXN1bHRzKSA9PiB7XG4gICAgICAgIGlmIChyZXEucXVlcnkuZnJpZW5kbHlEYXRhKSB7XG4gICAgICAgICAgcmV0dXJuIHRoaXMuYWRkVmVyYm9zZVJlbGF0ZWREYXRhKHJlc3VsdHMsIFRBQkxFX0NPTkZJRywgREIpXG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIHJlc3VsdHNcbiAgICAgIH1cbiAgICApLnRoZW4oXG4gICAgICAocmVzdWx0cykgPT4ge1xuICAgICAgICByZXR1cm4gcnVuSG9vayhUQUJMRV9DT05GSUcsICdnZXRUYWJsZURhdGEnLCAnYWZ0ZXInLCByZXEsIHJlcywgZGF0YWJhc2UuZGIsIHJlc3VsdHMpXG4gICAgICB9XG4gICAgKS50aGVuKFxuICAgICAgYWRkVG9SZXNwb25zZShyZXMsICdyZXN1bHRzJylcbiAgICApLnRoZW4oXG4gICAgICBuZXh0QW5kUmV0dXJuKG5leHQpXG4gICAgKVxuICB9XG5cbiAgcHVibGljIGdldFRhYmxlQ291bnQocmVxOiBJTUNSZXF1ZXN0LCByZXM6IElNQ1Jlc3BvbnNlLCBuZXh0OiBOZXh0RnVuY3Rpb24pIHtcbiAgICBjb25zdCBUQUJMRV9OQU1FID0gcmVxLnBhcmFtcy50YWJsZVxuICAgIGNvbnN0IFRBQkxFX0NPTkZJRyA9IGdldFRhYmxlQ29uZmlnKFRBQkxFX05BTUUpXG5cbiAgICBpZiAoIWhhc0F1dGhvcml6YXRpb24oVEFCTEVfQ09ORklHLnJvbGVzLCByZXEudXNlcikpIHtcbiAgICAgIHJldHVybiBjYXRjaE1pZGRsZXdhcmUobmV4dCkobmV3IEh0dHBFeGNlcHRpb24oNDAxLCAnTm90IGF1dGhvcml6ZWQnKSlcbiAgICB9IGVsc2Uge1xuICAgICAgaWYgKCFkYXRhYmFzZS5kYikge1xuICAgICAgICByZXR1cm4gY2F0Y2hNaWRkbGV3YXJlKG5leHQpKG5ldyBIdHRwRXhjZXB0aW9uKDUwMCwgJ05vIGRhdGFiYXNlJykpXG4gICAgICB9IGVsc2Uge1xuICAgICAgICByZXR1cm4gZGF0YWJhc2UuZGIuc2VsZWN0KCcqJykuZnJvbShUQUJMRV9OQU1FKS50aGVuKFxuICAgICAgICAgIChyZXN1bHRzKSA9PiB7XG4gICAgICAgICAgICBydW5Ib29rKFRBQkxFX0NPTkZJRywgJ2dldFRhYmxlQ291bnQnLCAnYWZ0ZXInLCByZXEsIHJlcywgZGF0YWJhc2UuZGIsIHJlc3VsdHMpLnRoZW4oXG4gICAgICAgICAgICAgIGFkZFRvUmVzcG9uc2UocmVzLCAnY291bnQnKVxuICAgICAgICAgICAgKS50aGVuKFxuICAgICAgICAgICAgICBuZXh0QW5kUmV0dXJuKG5leHQpXG4gICAgICAgICAgICApXG4gICAgICAgICAgfVxuICAgICAgICApXG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgcHVibGljIGdldFJvdyhyZXE6IElNQ1JlcXVlc3QsIHJlczogSU1DUmVzcG9uc2UsIG5leHQ6IE5leHRGdW5jdGlvbikge1xuICAgIGNvbnN0IFRBQkxFX05BTUUgPSByZXEucGFyYW1zLnRhYmxlXG4gICAgY29uc3QgVEFCTEVfQ09ORklHID0gZ2V0VGFibGVDb25maWcoVEFCTEVfTkFNRSlcblxuICAgIGlmICghaGFzQXV0aG9yaXphdGlvbihUQUJMRV9DT05GSUcucm9sZXMsIHJlcS51c2VyKSkge1xuICAgICAgcmV0dXJuIGNhdGNoTWlkZGxld2FyZShuZXh0KShuZXcgSHR0cEV4Y2VwdGlvbig0MDEsICdOb3QgYXV0aG9yaXplZCcpKVxuICAgIH0gZWxzZSB7XG4gICAgICBpZiAoIWRhdGFiYXNlLmRiKSB7XG4gICAgICAgIHJldHVybiBjYXRjaE1pZGRsZXdhcmUobmV4dCkobmV3IEh0dHBFeGNlcHRpb24oNTAwLCAnTm8gZGF0YWJhc2UnKSlcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGNvbnN0IHJlcXVlc3RlZENvbHVtbnMgPSBmaWx0ZXJWaXNpYmxlVGFibGVDb2x1bW5zKFRBQkxFX0NPTkZJRywgJ2RldGFpbCcpXG5cbiAgICAgICAgY29uc3QgcXVlcnkgPSBkYXRhYmFzZS5kYi5zZWxlY3QocmVxdWVzdGVkQ29sdW1ucylcbiAgICAgICAgICAuZnJvbShgJHtyZXEucGFyYW1zLnRhYmxlfWApXG4gICAgICAgICAgLndoZXJlKGBpZGAsIHJlcS5wYXJhbXMuaWQpXG5cbiAgICAgICAgcmV0dXJuIHF1ZXJ5LnRoZW4oXG4gICAgICAgICAgKHJlc3VsdHMpID0+IHtcbiAgICAgICAgICAgIGxldCByZWxhdGlvblF1ZXJpZXM6IEFycmF5PEJsdWViaXJkPHt9Pj4gPSBbXVxuICAgICAgICAgICAgaWYgKHJlcS5xdWVyeS5pbmNsdWRlUmVsYXRpb25zKSB7XG4gICAgICAgICAgICAgIHJlbGF0aW9uUXVlcmllcyA9IHRoaXMuZ2V0UmVsYXRpb25RdWVyaWVzKFRBQkxFX0NPTkZJRywgcmVzdWx0c1swXS5pZClcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgaWYgKHJlbGF0aW9uUXVlcmllcy5sZW5ndGgpIHtcbiAgICAgICAgICAgICAgcmV0dXJuIFByb21pc2UuYWxsKFtcbiAgICAgICAgICAgICAgICByZXN1bHRzWzBdLFxuICAgICAgICAgICAgICAgIC4uLnJlbGF0aW9uUXVlcmllcyxcbiAgICAgICAgICAgICAgXSlcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgcmV0dXJuIFByb21pc2UuYWxsKFtcbiAgICAgICAgICAgICAgcmVzdWx0c1swXSxcbiAgICAgICAgICAgIF0pXG4gICAgICAgICAgfVxuICAgICAgICApLnRoZW4oXG4gICAgICAgICAgdGhpcy5tZXJnZVJlbGF0ZWREYXRhXG4gICAgICAgICkudGhlbihcbiAgICAgICAgICBhZGRUb1Jlc3BvbnNlKHJlcywgJ3Jlc3VsdCcpXG4gICAgICAgICkudGhlbihcbiAgICAgICAgICBuZXh0QW5kUmV0dXJuKG5leHQpXG4gICAgICAgIClcbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICBwdWJsaWMgaW5zZXJ0Um93KHJlcTogUmVxdWVzdCwgcmVzOiBJTUNSZXNwb25zZSwgbmV4dDogTmV4dEZ1bmN0aW9uKSB7XG4gICAgaWYgKCFkYXRhYmFzZS5kYikge1xuICAgICAgcmV0dXJuIGNhdGNoTWlkZGxld2FyZShuZXh0KShuZXcgSHR0cEV4Y2VwdGlvbig1MDAsICdObyBkYXRhYmFzZScpKVxuICAgIH0gZWxzZSB7XG4gICAgICByZXR1cm4gZGF0YWJhc2UuZGIocmVxLnBhcmFtcy50YWJsZSkuaW5zZXJ0KHJlcS5ib2R5LmRhdGEpLnRoZW4oXG4gICAgICAgIGFkZFRvUmVzcG9uc2UocmVzLCAncmVzdWx0cycpXG4gICAgICApLnRoZW4oXG4gICAgICAgIG5leHRBbmRSZXR1cm4obmV4dClcbiAgICAgIClcbiAgICB9XG4gIH1cblxuICBwdWJsaWMgdXBkYXRlUm93KHJlcTogUmVxdWVzdCwgcmVzOiBJTUNSZXNwb25zZSwgbmV4dDogTmV4dEZ1bmN0aW9uKSB7XG4gICAgaWYgKCFkYXRhYmFzZS5kYikge1xuICAgICAgcmV0dXJuIGNhdGNoTWlkZGxld2FyZShuZXh0KShuZXcgSHR0cEV4Y2VwdGlvbig1MDAsICdObyBkYXRhYmFzZScpKVxuICAgIH0gZWxzZSB7XG4gICAgICByZXR1cm4gZGF0YWJhc2UuZGIocmVxLmJvZHkudGFibGUpLndoZXJlKCdpZCcsIHJlcS5ib2R5LmlkKS51cGRhdGUocmVxLmJvZHkuZGF0YSkudGhlbihcbiAgICAgICAgYWRkVG9SZXNwb25zZShyZXMsICdyZXN1bHRzJylcbiAgICAgICkudGhlbihcbiAgICAgICAgbmV4dEFuZFJldHVybihuZXh0KVxuICAgICAgKVxuICAgIH1cbiAgfVxuXG4gIHB1YmxpYyBkZWxldGVSb3cocmVxOiBSZXF1ZXN0LCByZXM6IElNQ1Jlc3BvbnNlLCBuZXh0OiBOZXh0RnVuY3Rpb24pIHtcbiAgICBpZiAoIWRhdGFiYXNlLmRiKSB7XG4gICAgICByZXR1cm4gY2F0Y2hNaWRkbGV3YXJlKG5leHQpKG5ldyBIdHRwRXhjZXB0aW9uKDUwMCwgJ05vIGRhdGFiYXNlJykpXG4gICAgfSBlbHNlIHtcbiAgICAgIHJldHVybiBkYXRhYmFzZS5kYihyZXEucGFyYW1zLnRhYmxlKS53aGVyZSgnaWQnLCByZXEucGFyYW1zLmlkKS5kZWwoKS50aGVuKFxuICAgICAgICBhZGRUb1Jlc3BvbnNlKHJlcywgJ3Jlc3VsdHMnKVxuICAgICAgKS50aGVuKFxuICAgICAgICBuZXh0QW5kUmV0dXJuKG5leHQpXG4gICAgICApXG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBhZGRWZXJib3NlUmVsYXRlZERhdGEocmVzdWx0czogYW55W10sIFRBQkxFX0NPTkZJRzogSVRhYmxlSW5mbywgREI6IEtuZXgpIHtcbiAgICBjb25zdCB0b1JlcXVlc3Q6IElUb1JlcXVlc3QgPSB7fVxuICAgIGNvbnN0IENPTFVNTlNfV0lUSF9SRUxBVElPTlMgPSBnZXRDb2x1bW5zV2l0aFJlbGF0aW9ucyhUQUJMRV9DT05GSUcpXG4gICAgcmVzdWx0cy5mb3JFYWNoKFxuICAgICAgKHJvdzogYW55LCBpbmRleDogbnVtYmVyKSA9PiB7XG4gICAgICAgIENPTFVNTlNfV0lUSF9SRUxBVElPTlMuZm9yRWFjaChcbiAgICAgICAgICAoY29sdW1uKSA9PiB7XG4gICAgICAgICAgICBpZiAoIWNvbHVtbi5yZWxhdGlvbikge1xuICAgICAgICAgICAgICB0aHJvdyBuZXcgSHR0cEV4Y2VwdGlvbig1MDAsICdDb2x1bW4gc2hvdWxkIGhhdmUgYSByZWxhdGlvbicpXG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBjb25zdCBSRUxBVElPTl9UQUJMRV9OQU1FID0gY29sdW1uLnJlbGF0aW9uLnRhYmxlXG5cbiAgICAgICAgICAgIGlmICghdG9SZXF1ZXN0W1JFTEFUSU9OX1RBQkxFX05BTUVdKSB7XG4gICAgICAgICAgICAgIHRvUmVxdWVzdFtSRUxBVElPTl9UQUJMRV9OQU1FXSA9IHRvUmVxdWVzdEJ1aWxkZXIoY29sdW1uLnJlbGF0aW9uLCBjb2x1bW4ubmFtZSlcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgdG9SZXF1ZXN0W1JFTEFUSU9OX1RBQkxFX05BTUVdLnZhbHVlcy5hZGQocm93W2NvbHVtbi5uYW1lXSlcbiAgICAgICAgICB9XG4gICAgICAgIClcbiAgICAgIH1cbiAgICApXG5cbiAgICBjb25zdCByZWxhdGlvblF1ZXJpZXM6IEtuZXguUXVlcnlCdWlsZGVyW10gPSBbXVxuICAgIE9iamVjdC5rZXlzKHRvUmVxdWVzdCkuZm9yRWFjaChcbiAgICAgICh0YWJsZU5hbWUpID0+IHtcbiAgICAgICAgcmVsYXRpb25RdWVyaWVzLnB1c2goXG4gICAgICAgICAgREIuc2VsZWN0KHRvUmVxdWVzdFt0YWJsZU5hbWVdLmRpc3BsYXksIHRvUmVxdWVzdFt0YWJsZU5hbWVdLmtleSlcbiAgICAgICAgICAgIC5mcm9tKHRhYmxlTmFtZSlcbiAgICAgICAgICAgIC53aGVyZUluKHRvUmVxdWVzdFt0YWJsZU5hbWVdLmtleSwgQXJyYXkuZnJvbSh0b1JlcXVlc3RbdGFibGVOYW1lXS52YWx1ZXMudmFsdWVzKCkpKVxuICAgICAgICApXG4gICAgICB9XG4gICAgKVxuXG4gICAgcmV0dXJuIFByb21pc2UuYWxsPGFueVtdPihyZWxhdGlvblF1ZXJpZXMpLnRoZW4oXG4gICAgICAocmVsYXRpb25SZXN1bHRzKSA9PiB7XG4gICAgICAgIGNvbnN0IE1BVENIRVI6IHtcbiAgICAgICAgICBbZm9yZWlnbktleUNvbHVtbjogc3RyaW5nXToge1xuICAgICAgICAgICAgW3ZhbHVlOiBzdHJpbmddOiBzdHJpbmdcbiAgICAgICAgICB9XG4gICAgICAgIH0gPSB7fVxuICAgICAgICBPYmplY3QudmFsdWVzKHRvUmVxdWVzdCkuZm9yRWFjaChcbiAgICAgICAgICAocmVxdWVzdGVkVGFibGUsIGluZGV4KSA9PiB7XG4gICAgICAgICAgICBjb25zdCBGT1JFSUdOX0tFWV9DT0xVTU4gPSByZXF1ZXN0ZWRUYWJsZS5mb3JlaWduS2V5Q29sdW1uXG4gICAgICAgICAgICBNQVRDSEVSW0ZPUkVJR05fS0VZX0NPTFVNTl0gPSB7fVxuICAgICAgICAgICAgcmVsYXRpb25SZXN1bHRzW2luZGV4XS5mb3JFYWNoKFxuICAgICAgICAgICAgICAocmVsYXRpb25Sb3c6IGFueSkgPT4ge1xuICAgICAgICAgICAgICAgIGNvbnN0IENVUlJFTlRfVkFMVUUgPSByZWxhdGlvblJvd1tyZXF1ZXN0ZWRUYWJsZS5rZXldXG4gICAgICAgICAgICAgICAgY29uc3QgVkFMVUVfVE9fRElTUExBWSA9IHJlbGF0aW9uUm93W3JlcXVlc3RlZFRhYmxlLmRpc3BsYXldXG4gICAgICAgICAgICAgICAgTUFUQ0hFUltGT1JFSUdOX0tFWV9DT0xVTU5dW0NVUlJFTlRfVkFMVUVdID0gVkFMVUVfVE9fRElTUExBWVxuICAgICAgICAgICAgICB9XG4gICAgICAgICAgICApXG4gICAgICAgICAgfVxuICAgICAgICApXG4gICAgICAgIHJldHVybiByZXN1bHRzLm1hcChcbiAgICAgICAgICAocm93OiBhbnkpID0+IHtcbiAgICAgICAgICAgIE9iamVjdC52YWx1ZXModG9SZXF1ZXN0KS5mb3JFYWNoKFxuICAgICAgICAgICAgICAocmVxdWVzdGVkVGFibGUpID0+IHtcbiAgICAgICAgICAgICAgICBjb25zdCBST1dfS0VZID0gcmVxdWVzdGVkVGFibGUuZm9yZWlnbktleUNvbHVtblxuICAgICAgICAgICAgICAgIHJvd1tST1dfS0VZXSA9IE1BVENIRVJbUk9XX0tFWV1bcm93W1JPV19LRVldXVxuICAgICAgICAgICAgICB9XG4gICAgICAgICAgICApXG4gICAgICAgICAgICByZXR1cm4gcm93XG4gICAgICAgICAgfVxuICAgICAgICApXG4gICAgICB9XG4gICAgKVxuICB9XG5cbiAgcHJpdmF0ZSBnZXRSZWxhdGlvblF1ZXJpZXMoVEFCTEVfQ09ORklHOiBJVGFibGVJbmZvLCBwYXJlbnRJZDogYW55KSB7XG4gICAgY29uc3QgcmVsYXRpb25RdWVyaWVzOiBBcnJheTxCbHVlYmlyZDx7fT4+ID0gW11cbiAgICBpZiAoVEFCTEVfQ09ORklHLnJlbGF0aW9ucyAmJiBUQUJMRV9DT05GSUcucmVsYXRpb25zLm1hbnlUb09uZSkge1xuICAgICAgY29uc3QgTUFOWV9UT19PTkUgPSBUQUJMRV9DT05GSUcucmVsYXRpb25zLm1hbnlUb09uZVxuICAgICAgY29uc3QgS0VZUzogc3RyaW5nW10gPSBPYmplY3Qua2V5cyhNQU5ZX1RPX09ORSlcbiAgICAgIEtFWVMuZm9yRWFjaChcbiAgICAgICAgKHRhYmxlTmFtZSkgPT4ge1xuICAgICAgICAgIHJlbGF0aW9uUXVlcmllcy5wdXNoKFxuICAgICAgICAgICAgdGhpcy5nZXRSZWxhdGVkUm93KFxuICAgICAgICAgICAgICB0YWJsZU5hbWUsXG4gICAgICAgICAgICAgIE1BTllfVE9fT05FW3RhYmxlTmFtZV0sXG4gICAgICAgICAgICAgIHBhcmVudElkXG4gICAgICAgICAgICApXG4gICAgICAgICAgKVxuICAgICAgICB9XG4gICAgICApXG4gICAgfVxuXG4gICAgcmV0dXJuIHJlbGF0aW9uUXVlcmllc1xuICB9XG5cbiAgcHJpdmF0ZSBnZXRSZWxhdGVkUm93KHRhYmxlTmFtZTogc3RyaW5nLCBjb2x1bW5OYW1lOiBzdHJpbmcsIHBhcmVudElkOiBhbnkpIHtcbiAgICBpZiAoIWRhdGFiYXNlLmRiKSB7XG4gICAgICB0aHJvdyBuZXcgSHR0cEV4Y2VwdGlvbig1MDAsICdObyBkYXRhYmFzZScpXG4gICAgfVxuICAgIGNvbnN0IFRBQkxFX05BTUUgPSB0YWJsZU5hbWVcbiAgICBjb25zdCBUQUJMRV9DT05GSUcgPSBnZXRUYWJsZUNvbmZpZyhUQUJMRV9OQU1FKVxuXG4gICAgY29uc3QgcmVxdWVzdGVkQ29sdW1ucyA9IGZpbHRlclZpc2libGVUYWJsZUNvbHVtbnMoVEFCTEVfQ09ORklHLCAnZGV0YWlsJylcbiAgICByZXR1cm4gZGF0YWJhc2UuZGIuc2VsZWN0KHJlcXVlc3RlZENvbHVtbnMpXG4gICAgICAuZnJvbSh0YWJsZU5hbWUpXG4gICAgICAud2hlcmUoY29sdW1uTmFtZSwgcGFyZW50SWQpLnRoZW4oXG4gICAgICAgIChyZXN1bHRzKSA9PiAoe1xuICAgICAgICAgIHJlc3VsdHMsXG4gICAgICAgICAgdGFibGVOYW1lLFxuICAgICAgICB9KVxuICAgICAgKVxuICB9XG5cbiAgcHJpdmF0ZSBtZXJnZVJlbGF0ZWREYXRhKFtyZXN1bHRzLCAuLi5yZWxhdGlvbnNdOiBhbnkpIHtcbiAgICBpZiAocmVsYXRpb25zICYmIHJlbGF0aW9ucy5sZW5ndGgpIHtcbiAgICAgIHJlbGF0aW9ucy5mb3JFYWNoKFxuICAgICAgICAocmVsYXRpb246IHt0YWJsZU5hbWU6IHN0cmluZywgcmVzdWx0czogYW55W119KSA9PiB7XG4gICAgICAgICAgcmVzdWx0c1tyZWxhdGlvbi50YWJsZU5hbWVdID0gcmVsYXRpb24ucmVzdWx0c1xuICAgICAgICB9XG4gICAgICApXG4gICAgfVxuXG4gICAgcmV0dXJuIHJlc3VsdHNcbiAgfVxufVxuXG5leHBvcnQgZGVmYXVsdCBUYWJsZUNvbnRyb2xsZXJcbiJdfQ==