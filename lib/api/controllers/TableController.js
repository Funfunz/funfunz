"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _db = _interopRequireDefault(require("../db"));

var _types = require("../types");

var _utils = require("../utils");

var _debug = _interopRequireDefault(require("debug"));

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

function _toArray(arr) { return _arrayWithHoles(arr) || _iterableToArray(arr) || _nonIterableRest(); }

function _nonIterableRest() { throw new TypeError("Invalid attempt to destructure non-iterable instance"); }

function _arrayWithHoles(arr) { if (Array.isArray(arr)) return arr; }

function _toConsumableArray(arr) { return _arrayWithoutHoles(arr) || _iterableToArray(arr) || _nonIterableSpread(); }

function _nonIterableSpread() { throw new TypeError("Invalid attempt to spread non-iterable instance"); }

function _iterableToArray(iter) { if (Symbol.iterator in Object(iter) || Object.prototype.toString.call(iter) === "[object Arguments]") return Array.from(iter); }

function _arrayWithoutHoles(arr) { if (Array.isArray(arr)) { for (var i = 0, arr2 = new Array(arr.length); i < arr.length; i++) { arr2[i] = arr[i]; } return arr2; } }

function _classCallCheck(instance, Constructor) { if (!(instance instanceof Constructor)) { throw new TypeError("Cannot call a class as a function"); } }

function _defineProperties(target, props) { for (var i = 0; i < props.length; i++) { var descriptor = props[i]; descriptor.enumerable = descriptor.enumerable || false; descriptor.configurable = true; if ("value" in descriptor) descriptor.writable = true; Object.defineProperty(target, descriptor.key, descriptor); } }

function _createClass(Constructor, protoProps, staticProps) { if (protoProps) _defineProperties(Constructor.prototype, protoProps); if (staticProps) _defineProperties(Constructor, staticProps); return Constructor; }

var debug = (0, _debug.default)('funfunzmc:controller-table');

function toRequestBuilder(relation, columnName) {
  return {
    values: new Set(),
    key: relation.key,
    display: relation.display,
    foreignKeyColumn: columnName
  };
}

var TableController =
/*#__PURE__*/
function () {
  function TableController() {
    _classCallCheck(this, TableController);

    debug('Created');
  }

  _createClass(TableController, [{
    key: "getTableConfig",
    value: function getTableConfig(req, res, next) {
      var TABLE_CONFIG = (0, _utils.getTableConfig)(req.params.table);
      var RESULT = {
        columns: TABLE_CONFIG.columns,
        name: TABLE_CONFIG.name,
        pk: TABLE_CONFIG.pk,
        verbose: TABLE_CONFIG.verbose
      };

      if ((0, _utils.hasAuthorization)(TABLE_CONFIG.roles, req.user)) {
        (0, _utils.addToResponse)(res, 'results')(RESULT);
        return (0, _utils.nextAndReturn)(next)(RESULT);
      } else {
        return (0, _utils.catchMiddleware)(next)(new _types.HttpException(401, 'Not authorized'));
      }
    }
  }, {
    key: "getTableData",
    value: function getTableData(req, res, next) {
      var _this = this;

      var PAGE_NUMBER = req.query.page || 0;
      var TABLE_NAME = req.params.table;
      var TABLE_CONFIG = (0, _utils.getTableConfig)(TABLE_NAME);
      var COLUMNS = (0, _utils.filterVisibleTableColumns)(TABLE_CONFIG, 'main');
      var LIMIT = 10;

      if (!(0, _utils.hasAuthorization)(TABLE_CONFIG.roles, req.user)) {
        return (0, _utils.catchMiddleware)(next)(new _types.HttpException(401, 'Not authorized'));
      }

      if (!_db.default.db) {
        return (0, _utils.catchMiddleware)(next)(new _types.HttpException(500, 'No database'));
      }

      var DB = _db.default.db;
      var QUERY = DB.select(COLUMNS).from(TABLE_NAME);

      if (req.query.filter) {
        QUERY = (0, _utils.applyQueryFilters)(QUERY, req.query.filter, TABLE_CONFIG);
      }

      if (req.query.limit) {
        LIMIT = parseInt(req.query.limit, 10);
      }

      if (LIMIT > 0) {
        QUERY.offset(PAGE_NUMBER * LIMIT).limit(LIMIT);
      }

      return (0, _utils.runHook)(TABLE_CONFIG, 'getTableData', 'before', req, res, _db.default.db).then(function (hookResult) {
        if (hookResult) {
          if (hookResult.filter) {
            Object.keys(hookResult.filter).forEach(function (column) {
              if (Array.isArray(hookResult.filter[column])) {
                QUERY.whereIn(column, hookResult.filter[column]);
              }
            });
          }
        }

        return QUERY;
      }).then(function (results) {
        if (req.query.friendlyData) {
          return _this.addVerboseRelatedData(results, TABLE_CONFIG, DB);
        }

        return results;
      }).then(function (results) {
        return (0, _utils.runHook)(TABLE_CONFIG, 'getTableData', 'after', req, res, _db.default.db, results);
      }).then((0, _utils.addToResponse)(res, 'results')).then((0, _utils.nextAndReturn)(next));
    }
  }, {
    key: "getTableCount",
    value: function getTableCount(req, res, next) {
      var TABLE_NAME = req.params.table;
      var TABLE_CONFIG = (0, _utils.getTableConfig)(TABLE_NAME);

      if (!(0, _utils.hasAuthorization)(TABLE_CONFIG.roles, req.user)) {
        return (0, _utils.catchMiddleware)(next)(new _types.HttpException(401, 'Not authorized'));
      } else {
        if (!_db.default.db) {
          return (0, _utils.catchMiddleware)(next)(new _types.HttpException(500, 'No database'));
        } else {
          return _db.default.db.select('*').from(TABLE_NAME).then(function (results) {
            (0, _utils.runHook)(TABLE_CONFIG, 'getTableCount', 'after', req, res, _db.default.db, results).then((0, _utils.addToResponse)(res, 'count')).then((0, _utils.nextAndReturn)(next));
          });
        }
      }
    }
  }, {
    key: "getRow",
    value: function getRow(req, res, next) {
      var _this2 = this;

      var TABLE_NAME = req.params.table;
      var TABLE_CONFIG = (0, _utils.getTableConfig)(TABLE_NAME);

      if (!(0, _utils.hasAuthorization)(TABLE_CONFIG.roles, req.user)) {
        return (0, _utils.catchMiddleware)(next)(new _types.HttpException(401, 'Not authorized'));
      } else {
        if (!_db.default.db) {
          return (0, _utils.catchMiddleware)(next)(new _types.HttpException(500, 'No database'));
        } else {
          var requestedColumns = (0, _utils.filterVisibleTableColumns)(TABLE_CONFIG, 'detail');

          var query = _db.default.db.select(requestedColumns).from("".concat(req.params.table)).where("id", req.params.id);

          return query.then(function (results) {
            var relationQueries = [];

            if (req.query.includeRelations) {
              relationQueries = _this2.getRelationQueries(TABLE_CONFIG, results[0].id);
            }

            if (relationQueries.length) {
              return Promise.all([results[0]].concat(_toConsumableArray(relationQueries)));
            }

            return Promise.all([results[0]]);
          }).then(this.mergeRelatedData).then((0, _utils.addToResponse)(res, 'result')).then((0, _utils.nextAndReturn)(next));
        }
      }
    }
  }, {
    key: "insertRow",
    value: function insertRow(req, res, next) {
      if (!_db.default.db) {
        return (0, _utils.catchMiddleware)(next)(new _types.HttpException(500, 'No database'));
      } else {
        return _db.default.db(req.params.table).insert(req.body.data).then((0, _utils.addToResponse)(res, 'results')).then((0, _utils.nextAndReturn)(next));
      }
    }
  }, {
    key: "updateRow",
    value: function updateRow(req, res, next) {
      if (!_db.default.db) {
        return (0, _utils.catchMiddleware)(next)(new _types.HttpException(500, 'No database'));
      }

      var TABLE_NAME = req.params.table;
      var TABLE_CONFIG = (0, _utils.getTableConfig)(TABLE_NAME);
      TABLE_CONFIG.columns.forEach(function (column) {
        if (column.type === 'datetime') {
          req.body.data[column.name] = new Date(req.body.data[column.name] || null);
        }
      });
      return _db.default.db(TABLE_NAME).where('id', req.params.id).update(req.body.data).then((0, _utils.addToResponse)(res, 'results')).then((0, _utils.nextAndReturn)(next));
    }
  }, {
    key: "deleteRow",
    value: function deleteRow(req, res, next) {
      if (!_db.default.db) {
        return (0, _utils.catchMiddleware)(next)(new _types.HttpException(500, 'No database'));
      } else {
        return _db.default.db(req.params.table).where('id', req.params.id).del().then((0, _utils.addToResponse)(res, 'results')).then((0, _utils.nextAndReturn)(next));
      }
    }
  }, {
    key: "addVerboseRelatedData",
    value: function addVerboseRelatedData(results, TABLE_CONFIG, DB) {
      var toRequest = {};
      var COLUMNS_WITH_RELATIONS = (0, _utils.getColumnsWithRelations)(TABLE_CONFIG);
      results.forEach(function (row, index) {
        COLUMNS_WITH_RELATIONS.forEach(function (column) {
          if (!column.relation) {
            throw new _types.HttpException(500, 'Column should have a relation');
          }

          var RELATION_TABLE_NAME = column.relation.table;

          if (!toRequest[RELATION_TABLE_NAME]) {
            toRequest[RELATION_TABLE_NAME] = toRequestBuilder(column.relation, column.name);
          }

          toRequest[RELATION_TABLE_NAME].values.add(row[column.name]);
        });
      });
      var relationQueries = [];
      Object.keys(toRequest).forEach(function (tableName) {
        relationQueries.push(DB.select(toRequest[tableName].display, toRequest[tableName].key).from(tableName).whereIn(toRequest[tableName].key, Array.from(toRequest[tableName].values.values())));
      });
      return Promise.all(relationQueries).then(function (relationResults) {
        var MATCHER = {};
        Object.values(toRequest).forEach(function (requestedTable, index) {
          var FOREIGN_KEY_COLUMN = requestedTable.foreignKeyColumn;
          MATCHER[FOREIGN_KEY_COLUMN] = {};
          relationResults[index].forEach(function (relationRow) {
            var CURRENT_VALUE = relationRow[requestedTable.key];
            var VALUE_TO_DISPLAY = relationRow[requestedTable.display];
            MATCHER[FOREIGN_KEY_COLUMN][CURRENT_VALUE] = VALUE_TO_DISPLAY;
          });
        });
        return results.map(function (row) {
          Object.values(toRequest).forEach(function (requestedTable) {
            var ROW_KEY = requestedTable.foreignKeyColumn;
            row[ROW_KEY] = MATCHER[ROW_KEY][row[ROW_KEY]];
          });
          return row;
        });
      });
    }
  }, {
    key: "getRelationQueries",
    value: function getRelationQueries(TABLE_CONFIG, parentId) {
      var _this3 = this;

      var relationQueries = [];

      if (TABLE_CONFIG.relations && TABLE_CONFIG.relations.manyToOne) {
        var MANY_TO_ONE = TABLE_CONFIG.relations.manyToOne;
        var KEYS = Object.keys(MANY_TO_ONE);
        KEYS.forEach(function (tableName) {
          relationQueries.push(_this3.getRelatedRow(tableName, MANY_TO_ONE[tableName], parentId));
        });
      }

      return relationQueries;
    }
  }, {
    key: "getRelatedRow",
    value: function getRelatedRow(tableName, columnName, parentId) {
      if (!_db.default.db) {
        throw new _types.HttpException(500, 'No database');
      }

      var TABLE_NAME = tableName;
      var TABLE_CONFIG = (0, _utils.getTableConfig)(TABLE_NAME);
      var requestedColumns = (0, _utils.filterVisibleTableColumns)(TABLE_CONFIG, 'detail');
      return _db.default.db.select(requestedColumns).from(tableName).where(columnName, parentId).then(function (results) {
        return {
          results: results,
          tableName: tableName
        };
      });
    }
  }, {
    key: "mergeRelatedData",
    value: function mergeRelatedData(_ref) {
      var _ref2 = _toArray(_ref),
          results = _ref2[0],
          relations = _ref2.slice(1);

      if (relations && relations.length) {
        relations.forEach(function (relation) {
          results[relation.tableName] = relation.results;
        });
      }

      return results;
    }
  }]);

  return TableController;
}();

var _default = TableController;
exports.default = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9hcGkvY29udHJvbGxlcnMvVGFibGVDb250cm9sbGVyLnRzIl0sIm5hbWVzIjpbImRlYnVnIiwidG9SZXF1ZXN0QnVpbGRlciIsInJlbGF0aW9uIiwiY29sdW1uTmFtZSIsInZhbHVlcyIsIlNldCIsImtleSIsImRpc3BsYXkiLCJmb3JlaWduS2V5Q29sdW1uIiwiVGFibGVDb250cm9sbGVyIiwicmVxIiwicmVzIiwibmV4dCIsIlRBQkxFX0NPTkZJRyIsInBhcmFtcyIsInRhYmxlIiwiUkVTVUxUIiwiY29sdW1ucyIsIm5hbWUiLCJwayIsInZlcmJvc2UiLCJyb2xlcyIsInVzZXIiLCJIdHRwRXhjZXB0aW9uIiwiUEFHRV9OVU1CRVIiLCJxdWVyeSIsInBhZ2UiLCJUQUJMRV9OQU1FIiwiQ09MVU1OUyIsIkxJTUlUIiwiZGF0YWJhc2UiLCJkYiIsIkRCIiwiUVVFUlkiLCJzZWxlY3QiLCJmcm9tIiwiZmlsdGVyIiwibGltaXQiLCJwYXJzZUludCIsIm9mZnNldCIsInRoZW4iLCJob29rUmVzdWx0IiwiT2JqZWN0Iiwia2V5cyIsImZvckVhY2giLCJjb2x1bW4iLCJBcnJheSIsImlzQXJyYXkiLCJ3aGVyZUluIiwicmVzdWx0cyIsImZyaWVuZGx5RGF0YSIsImFkZFZlcmJvc2VSZWxhdGVkRGF0YSIsInJlcXVlc3RlZENvbHVtbnMiLCJ3aGVyZSIsImlkIiwicmVsYXRpb25RdWVyaWVzIiwiaW5jbHVkZVJlbGF0aW9ucyIsImdldFJlbGF0aW9uUXVlcmllcyIsImxlbmd0aCIsIlByb21pc2UiLCJhbGwiLCJtZXJnZVJlbGF0ZWREYXRhIiwiaW5zZXJ0IiwiYm9keSIsImRhdGEiLCJ0eXBlIiwiRGF0ZSIsInVwZGF0ZSIsImRlbCIsInRvUmVxdWVzdCIsIkNPTFVNTlNfV0lUSF9SRUxBVElPTlMiLCJyb3ciLCJpbmRleCIsIlJFTEFUSU9OX1RBQkxFX05BTUUiLCJhZGQiLCJ0YWJsZU5hbWUiLCJwdXNoIiwicmVsYXRpb25SZXN1bHRzIiwiTUFUQ0hFUiIsInJlcXVlc3RlZFRhYmxlIiwiRk9SRUlHTl9LRVlfQ09MVU1OIiwicmVsYXRpb25Sb3ciLCJDVVJSRU5UX1ZBTFVFIiwiVkFMVUVfVE9fRElTUExBWSIsIm1hcCIsIlJPV19LRVkiLCJwYXJlbnRJZCIsInJlbGF0aW9ucyIsIm1hbnlUb09uZSIsIk1BTllfVE9fT05FIiwiS0VZUyIsImdldFJlbGF0ZWRSb3ciXSwibWFwcGluZ3MiOiI7Ozs7Ozs7QUFBQTs7QUFDQTs7QUFDQTs7QUFhQTs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0FBSUEsSUFBTUEsS0FBSyxHQUFHLG9CQUFNLDRCQUFOLENBQWQ7O0FBYUEsU0FBU0MsZ0JBQVQsQ0FBMEJDLFFBQTFCLEVBQXFEQyxVQUFyRCxFQUF5RjtBQUN2RixTQUFPO0FBQ0xDLElBQUFBLE1BQU0sRUFBRSxJQUFJQyxHQUFKLEVBREg7QUFFTEMsSUFBQUEsR0FBRyxFQUFFSixRQUFRLENBQUNJLEdBRlQ7QUFHTEMsSUFBQUEsT0FBTyxFQUFFTCxRQUFRLENBQUNLLE9BSGI7QUFJTEMsSUFBQUEsZ0JBQWdCLEVBQUVMO0FBSmIsR0FBUDtBQU1EOztJQUVLTSxlOzs7QUFDSiw2QkFBYztBQUFBOztBQUNaVCxJQUFBQSxLQUFLLENBQUMsU0FBRCxDQUFMO0FBQ0Q7Ozs7bUNBRXFCVSxHLEVBQWlCQyxHLEVBQWtCQyxJLEVBQW9CO0FBQzNFLFVBQU1DLFlBQVksR0FBRywyQkFBZUgsR0FBRyxDQUFDSSxNQUFKLENBQVdDLEtBQTFCLENBQXJCO0FBQ0EsVUFBTUMsTUFBTSxHQUFHO0FBQ2JDLFFBQUFBLE9BQU8sRUFBRUosWUFBWSxDQUFDSSxPQURUO0FBRWJDLFFBQUFBLElBQUksRUFBRUwsWUFBWSxDQUFDSyxJQUZOO0FBR2JDLFFBQUFBLEVBQUUsRUFBRU4sWUFBWSxDQUFDTSxFQUhKO0FBSWJDLFFBQUFBLE9BQU8sRUFBRVAsWUFBWSxDQUFDTztBQUpULE9BQWY7O0FBT0EsVUFBSSw2QkFBaUJQLFlBQVksQ0FBQ1EsS0FBOUIsRUFBcUNYLEdB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LFNBVEg7QUFXRDs7QUFFRCxhQUFPL0IsZUFBUDtBQUNEOzs7a0NBRXFCb0IsUyxFQUFtQnhFLFUsRUFBb0JtRixRLEVBQWU7QUFDMUUsVUFBSSxDQUFDeEQsWUFBU0MsRUFBZCxFQUFrQjtBQUNoQixjQUFNLElBQUlSLG9CQUFKLENBQWtCLEdBQWxCLEVBQXVCLGFBQXZCLENBQU47QUFDRDs7QUFDRCxVQUFNSSxVQUFVLEdBQUdnRCxTQUFuQjtBQUNBLFVBQU05RCxZQUFZLEdBQUcsMkJBQWVjLFVBQWYsQ0FBckI7QUFFQSxVQUFNeUIsZ0JBQWdCLEdBQUcsc0NBQTBCdkMsWUFBMUIsRUFBd0MsUUFBeEMsQ0FBekI7QUFDQSxhQUFPaUIsWUFBU0MsRUFBVCxDQUFZRyxNQUFaLENBQW1Ca0IsZ0JBQW5CLEVBQ0pqQixJQURJLENBQ0N3QyxTQURELEVBRUp0QixLQUZJLENBRUVsRCxVQUZGLEVBRWNtRixRQUZkLEVBRXdCOUMsSUFGeEIsQ0FHSCxVQUFDUyxPQUFEO0FBQUEsZUFBYztBQUNaQSxVQUFBQSxPQUFPLEVBQVBBLE9BRFk7QUFFWjBCLFVBQUFBLFNBQVMsRUFBVEE7QUFGWSxTQUFkO0FBQUEsT0FIRyxDQUFQO0FBUUQ7OzsyQ0FFc0Q7QUFBQTtBQUFBLFVBQTdCMUIsT0FBNkI7QUFBQSxVQUFqQnNDLFNBQWlCOztBQUNyRCxVQUFJQSxTQUFTLElBQUlBLFNBQVMsQ0FBQzdCLE1BQTNCLEVBQW1DO0FBQ2pDNkIsUUFBQUEsU0FBUyxDQUFDM0MsT0FBVixDQUNFLFVBQUMxQyxRQUFELEVBQW1EO0FBQ2pEK0MsVUFBQUEsT0FBTyxDQUFDL0MsUUFBUSxDQUFDeUUsU0FBVixDQUFQLEdBQThCekUsUUFBUSxDQUFDK0MsT0FBdkM7QUFDRCxTQUhIO0FBS0Q7O0FBRUQsYUFBT0EsT0FBUDtBQUNEOzs7Ozs7ZUFHWXhDLGUiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgZGF0YWJhc2UgZnJvbSAnQHJvb3QvYXBpL2RiJ1xuaW1wb3J0IHsgSHR0cEV4Y2VwdGlvbiwgSU1DUmVxdWVzdCwgSU1DUmVzcG9uc2UgfSBmcm9tICdAcm9vdC9hcGkvdHlwZXMnXG5pbXBvcnQge1xuICBhZGRUb1Jlc3BvbnNlLFxuICBhcHBseVF1ZXJ5RmlsdGVycyxcbiAgY2F0Y2hNaWRkbGV3YXJlLFxuICBmaWx0ZXJWaXNpYmxlVGFibGVDb2x1bW5zLFxuICBnZXRDb2x1bW5zV2l0aFJlbGF0aW9ucyxcbiAgZ2V0VGFibGVDb25maWcsXG4gIGhhc0F1dGhvcml6YXRpb24sXG4gIG5leHRBbmRSZXR1cm4sXG4gIHJ1bkhvb2tcbn0gZnJvbSAnQHJvb3QvYXBpL3V0aWxzJ1xuaW1wb3J0IHsgSUNvbHVtblJlbGF0aW9uLCBJVGFibGVJbmZvIH0gZnJvbSAnQHJvb3QvY29uZmlnR2VuZXJhdG9yJ1xuaW1wb3J0IEJsdWViaXJkIGZyb20gJ2JsdWViaXJkJ1xuaW1wb3J0IERlYnVnIGZyb20gJ2RlYnVnJ1xuaW1wb3J0IHsgTmV4dEZ1bmN0aW9uLCBSZXF1ZXN0IH0gZnJvbSAnZXhwcmVzcydcbmltcG9ydCBLbmV4IGZyb20gJ0tuZXgnXG5cbmNvbnN0IGRlYnVnID0gRGVidWcoJ2Z1bmZ1bnptYzpjb250cm9sbGVyLXRhYmxlJylcblxuaW50ZXJmYWNlIElUb1JlcXVlc3RJdGVtIHtcbiAgdmFsdWVzOiBTZXQ8bnVtYmVyPixcbiAga2V5OiBzdHJpbmcsXG4gIGRpc3BsYXk6IHN0cmluZyxcbiAgZm9yZWlnbktleUNvbHVtbjogc3RyaW5nXG59XG5cbmludGVyZmFjZSBJVG9SZXF1ZXN0IHtcbiAgW2tleTogc3RyaW5nXTogSVRvUmVxdWVzdEl0ZW0sXG59XG5cbmZ1bmN0aW9uIHRvUmVxdWVzdEJ1aWxkZXIocmVsYXRpb246IElDb2x1bW5SZWxhdGlvbiwgY29sdW1uTmFtZTogc3RyaW5nKTogSVRvUmVxdWVzdEl0ZW0ge1xuICByZXR1cm4ge1xuICAgIHZhbHVlczogbmV3IFNldDxudW1iZXI+KCksXG4gICAga2V5OiByZWxhdGlvbi5rZXksXG4gICAgZGlzcGxheTogcmVsYXRpb24uZGlzcGxheSxcbiAgICBmb3JlaWduS2V5Q29sdW1uOiBjb2x1bW5OYW1lLFxuICB9XG59XG5cbmNsYXNzIFRhYmxlQ29udHJvbGxlciB7XG4gIGNvbnN0cnVjdG9yKCkge1xuICAgIGRlYnVnKCdDcmVhdGVkJylcbiAgfVxuXG4gIHB1YmxpYyBnZXRUYWJsZUNvbmZpZyhyZXE6IElNQ1JlcXVlc3QsIHJlczogSU1DUmVzcG9uc2UsIG5leHQ6IE5leHRGdW5jdGlvbikge1xuICAgIGNvbnN0IFRBQkxFX0NPTkZJRyA9IGdldFRhYmxlQ29uZmlnKHJlcS5wYXJhbXMudGFibGUpXG4gICAgY29uc3QgUkVTVUxUID0ge1xuICAgICAgY29sdW1uczogVEFCTEVfQ09ORklHLmNvbHVtbnMsXG4gICAgICBuYW1lOiBUQUJMRV9DT05GSUcubmFtZSxcbiAgICAgIHBrOiBUQUJMRV9DT05GSUcucGssXG4gICAgICB2ZXJib3NlOiBUQUJMRV9DT05GSUcudmVyYm9zZSxcbiAgICB9XG5cbiAgICBpZiAoaGFzQXV0aG9yaXphdGlvbihUQUJMRV9DT05GSUcucm9sZXMsIHJlcS51c2VyKSkge1xuICAgICAgYWRkVG9SZXNwb25zZShyZXMsICdyZXN1bHRzJykoUkVTVUxUKVxuICAgICAgcmV0dXJuIG5leHRBbmRSZXR1cm4obmV4dCkoUkVTVUxUKVxuICAgIH0gZWxzZSB7XG4gICAgICByZXR1cm4gY2F0Y2hNaWRkbGV3YXJlKG5leHQpKG5ldyBIdHRwRXhjZXB0aW9uKDQwMSwgJ05vdCBhdXRob3JpemVkJykpXG4gICAgfVxuICB9XG5cbiAgcHVibGljIGdldFRhYmxlRGF0YShyZXE6IElNQ1JlcXVlc3QsIHJlczogSU1DUmVzcG9uc2UsIG5leHQ6IE5leHRGdW5jdGlvbikge1xuICAgIGNvbnN0IFBBR0VfTlVNQkVSID0gcmVxLnF1ZXJ5LnBhZ2UgfHwgMFxuICAgIGNvbnN0IFRBQkxFX05BTUUgPSByZXEucGFyYW1zLnRhYmxlXG4gICAgY29uc3QgVEFCTEVfQ09ORklHID0gZ2V0VGFibGVDb25maWcoVEFCTEVfTkFNRSlcbiAgICBjb25zdCBDT0xVTU5TID0gZmlsdGVyVmlzaWJsZVRhYmxlQ29sdW1ucyhUQUJMRV9DT05GSUcsICdtYWluJylcbiAgICBsZXQgTElNSVQgPSAxMFxuXG4gICAgaWYgKCFoYXNBdXRob3JpemF0aW9uKFRBQkxFX0NPTkZJRy5yb2xlcywgcmVxLnVzZXIpKSB7XG4gICAgICByZXR1cm4gY2F0Y2hNaWRkbGV3YXJlKG5leHQpKG5ldyBIdHRwRXhjZXB0aW9uKDQwMSwgJ05vdCBhdXRob3JpemVkJykpXG4gICAgfVxuICAgIGlmICghZGF0YWJhc2UuZGIpIHtcbiAgICAgIHJldHVybiBjYXRjaE1pZGRsZXdhcmUobmV4dCkobmV3IEh0dHBFeGNlcHRpb24oNTAwLCAnTm8gZGF0YWJhc2UnKSlcbiAgICB9XG4gICAgY29uc3QgREIgPSBkYXRhYmFzZS5kYlxuICAgIGxldCBRVUVSWSA9IERCLnNlbGVjdChDT0xVTU5TKS5mcm9tKFRBQkxFX05BTUUpXG4gICAgaWYgKHJlcS5xdWVyeS5maWx0ZXIpIHtcbiAgICAgIFFVRVJZID0gYXBwbHlRdWVyeUZpbHRlcnMoUVVFUlksIHJlcS5xdWVyeS5maWx0ZXIsIFRBQkxFX0NPTkZJRylcbiAgICB9XG5cbiAgICBpZiAocmVxLnF1ZXJ5LmxpbWl0KSB7XG4gICAgICBMSU1JVCA9IHBhcnNlSW50KHJlcS5xdWVyeS5saW1pdCwgMTApXG4gICAgfVxuICAgIGlmIChMSU1JVCA+IDApIHtcbiAgICAgIFFVRVJZLm9mZnNldCgoUEFHRV9OVU1CRVIpICogTElNSVQpLmxpbWl0KExJTUlUKVxuICAgIH1cblxuICAgIHJldHVybiBydW5Ib29rKFRBQkxFX0NPTkZJRywgJ2dldFRhYmxlRGF0YScsICdiZWZvcmUnLCByZXEsIHJlcywgZGF0YWJhc2UuZGIpLnRoZW4oXG4gICAgICAoaG9va1Jlc3VsdCkgPT4ge1xuICAgICAgICBpZiAoaG9va1Jlc3VsdCkge1xuICAgICAgICAgIGlmIChob29rUmVzdWx0LmZpbHRlcikge1xuICAgICAgICAgICAgT2JqZWN0LmtleXMoaG9va1Jlc3VsdC5maWx0ZXIpLmZvckVhY2goXG4gICAgICAgICAgICAgIChjb2x1bW4pID0+IHtcbiAgICAgICAgICAgICAgICBpZiAoQXJyYXkuaXNBcnJheShob29rUmVzdWx0LmZpbHRlcltjb2x1bW5dKSkge1xuICAgICAgICAgICAgICAgICAgUVVFUlkud2hlcmVJbihjb2x1bW4sIGhvb2tSZXN1bHQuZmlsdGVyW2NvbHVtbl0pXG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICB9XG4gICAgICAgICAgICApXG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIHJldHVybiBRVUVSWVxuICAgICAgfVxuICAgICkudGhlbihcbiAgICAgIChyZXN1bHRzKSA9PiB7XG4gICAgICAgIGlmIChyZXEucXVlcnkuZnJpZW5kbHlEYXRhKSB7XG4gICAgICAgICAgcmV0dXJuIHRoaXMuYWRkVmVyYm9zZVJlbGF0ZWREYXRhKHJlc3VsdHMsIFRBQkxFX0NPTkZJRywgREIpXG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIHJlc3VsdHNcbiAgICAgIH1cbiAgICApLnRoZW4oXG4gICAgICAocmVzdWx0cykgPT4ge1xuICAgICAgICByZXR1cm4gcnVuSG9vayhUQUJMRV9DT05GSUcsICdnZXRUYWJsZURhdGEnLCAnYWZ0ZXInLCByZXEsIHJlcywgZGF0YWJhc2UuZGIsIHJlc3VsdHMpXG4gICAgICB9XG4gICAgKS50aGVuKFxuICAgICAgYWRkVG9SZXNwb25zZShyZXMsICdyZXN1bHRzJylcbiAgICApLnRoZW4oXG4gICAgICBuZXh0QW5kUmV0dXJuKG5leHQpXG4gICAgKVxuICB9XG5cbiAgcHVibGljIGdldFRhYmxlQ291bnQocmVxOiBJTUNSZXF1ZXN0LCByZXM6IElNQ1Jlc3BvbnNlLCBuZXh0OiBOZXh0RnVuY3Rpb24pIHtcbiAgICBjb25zdCBUQUJMRV9OQU1FID0gcmVxLnBhcmFtcy50YWJsZVxuICAgIGNvbnN0IFRBQkxFX0NPTkZJRyA9IGdldFRhYmxlQ29uZmlnKFRBQkxFX05BTUUpXG5cbiAgICBpZiAoIWhhc0F1dGhvcml6YXRpb24oVEFCTEVfQ09ORklHLnJvbGVzLCByZXEudXNlcikpIHtcbiAgICAgIHJldHVybiBjYXRjaE1pZGRsZXdhcmUobmV4dCkobmV3IEh0dHBFeGNlcHRpb24oNDAxLCAnTm90IGF1dGhvcml6ZWQnKSlcbiAgICB9IGVsc2Uge1xuICAgICAgaWYgKCFkYXRhYmFzZS5kYikge1xuICAgICAgICByZXR1cm4gY2F0Y2hNaWRkbGV3YXJlKG5leHQpKG5ldyBIdHRwRXhjZXB0aW9uKDUwMCwgJ05vIGRhdGFiYXNlJykpXG4gICAgICB9IGVsc2Uge1xuICAgICAgICByZXR1cm4gZGF0YWJhc2UuZGIuc2VsZWN0KCcqJykuZnJvbShUQUJMRV9OQU1FKS50aGVuKFxuICAgICAgICAgIChyZXN1bHRzKSA9PiB7XG4gICAgICAgICAgICBydW5Ib29rKFRBQkxFX0NPTkZJRywgJ2dldFRhYmxlQ291bnQnLCAnYWZ0ZXInLCByZXEsIHJlcywgZGF0YWJhc2UuZGIsIHJlc3VsdHMpLnRoZW4oXG4gICAgICAgICAgICAgIGFkZFRvUmVzcG9uc2UocmVzLCAnY291bnQnKVxuICAgICAgICAgICAgKS50aGVuKFxuICAgICAgICAgICAgICBuZXh0QW5kUmV0dXJuKG5leHQpXG4gICAgICAgICAgICApXG4gICAgICAgICAgfVxuICAgICAgICApXG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgcHVibGljIGdldFJvdyhyZXE6IElNQ1JlcXVlc3QsIHJlczogSU1DUmVzcG9uc2UsIG5leHQ6IE5leHRGdW5jdGlvbikge1xuICAgIGNvbnN0IFRBQkxFX05BTUUgPSByZXEucGFyYW1zLnRhYmxlXG4gICAgY29uc3QgVEFCTEVfQ09ORklHID0gZ2V0VGFibGVDb25maWcoVEFCTEVfTkFNRSlcblxuICAgIGlmICghaGFzQXV0aG9yaXphdGlvbihUQUJMRV9DT05GSUcucm9sZXMsIHJlcS51c2VyKSkge1xuICAgICAgcmV0dXJuIGNhdGNoTWlkZGxld2FyZShuZXh0KShuZXcgSHR0cEV4Y2VwdGlvbig0MDEsICdOb3QgYXV0aG9yaXplZCcpKVxuICAgIH0gZWxzZSB7XG4gICAgICBpZiAoIWRhdGFiYXNlLmRiKSB7XG4gICAgICAgIHJldHVybiBjYXRjaE1pZGRsZXdhcmUobmV4dCkobmV3IEh0dHBFeGNlcHRpb24oNTAwLCAnTm8gZGF0YWJhc2UnKSlcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGNvbnN0IHJlcXVlc3RlZENvbHVtbnMgPSBmaWx0ZXJWaXNpYmxlVGFibGVDb2x1bW5zKFRBQkxFX0NPTkZJRywgJ2RldGFpbCcpXG5cbiAgICAgICAgY29uc3QgcXVlcnkgPSBkYXRhYmFzZS5kYi5zZWxlY3QocmVxdWVzdGVkQ29sdW1ucylcbiAgICAgICAgICAuZnJvbShgJHtyZXEucGFyYW1zLnRhYmxlfWApXG4gICAgICAgICAgLndoZXJlKGBpZGAsIHJlcS5wYXJhbXMuaWQpXG5cbiAgICAgICAgcmV0dXJuIHF1ZXJ5LnRoZW4oXG4gICAgICAgICAgKHJlc3VsdHMpID0+IHtcbiAgICAgICAgICAgIGxldCByZWxhdGlvblF1ZXJpZXM6IEFycmF5PEJsdWViaXJkPHt9Pj4gPSBbXVxuICAgICAgICAgICAgaWYgKHJlcS5xdWVyeS5pbmNsdWRlUmVsYXRpb25zKSB7XG4gICAgICAgICAgICAgIHJlbGF0aW9uUXVlcmllcyA9IHRoaXMuZ2V0UmVsYXRpb25RdWVyaWVzKFRBQkxFX0NPTkZJRywgcmVzdWx0c1swXS5pZClcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgaWYgKHJlbGF0aW9uUXVlcmllcy5sZW5ndGgpIHtcbiAgICAgICAgICAgICAgcmV0dXJuIFByb21pc2UuYWxsKFtcbiAgICAgICAgICAgICAgICByZXN1bHRzWzBdLFxuICAgICAgICAgICAgICAgIC4uLnJlbGF0aW9uUXVlcmllcyxcbiAgICAgICAgICAgICAgXSlcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgcmV0dXJuIFByb21pc2UuYWxsKFtcbiAgICAgICAgICAgICAgcmVzdWx0c1swXSxcbiAgICAgICAgICAgIF0pXG4gICAgICAgICAgfVxuICAgICAgICApLnRoZW4oXG4gICAgICAgICAgdGhpcy5tZXJnZVJlbGF0ZWREYXRhXG4gICAgICAgICkudGhlbihcbiAgICAgICAgICBhZGRUb1Jlc3BvbnNlKHJlcywgJ3Jlc3VsdCcpXG4gICAgICAgICkudGhlbihcbiAgICAgICAgICBuZXh0QW5kUmV0dXJuKG5leHQpXG4gICAgICAgIClcbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICBwdWJsaWMgaW5zZXJ0Um93KHJlcTogUmVxdWVzdCwgcmVzOiBJTUNSZXNwb25zZSwgbmV4dDogTmV4dEZ1bmN0aW9uKSB7XG4gICAgaWYgKCFkYXRhYmFzZS5kYikge1xuICAgICAgcmV0dXJuIGNhdGNoTWlkZGxld2FyZShuZXh0KShuZXcgSHR0cEV4Y2VwdGlvbig1MDAsICdObyBkYXRhYmFzZScpKVxuICAgIH0gZWxzZSB7XG4gICAgICByZXR1cm4gZGF0YWJhc2UuZGIocmVxLnBhcmFtcy50YWJsZSkuaW5zZXJ0KHJlcS5ib2R5LmRhdGEpLnRoZW4oXG4gICAgICAgIGFkZFRvUmVzcG9uc2UocmVzLCAncmVzdWx0cycpXG4gICAgICApLnRoZW4oXG4gICAgICAgIG5leHRBbmRSZXR1cm4obmV4dClcbiAgICAgIClcbiAgICB9XG4gIH1cblxuICBwdWJsaWMgdXBkYXRlUm93KHJlcTogUmVxdWVzdCwgcmVzOiBJTUNSZXNwb25zZSwgbmV4dDogTmV4dEZ1bmN0aW9uKSB7XG4gICAgaWYgKCFkYXRhYmFzZS5kYikge1xuICAgICAgcmV0dXJuIGNhdGNoTWlkZGxld2FyZShuZXh0KShuZXcgSHR0cEV4Y2VwdGlvbig1MDAsICdObyBkYXRhYmFzZScpKVxuICAgIH1cbiAgICBjb25zdCBUQUJMRV9OQU1FID0gcmVxLnBhcmFtcy50YWJsZVxuICAgIGNvbnN0IFRBQkxFX0NPTkZJRyA9IGdldFRhYmxlQ29uZmlnKFRBQkxFX05BTUUpXG5cbiAgICBUQUJMRV9DT05GSUcuY29sdW1ucy5mb3JFYWNoKFxuICAgICAgKGNvbHVtbikgPT4ge1xuICAgICAgICBpZiAoY29sdW1uLnR5cGUgPT09ICdkYXRldGltZScpIHtcbiAgICAgICAgICByZXEuYm9keS5kYXRhW2NvbHVtbi5uYW1lXSA9IG5ldyBEYXRlKHJlcS5ib2R5LmRhdGFbY29sdW1uLm5hbWVdIHx8IG51bGwpXG4gICAgICAgIH1cbiAgICAgIH1cbiAgICApXG4gICAgcmV0dXJuIGRhdGFiYXNlLmRiKFRBQkxFX05BTUUpLndoZXJlKCdpZCcsIHJlcS5wYXJhbXMuaWQpLnVwZGF0ZShyZXEuYm9keS5kYXRhKS50aGVuKFxuICAgICAgYWRkVG9SZXNwb25zZShyZXMsICdyZXN1bHRzJylcbiAgICApLnRoZW4oXG4gICAgICBuZXh0QW5kUmV0dXJuKG5leHQpXG4gICAgKVxuICB9XG5cbiAgcHVibGljIGRlbGV0ZVJvdyhyZXE6IFJlcXVlc3QsIHJlczogSU1DUmVzcG9uc2UsIG5leHQ6IE5leHRGdW5jdGlvbikge1xuICAgIGlmICghZGF0YWJhc2UuZGIpIHtcbiAgICAgIHJldHVybiBjYXRjaE1pZGRsZXdhcmUobmV4dCkobmV3IEh0dHBFeGNlcHRpb24oNTAwLCAnTm8gZGF0YWJhc2UnKSlcbiAgICB9IGVsc2Uge1xuICAgICAgcmV0dXJuIGRhdGFiYXNlLmRiKHJlcS5wYXJhbXMudGFibGUpLndoZXJlKCdpZCcsIHJlcS5wYXJhbXMuaWQpLmRlbCgpLnRoZW4oXG4gICAgICAgIGFkZFRvUmVzcG9uc2UocmVzLCAncmVzdWx0cycpXG4gICAgICApLnRoZW4oXG4gICAgICAgIG5leHRBbmRSZXR1cm4obmV4dClcbiAgICAgIClcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIGFkZFZlcmJvc2VSZWxhdGVkRGF0YShyZXN1bHRzOiBhbnlbXSwgVEFCTEVfQ09ORklHOiBJVGFibGVJbmZvLCBEQjogS25leCkge1xuICAgIGNvbnN0IHRvUmVxdWVzdDogSVRvUmVxdWVzdCA9IHt9XG4gICAgY29uc3QgQ09MVU1OU19XSVRIX1JFTEFUSU9OUyA9IGdldENvbHVtbnNXaXRoUmVsYXRpb25zKFRBQkxFX0NPTkZJRylcbiAgICByZXN1bHRzLmZvckVhY2goXG4gICAgICAocm93OiBhbnksIGluZGV4OiBudW1iZXIpID0+IHtcbiAgICAgICAgQ09MVU1OU19XSVRIX1JFTEFUSU9OUy5mb3JFYWNoKFxuICAgICAgICAgIChjb2x1bW4pID0+IHtcbiAgICAgICAgICAgIGlmICghY29sdW1uLnJlbGF0aW9uKSB7XG4gICAgICAgICAgICAgIHRocm93IG5ldyBIdHRwRXhjZXB0aW9uKDUwMCwgJ0NvbHVtbiBzaG91bGQgaGF2ZSBhIHJlbGF0aW9uJylcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGNvbnN0IFJFTEFUSU9OX1RBQkxFX05BTUUgPSBjb2x1bW4ucmVsYXRpb24udGFibGVcblxuICAgICAgICAgICAgaWYgKCF0b1JlcXVlc3RbUkVMQVRJT05fVEFCTEVfTkFNRV0pIHtcbiAgICAgICAgICAgICAgdG9SZXF1ZXN0W1JFTEFUSU9OX1RBQkxFX05BTUVdID0gdG9SZXF1ZXN0QnVpbGRlcihjb2x1bW4ucmVsYXRpb24sIGNvbHVtbi5uYW1lKVxuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICB0b1JlcXVlc3RbUkVMQVRJT05fVEFCTEVfTkFNRV0udmFsdWVzLmFkZChyb3dbY29sdW1uLm5hbWVdKVxuICAgICAgICAgIH1cbiAgICAgICAgKVxuICAgICAgfVxuICAgIClcblxuICAgIGNvbnN0IHJlbGF0aW9uUXVlcmllczogS25leC5RdWVyeUJ1aWxkZXJbXSA9IFtdXG4gICAgT2JqZWN0LmtleXModG9SZXF1ZXN0KS5mb3JFYWNoKFxuICAgICAgKHRhYmxlTmFtZSkgPT4ge1xuICAgICAgICByZWxhdGlvblF1ZXJpZXMucHVzaChcbiAgICAgICAgICBEQi5zZWxlY3QodG9SZXF1ZXN0W3RhYmxlTmFtZV0uZGlzcGxheSwgdG9SZXF1ZXN0W3RhYmxlTmFtZV0ua2V5KVxuICAgICAgICAgICAgLmZyb20odGFibGVOYW1lKVxuICAgICAgICAgICAgLndoZXJlSW4odG9SZXF1ZXN0W3RhYmxlTmFtZV0ua2V5LCBBcnJheS5mcm9tKHRvUmVxdWVzdFt0YWJsZU5hbWVdLnZhbHVlcy52YWx1ZXMoKSkpXG4gICAgICAgIClcbiAgICAgIH1cbiAgICApXG5cbiAgICByZXR1cm4gUHJvbWlzZS5hbGw8YW55W10+KHJlbGF0aW9uUXVlcmllcykudGhlbihcbiAgICAgIChyZWxhdGlvblJlc3VsdHMpID0+IHtcbiAgICAgICAgY29uc3QgTUFUQ0hFUjoge1xuICAgICAgICAgIFtmb3JlaWduS2V5Q29sdW1uOiBzdHJpbmddOiB7XG4gICAgICAgICAgICBbdmFsdWU6IHN0cmluZ106IHN0cmluZ1xuICAgICAgICAgIH1cbiAgICAgICAgfSA9IHt9XG4gICAgICAgIE9iamVjdC52YWx1ZXModG9SZXF1ZXN0KS5mb3JFYWNoKFxuICAgICAgICAgIChyZXF1ZXN0ZWRUYWJsZSwgaW5kZXgpID0+IHtcbiAgICAgICAgICAgIGNvbnN0IEZPUkVJR05fS0VZX0NPTFVNTiA9IHJlcXVlc3RlZFRhYmxlLmZvcmVpZ25LZXlDb2x1bW5cbiAgICAgICAgICAgIE1BVENIRVJbRk9SRUlHTl9LRVlfQ09MVU1OXSA9IHt9XG4gICAgICAgICAgICByZWxhdGlvblJlc3VsdHNbaW5kZXhdLmZvckVhY2goXG4gICAgICAgICAgICAgIChyZWxhdGlvblJvdzogYW55KSA9PiB7XG4gICAgICAgICAgICAgICAgY29uc3QgQ1VSUkVOVF9WQUxVRSA9IHJlbGF0aW9uUm93W3JlcXVlc3RlZFRhYmxlLmtleV1cbiAgICAgICAgICAgICAgICBjb25zdCBWQUxVRV9UT19ESVNQTEFZID0gcmVsYXRpb25Sb3dbcmVxdWVzdGVkVGFibGUuZGlzcGxheV1cbiAgICAgICAgICAgICAgICBNQVRDSEVSW0ZPUkVJR05fS0VZX0NPTFVNTl1bQ1VSUkVOVF9WQUxVRV0gPSBWQUxVRV9UT19ESVNQTEFZXG4gICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIClcbiAgICAgICAgICB9XG4gICAgICAgIClcbiAgICAgICAgcmV0dXJuIHJlc3VsdHMubWFwKFxuICAgICAgICAgIChyb3c6IGFueSkgPT4ge1xuICAgICAgICAgICAgT2JqZWN0LnZhbHVlcyh0b1JlcXVlc3QpLmZvckVhY2goXG4gICAgICAgICAgICAgIChyZXF1ZXN0ZWRUYWJsZSkgPT4ge1xuICAgICAgICAgICAgICAgIGNvbnN0IFJPV19LRVkgPSByZXF1ZXN0ZWRUYWJsZS5mb3JlaWduS2V5Q29sdW1uXG4gICAgICAgICAgICAgICAgcm93W1JPV19LRVldID0gTUFUQ0hFUltST1dfS0VZXVtyb3dbUk9XX0tFWV1dXG4gICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIClcbiAgICAgICAgICAgIHJldHVybiByb3dcbiAgICAgICAgICB9XG4gICAgICAgIClcbiAgICAgIH1cbiAgICApXG4gIH1cblxuICBwcml2YXRlIGdldFJlbGF0aW9uUXVlcmllcyhUQUJMRV9DT05GSUc6IElUYWJsZUluZm8sIHBhcmVudElkOiBhbnkpIHtcbiAgICBjb25zdCByZWxhdGlvblF1ZXJpZXM6IEFycmF5PEJsdWViaXJkPHt9Pj4gPSBbXVxuICAgIGlmIChUQUJMRV9DT05GSUcucmVsYXRpb25zICYmIFRBQkxFX0NPTkZJRy5yZWxhdGlvbnMubWFueVRvT25lKSB7XG4gICAgICBjb25zdCBNQU5ZX1RPX09ORSA9IFRBQkxFX0NPTkZJRy5yZWxhdGlvbnMubWFueVRvT25lXG4gICAgICBjb25zdCBLRVlTOiBzdHJpbmdbXSA9IE9iamVjdC5rZXlzKE1BTllfVE9fT05FKVxuICAgICAgS0VZUy5mb3JFYWNoKFxuICAgICAgICAodGFibGVOYW1lKSA9PiB7XG4gICAgICAgICAgcmVsYXRpb25RdWVyaWVzLnB1c2goXG4gICAgICAgICAgICB0aGlzLmdldFJlbGF0ZWRSb3coXG4gICAgICAgICAgICAgIHRhYmxlTmFtZSxcbiAgICAgICAgICAgICAgTUFOWV9UT19PTkVbdGFibGVOYW1lXSxcbiAgICAgICAgICAgICAgcGFyZW50SWRcbiAgICAgICAgICAgIClcbiAgICAgICAgICApXG4gICAgICAgIH1cbiAgICAgIClcbiAgICB9XG5cbiAgICByZXR1cm4gcmVsYXRpb25RdWVyaWVzXG4gIH1cblxuICBwcml2YXRlIGdldFJlbGF0ZWRSb3codGFibGVOYW1lOiBzdHJpbmcsIGNvbHVtbk5hbWU6IHN0cmluZywgcGFyZW50SWQ6IGFueSkge1xuICAgIGlmICghZGF0YWJhc2UuZGIpIHtcbiAgICAgIHRocm93IG5ldyBIdHRwRXhjZXB0aW9uKDUwMCwgJ05vIGRhdGFiYXNlJylcbiAgICB9XG4gICAgY29uc3QgVEFCTEVfTkFNRSA9IHRhYmxlTmFtZVxuICAgIGNvbnN0IFRBQkxFX0NPTkZJRyA9IGdldFRhYmxlQ29uZmlnKFRBQkxFX05BTUUpXG5cbiAgICBjb25zdCByZXF1ZXN0ZWRDb2x1bW5zID0gZmlsdGVyVmlzaWJsZVRhYmxlQ29sdW1ucyhUQUJMRV9DT05GSUcsICdkZXRhaWwnKVxuICAgIHJldHVybiBkYXRhYmFzZS5kYi5zZWxlY3QocmVxdWVzdGVkQ29sdW1ucylcbiAgICAgIC5mcm9tKHRhYmxlTmFtZSlcbiAgICAgIC53aGVyZShjb2x1bW5OYW1lLCBwYXJlbnRJZCkudGhlbihcbiAgICAgICAgKHJlc3VsdHMpID0+ICh7XG4gICAgICAgICAgcmVzdWx0cyxcbiAgICAgICAgICB0YWJsZU5hbWUsXG4gICAgICAgIH0pXG4gICAgICApXG4gIH1cblxuICBwcml2YXRlIG1lcmdlUmVsYXRlZERhdGEoW3Jlc3VsdHMsIC4uLnJlbGF0aW9uc106IGFueSkge1xuICAgIGlmIChyZWxhdGlvbnMgJiYgcmVsYXRpb25zLmxlbmd0aCkge1xuICAgICAgcmVsYXRpb25zLmZvckVhY2goXG4gICAgICAgIChyZWxhdGlvbjoge3RhYmxlTmFtZTogc3RyaW5nLCByZXN1bHRzOiBhbnlbXX0pID0+IHtcbiAgICAgICAgICByZXN1bHRzW3JlbGF0aW9uLnRhYmxlTmFtZV0gPSByZWxhdGlvbi5yZXN1bHRzXG4gICAgICAgIH1cbiAgICAgIClcbiAgICB9XG5cbiAgICByZXR1cm4gcmVzdWx0c1xuICB9XG59XG5cbmV4cG9ydCBkZWZhdWx0IFRhYmxlQ29udHJvbGxlclxuIl19