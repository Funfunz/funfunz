"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.catchMiddleware = catchMiddleware;
exports.buildError = buildError;
exports.addToResponse = addToResponse;
exports.nextAndReturn = nextAndReturn;
exports.hasAuthorization = hasAuthorization;
exports.filterVisibleTableColumns = filterVisibleTableColumns;
exports.runHook = runHook;
exports.getTableConfig = getTableConfig;
exports.getColumnsByName = getColumnsByName;
exports.getColumnsWithRelations = getColumnsWithRelations;
exports.applyQueryFilters = applyQueryFilters;
exports.applyQuerySearch = applyQuerySearch;
exports.errorHandler = void 0;

var _types = require("../types");

var _configLoader = _interopRequireDefault(require("./configLoader"));

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

function _objectSpread(target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i] != null ? arguments[i] : {}; var ownKeys = Object.keys(source); if (typeof Object.getOwnPropertySymbols === 'function') { ownKeys = ownKeys.concat(Object.getOwnPropertySymbols(source).filter(function (sym) { return Object.getOwnPropertyDescriptor(source, sym).enumerable; })); } ownKeys.forEach(function (key) { _defineProperty(target, key, source[key]); }); } return target; }

function _defineProperty(obj, key, value) { if (key in obj) { Object.defineProperty(obj, key, { value: value, enumerable: true, configurable: true, writable: true }); } else { obj[key] = value; } return obj; }

function catchMiddleware(next) {
  return function (err) {
    if (next) {
      next(err);
    }

    return Promise.reject({
      error: err
    });
  };
}

function buildError(message, status) {
  var err = new _types.HttpException(status, message);
  return err;
}

function addToResponse(res, target) {
  return function (data) {
    if (res) {
      res.data = _objectSpread({}, res.data, _defineProperty({}, target, data));
      return res;
    }

    throw buildError('Response object not valid', 500);
  };
}

function nextAndReturn(next) {
  return function (data) {
    if (next) {
      next();
    }

    return Promise.resolve(data);
  };
} // error handler


var errorHandler = function errorHandler(err, req, res) {
  res.status(err.status || 500);
  res.json({
    message: err.message
  });
};

exports.errorHandler = errorHandler;

function hasAuthorization(tableRoles) {
  var user = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : {
    roles: []
  };
  var isAuthorized = 'true';

  if (tableRoles && tableRoles.length) {
    isAuthorized = tableRoles.find(function (tableRole) {
      if (tableRole === 'all') {
        return true;
      }

      var userHasAuthorization = user.roles.find(function (userRole) {
        return userRole.name === tableRole;
      });
      return userHasAuthorization ? true : false;
    });
  }

  return isAuthorized ? true : false;
}

function filterVisibleTableColumns(table, target) {
  var toKeep = {};

  if (table.chips) {
    table.chips.forEach(function (chip) {
      chip.columns.forEach(function (column) {
        toKeep[column.name] = true;
      });
    });
  }

  return table.columns.filter(function (column) {
    return column.visible[target] || column.name === table.pk || toKeep[column.name];
  }).map(function (column) {
    return column.name;
  });
}

function runHook(TABLE, hook, instance, req, res, database, results) {
  if (TABLE.hooks && TABLE.hooks[hook]) {
    var HOOK = TABLE.hooks[hook];

    if (database && HOOK && HOOK[instance]) {
      var CALLER = HOOK[instance];
      return CALLER ? instance === 'before' ? CALLER(req, res, database, TABLE.name) : CALLER(req, res, database, TABLE.name, results) : Promise.resolve(hook === 'getTableCount' ? results.length : results);
    }
  }

  return Promise.resolve(hook === 'getTableCount' ? results.length : results);
}

function getTableConfig(TABLE_NAME) {
  return (0, _configLoader.default)().settings.filter(function (tableItem) {
    return tableItem.name === TABLE_NAME;
  })[0];
}

function getColumnsByName(TABLE_CONFIG) {
  var columnsByName = {};
  TABLE_CONFIG.columns.forEach(function (column) {
    columnsByName[column.name] = column;
  });
  return columnsByName;
}

function getColumnsWithRelations(TABLE_CONFIG) {
  return TABLE_CONFIG.columns.filter(function (column) {
    return column.relation;
  });
}

function applyQueryFilters(QUERY, filters, TABLE_CONFIG) {
  var columnsByName = getColumnsByName(TABLE_CONFIG);
  var FILTERS = JSON.parse(filters);
  Object.keys(FILTERS).forEach(function (key, index) {
    if (columnsByName[key].type === 'int(11)') {
      index === 0 ? QUERY.where(_defineProperty({}, key, FILTERS[key])) : QUERY.andWhere(_defineProperty({}, key, FILTERS[key]));
    } else {
      index === 0 ? QUERY.where(key, 'like', '%' + FILTERS[key] + '%') : QUERY.andWhere(key, 'like', '%' + FILTERS[key] + '%');
    }
  });
  return QUERY;
}

function applyQuerySearch(QUERY, search, TABLE_CONFIG) {
  var searchFields = TABLE_CONFIG.searchFields || [];
  QUERY.where(function () {
    var _this = this;

    searchFields.forEach(function (searchField, index) {
      index === 0 ? _this.where(searchField, 'like', '%' + search + '%') : _this.orWhere(searchField, 'like', '%' + search + '%');
    });
  });
  return QUERY;
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9hcGkvdXRpbHMvaW5kZXgudHMiXSwibmFtZXMiOlsiY2F0Y2hNaWRkbGV3YXJlIiwibmV4dCIsImVyciIsIlByb21pc2UiLCJyZWplY3QiLCJlcnJvciIsImJ1aWxkRXJyb3IiLCJtZXNzYWdlIiwic3RhdHVzIiwiSHR0cEV4Y2VwdGlvbiIsImFkZFRvUmVzcG9uc2UiLCJyZXMiLCJ0YXJnZXQiLCJkYXRhIiwibmV4dEFuZFJldHVybiIsInJlc29sdmUiLCJlcnJvckhhbmRsZXIiLCJyZXEiLCJqc29uIiwiaGFzQXV0aG9yaXphdGlvbiIsInRhYmxlUm9sZXMiLCJ1c2VyIiwicm9sZXMiLCJpc0F1dGhvcml6ZWQiLCJsZW5ndGgiLCJmaW5kIiwidGFibGVSb2xlIiwidXNlckhhc0F1dGhvcml6YXRpb24iLCJ1c2VyUm9sZSIsIm5hbWUiLCJmaWx0ZXJWaXNpYmxlVGFibGVDb2x1bW5zIiwidGFibGUiLCJ0b0tlZXAiLCJjaGlwcyIsImZvckVhY2giLCJjaGlwIiwiY29sdW1ucyIsImNvbHVtbiIsImZpbHRlciIsInZpc2libGUiLCJwayIsIm1hcCIsInJ1bkhvb2siLCJUQUJMRSIsImhvb2siLCJpbnN0YW5jZSIsImRhdGFiYXNlIiwicmVzdWx0cyIsImhvb2tzIiwiSE9PSyIsIkNBTExFUiIsImdldFRhYmxlQ29uZmlnIiwiVEFCTEVfTkFNRSIsInNldHRpbmdzIiwidGFibGVJdGVtIiwiZ2V0Q29sdW1uc0J5TmFtZSIsIlRBQkxFX0NPTkZJRyIsImNvbHVtbnNCeU5hbWUiLCJnZXRDb2x1bW5zV2l0aFJlbGF0aW9ucyIsInJlbGF0aW9uIiwiYXBwbHlRdWVyeUZpbHRlcnMiLCJRVUVSWSIsImZpbHRlcnMiLCJGSUxURVJTIiwiSlNPTiIsInBhcnNlIiwiT2JqZWN0Iiwia2V5cyIsImtleSIsImluZGV4IiwidHlwZSIsIndoZXJlIiwiYW5kV2hlcmUiLCJhcHBseVF1ZXJ5U2VhcmNoIiwic2VhcmNoIiwic2VhcmNoRmllbGRzIiwi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R0FBZSxHQUEvQyxDQURGLEdBRUUsS0FBSSxDQUFDRyxPQUFMLENBQWFELFdBQWIsRUFBMEIsTUFBMUIsRUFBa0MsTUFBTUYsTUFBTixHQUFlLEdBQWpELENBRkY7QUFHRCxLQUxIO0FBT0QsR0FSRDtBQVVBLFNBQU9iLEtBQVA7QUFDRCIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEh0dHBFeGNlcHRpb24sIElNQ1JlcXVlc3QsIElNQ1Jlc3BvbnNlLCBJVXNlciB9IGZyb20gJ0Byb290L2FwaS90eXBlcydcbmltcG9ydCBjb25maWcgZnJvbSAnQHJvb3QvYXBpL3V0aWxzL2NvbmZpZ0xvYWRlcidcbmltcG9ydCB7IEhvb2tzLCBJQ29sdW1uSW5mbywgSVRhYmxlSW5mbyB9IGZyb20gJ0Byb290L2NvbmZpZ0dlbmVyYXRvcidcbmltcG9ydCB7IEVycm9yUmVxdWVzdEhhbmRsZXIsIE5leHRGdW5jdGlvbiB9IGZyb20gJ2V4cHJlc3MnXG5pbXBvcnQgS25leCBmcm9tICdrbmV4J1xuXG5leHBvcnQgZnVuY3Rpb24gY2F0Y2hNaWRkbGV3YXJlKG5leHQ6IE5leHRGdW5jdGlvbikge1xuICByZXR1cm4gKGVycjogSHR0cEV4Y2VwdGlvbikgPT4ge1xuICAgIGlmIChuZXh0KSB7XG4gICAgICBuZXh0KGVycilcbiAgICB9XG4gICAgcmV0dXJuIFByb21pc2UucmVqZWN0KHtcbiAgICAgIGVycm9yOiBlcnIsXG4gICAgfSlcbiAgfVxufVxuXG5leHBvcnQgZnVuY3Rpb24gYnVpbGRFcnJvcihtZXNzYWdlOiBzdHJpbmcsIHN0YXR1czogbnVtYmVyKSB7XG4gIGNvbnN0IGVyciA9IG5ldyBIdHRwRXhjZXB0aW9uKHN0YXR1cywgbWVzc2FnZSlcbiAgcmV0dXJuIGVyclxufVxuXG5leHBvcnQgZnVuY3Rpb24gYWRkVG9SZXNwb25zZShyZXM6IElNQ1Jlc3BvbnNlLCB0YXJnZXQ6IHN0cmluZykge1xuICByZXR1cm4gZnVuY3Rpb24oZGF0YTogYW55KSB7XG4gICAgaWYgKHJlcykge1xuICAgICAgcmVzLmRhdGEgPSB7XG4gICAgICAgIC4uLnJlcy5kYXRhLFxuICAgICAgICBbdGFyZ2V0XTogZGF0YSxcbiAgICAgIH1cbiAgICAgIHJldHVybiByZXNcbiAgICB9XG4gICAgdGhyb3cgYnVpbGRFcnJvcignUmVzcG9uc2Ugb2JqZWN0IG5vdCB2YWxpZCcsIDUwMClcbiAgfVxufVxuXG5leHBvcnQgZnVuY3Rpb24gbmV4dEFuZFJldHVybihuZXh0OiBOZXh0RnVuY3Rpb24pIHtcbiAgcmV0dXJuIGZ1bmN0aW9uKGRhdGE6IGFueSkge1xuICAgIGlmIChuZXh0KSB7XG4gICAgICBuZXh0KClcbiAgICB9XG4gICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZShkYXRhKVxuICB9XG59XG5cbi8vIGVycm9yIGhhbmRsZXJcbmV4cG9ydCBjb25zdCBlcnJvckhhbmRsZXI6IEVycm9yUmVxdWVzdEhhbmRsZXIgPSAoZXJyLCByZXEsIHJlcykgPT4ge1xuICByZXMuc3RhdHVzKGVyci5zdGF0dXMgfHwgNTAwKVxuICByZXMuanNvbih7XG4gICAgbWVzc2FnZTogZXJyLm1lc3NhZ2UsXG4gIH0pXG59XG5cbmV4cG9ydCBmdW5jdGlvbiBoYXNBdXRob3JpemF0aW9uKHRhYmxlUm9sZXM6IHN0cmluZ1tdLCB1c2VyOiBJVXNlciA9IHtyb2xlczogW119KTogYm9vbGVhbiB7XG4gIGxldCBpc0F1dGhvcml6ZWQ6IHN0cmluZyB8IHVuZGVmaW5lZCA9ICd0cnVlJ1xuICBpZiAodGFibGVSb2xlcyAmJiB0YWJsZVJvbGVzLmxlbmd0aCkge1xuICAgIGlzQXV0aG9yaXplZCA9IHRhYmxlUm9sZXMuZmluZChcbiAgICAgICh0YWJsZVJvbGU6IHN0cmluZykgPT4ge1xuICAgICAgICBpZiAodGFibGVSb2xlID09PSAnYWxsJykge1xuICAgICAgICAgIHJldHVybiB0cnVlXG4gICAgICAgIH1cbiAgICAgICAgY29uc3QgdXNlckhhc0F1dGhvcml6YXRpb24gPSB1c2VyLnJvbGVzLmZpbmQoXG4gICAgICAgICAgKHVzZXJSb2xlKSA9PiB7XG4gICAgICAgICAgICByZXR1cm4gKHVzZXJSb2xlLm5hbWUgPT09IHRhYmxlUm9sZSk7XG4gICAgICAgICAgfVxuICAgICAgICApXG4gICAgICAgIHJldHVybiB1c2VySGFzQXV0aG9yaXphdGlvbiA/IHRydWUgOiBmYWxzZVxuICAgICAgfVxuICAgIClcbiAgfVxuXG4gIHJldHVybiBpc0F1dGhvcml6ZWQgPyB0cnVlIDogZmFsc2Vcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGZpbHRlclZpc2libGVUYWJsZUNvbHVtbnModGFibGU6IElUYWJsZUluZm8sIHRhcmdldDogJ21haW4nIHwgJ2RldGFpbCcpIHtcbiAgY29uc3QgdG9LZWVwOiB7XG4gICAgW2tleTogc3RyaW5nXTogYm9vbGVhblxuICB9ID0ge31cbiAgaWYgKHRhYmxlLmNoaXBzKSB7XG4gICAgdGFibGUuY2hpcHMuZm9yRWFjaChcbiAgICAgIChjaGlwKSA9PiB7XG4gICAgICAgIGNoaXAuY29sdW1ucy5mb3JFYWNoKFxuICAgICAgICAgIChjb2x1bW4pID0+IHtcbiAgICAgICAgICAgIHRvS2VlcFtjb2x1bW4ubmFtZV0gPSB0cnVlXG4gICAgICAgICAgfVxuICAgICAgICApXG4gICAgICB9XG4gICAgKVxuICB9XG4gIHJldHVybiB0YWJsZS5jb2x1bW5zLmZpbHRlcihcbiAgICAoY29sdW1uKSA9PiBjb2x1bW4udmlzaWJsZVt0YXJnZXRdIHx8IGNvbHVtbi5uYW1lID09PSB0YWJsZS5wayB8fCB0b0tlZXBbY29sdW1uLm5hbWVdXG4gICkubWFwKFxuICAgIChjb2x1bW4pID0+IGNvbHVtbi5uYW1lXG4gIClcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIHJ1bkhvb2soXG4gIFRBQkxFOiBJVGFibGVJbmZvLFxuICBob29rOiBIb29rcyxcbiAgaW5zdGFuY2U6ICdhZnRlcicgfCAnYmVmb3JlJyxcbiAgcmVxOiBJTUNSZXF1ZXN0LFxuICByZXM6IElNQ1Jlc3BvbnNlLFxuICBkYXRhYmFzZTogS25leCB8IG51bGwsXG4gIHJlc3VsdHM/OiBhbnlcbikge1xuICBpZiAoVEFCTEUuaG9va3MgJiYgVEFCTEUuaG9va3NbaG9va10pIHtcbiAgICBjb25zdCBIT09LID0gVEFCTEUuaG9va3NbaG9va11cbiAgICBpZiAoZGF0YWJhc2UgJiYgSE9PSyAmJiBIT09LW2luc3RhbmNlXSkge1xuICAgICAgY29uc3QgQ0FMTEVSICA9IEhPT0tbaW5zdGFuY2VdXG4gICAgICByZXR1cm4gQ0FMTEVSID9cbiAgICAgICAgaW5zdGFuY2UgPT09ICdiZWZvcmUnID9cbiAgICAgICAgICBDQUxMRVIocmVxLCByZXMsIGRhdGFiYXNlLCBUQUJMRS5uYW1lKVxuICAgICAgICAgIDpcbiAgICAgICAgICBDQUxMRVIocmVxLCByZXMsIGRhdGFiYXNlLCBUQUJMRS5uYW1lLCByZXN1bHRzKVxuICAgICAgICA6XG4gICAgICAgIFByb21pc2UucmVzb2x2ZShob29rID09PSAnZ2V0VGFibGVDb3VudCcgPyByZXN1bHRzLmxlbmd0aCA6IHJlc3VsdHMpXG4gICAgfVxuICB9XG4gIHJldHVybiBQcm9taXNlLnJlc29sdmUoaG9vayA9PT0gJ2dldFRhYmxlQ291bnQnID8gcmVzdWx0cy5sZW5ndGggOiByZXN1bHRzKVxufVxuXG5leHBvcnQgZnVuY3Rpb24gZ2V0VGFibGVDb25maWcoVEFCTEVfTkFNRTogc3RyaW5nKSB7XG4gIHJldHVybiBjb25maWcoKS5zZXR0aW5ncy5maWx0ZXIoXG4gICAgKHRhYmxlSXRlbSkgPT4gdGFibGVJdGVtLm5hbWUgPT09IFRBQkxFX05BTUVcbiAgKVswXVxufVxuXG5leHBvcnQgZnVuY3Rpb24gZ2V0Q29sdW1uc0J5TmFtZShUQUJMRV9DT05GSUc6IElUYWJsZUluZm8pIHtcbiAgY29uc3QgY29sdW1uc0J5TmFtZToge1xuICAgIFtrZXk6IHN0cmluZ106IElDb2x1bW5JbmZvXG4gIH0gPSB7fVxuXG4gIFRBQkxFX0NPTkZJRy5jb2x1bW5zLmZvckVhY2goXG4gICAgKGNvbHVtbikgPT4ge1xuICAgICAgY29sdW1uc0J5TmFtZVtjb2x1bW4ubmFtZV0gPSBjb2x1bW5cbiAgICB9XG4gIClcblxuICByZXR1cm4gY29sdW1uc0J5TmFtZVxufVxuXG5leHBvcnQgZnVuY3Rpb24gZ2V0Q29sdW1uc1dpdGhSZWxhdGlvbnMoVEFCTEVfQ09ORklHOiBJVGFibGVJbmZvKSB7XG4gIHJldHVybiBUQUJMRV9DT05GSUcuY29sdW1ucy5maWx0ZXIoXG4gICAgKGNvbHVtbikgPT4gY29sdW1uLnJlbGF0aW9uXG4gIClcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGFwcGx5UXVlcnlGaWx0ZXJzKFFVRVJZOiBLbmV4LlF1ZXJ5QnVpbGRlciwgZmlsdGVyczogc3RyaW5nLCBUQUJMRV9DT05GSUc6IElUYWJsZUluZm8pIHtcbiAgY29uc3QgY29sdW1uc0J5TmFtZSA9IGdldENvbHVtbnNCeU5hbWUoVEFCTEVfQ09ORklHKVxuICBjb25zdCBGSUxURVJTID0gSlNPTi5wYXJzZShmaWx0ZXJzKVxuICBPYmplY3Qua2V5cyhGSUxURVJTKS5mb3JFYWNoKFxuICAgIChrZXksIGluZGV4KSA9PiB7XG4gICAgICBpZiAoY29sdW1uc0J5TmFtZVtrZXldLnR5cGUgPT09ICdpbnQoMTEpJykge1xuICAgICAgICBpbmRleCA9PT0gMCA/XG4gICAgICAgICAgUVVFUlkud2hlcmUoe1xuICAgICAgICAgICAgW2tleV06IEZJTFRFUlNba2V5XSxcbiAgICAgICAgICB9KSA6XG4gICAgICAgICAgUVVFUlkuYW5kV2hlcmUoe1xuICAgICAgICAgICAgW2tleV06IEZJTFRFUlNba2V5XSxcbiAgICAgICAgICB9KVxuICAgICAgfSBlbHNlIHtcbiAgICAgICAgaW5kZXggPT09IDAgP1xuICAgICAgICAgIFFVRVJZLndoZXJlKGtleSwgJ2xpa2UnLCAnJScgKyBGSUxURVJTW2tleV0gKyAnJScpIDpcbiAgICAgICAgICBRVUVSWS5hbmRXaGVyZShrZXksICdsaWtlJywgJyUnICsgRklMVEVSU1trZXldICsgJyUnKVxuICAgICAgfVxuICAgIH1cbiAgKVxuXG4gIHJldHVybiBRVUVSWVxufVxuXG5leHBvcnQgZnVuY3Rpb24gYXBwbHlRdWVyeVNlYXJjaChRVUVSWTogS25leC5RdWVyeUJ1aWxkZXIsIHNlYXJjaDogc3RyaW5nLCBUQUJMRV9DT05GSUc6IElUYWJsZUluZm8pIHtcbiAgY29uc3Qgc2VhcmNoRmllbGRzID0gVEFCTEVfQ09ORklHLnNlYXJjaEZpZWxkcyB8fCBbXVxuICBRVUVSWS53aGVyZShmdW5jdGlvbigpIHtcbiAgICBzZWFyY2hGaWVsZHMuZm9yRWFjaChcbiAgICAgIChzZWFyY2hGaWVsZCwgaW5kZXgpID0+IHtcbiAgICAgICAgaW5kZXggPT09IDAgP1xuICAgICAgICAgIHRoaXMud2hlcmUoc2VhcmNoRmllbGQsICdsaWtlJywgJyUnICsgc2VhcmNoICsgJyUnKSA6XG4gICAgICAgICAgdGhpcy5vcldoZXJlKHNlYXJjaEZpZWxkLCAnbGlrZScsICclJyArIHNlYXJjaCArICclJylcbiAgICAgIH1cbiAgICApXG4gIH0pXG5cbiAgcmV0dXJuIFFVRVJZXG59XG4iXX0=