"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.catchMiddleware = catchMiddleware;
exports.buildError = buildError;
exports.addToResponse = addToResponse;
exports.nextAndReturn = nextAndReturn;
exports.hasAuthorization = hasAuthorization;
exports.filterVisibleTableColumns = filterVisibleTableColumns;
exports.runHook = runHook;
exports.getTableConfig = getTableConfig;
exports.getColumnsByName = getColumnsByName;
exports.applyQueryFilters = applyQueryFilters;
exports.errorHandler = void 0;

var _types = require("../types");

var _configLoader = _interopRequireDefault(require("./configLoader"));

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

function _objectSpread(target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i] != null ? arguments[i] : {}; var ownKeys = Object.keys(source); if (typeof Object.getOwnPropertySymbols === 'function') { ownKeys = ownKeys.concat(Object.getOwnPropertySymbols(source).filter(function (sym) { return Object.getOwnPropertyDescriptor(source, sym).enumerable; })); } ownKeys.forEach(function (key) { _defineProperty(target, key, source[key]); }); } return target; }

function _defineProperty(obj, key, value) { if (key in obj) { Object.defineProperty(obj, key, { value: value, enumerable: true, configurable: true, writable: true }); } else { obj[key] = value; } return obj; }

function catchMiddleware(next) {
  return function (err) {
    if (next) {
      next(err);
    }

    return Promise.reject({
      error: err
    });
  };
}

function buildError(message, status) {
  var err = new _types.HttpException(status, message);
  return err;
}

function addToResponse(res, target) {
  return function (data) {
    if (res) {
      res.data = _objectSpread({}, res.data, _defineProperty({}, target, data));
      return res;
    }

    throw buildError('Response object not valid', 500);
  };
}

function nextAndReturn(next) {
  return function (data) {
    if (next) {
      next();
    }

    return Promise.resolve(data);
  };
} // error handler


var errorHandler = function errorHandler(err, req, res) {
  res.status(err.status || 500);
  res.json({
    message: err.message
  });
};

exports.errorHandler = errorHandler;

function hasAuthorization(tableRoles) {
  var user = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : {
    roles: []
  };
  var isAuthorized = 'true';

  if (tableRoles && tableRoles.length) {
    isAuthorized = tableRoles.find(function (tableRole) {
      if (tableRole === 'all') {
        return true;
      }

      var userHasAuthorization = user.roles.find(function (userRole) {
        return userRole === tableRole;
      });
      return userHasAuthorization ? true : false;
    });
  }

  return isAuthorized ? true : false;
}

function filterVisibleTableColumns(table, target) {
  return table.columns.filter(function (column) {
    return column.visible[target];
  }).map(function (column) {
    return column.name;
  });
}

function runHook(TABLE, hook, instance, req, res, database, results) {
  if (TABLE.hooks && TABLE.hooks[hook]) {
    var HOOK = TABLE.hooks[hook];

    if (database && HOOK && HOOK[instance]) {
      var CALLER = HOOK[instance];
      return CALLER ? CALLER(req, res, database, TABLE.name, results) : Promise.resolve(hook === 'getTableCount' ? results.length : results);
    }
  }

  return Promise.resolve(hook === 'getTableCount' ? results.length : results);
}

function getTableConfig(TABLE_NAME) {
  return (0, _configLoader.default)().settings.filter(function (tableItem) {
    return tableItem.name === TABLE_NAME;
  })[0];
}

function getColumnsByName(TABLE_CONFIG) {
  var columnsByName = {};
  TABLE_CONFIG.columns.forEach(function (column) {
    columnsByName[column.name] = column;
  });
  return columnsByName;
}

function applyQueryFilters(QUERY, filters, TABLE_CONFIG) {
  var columnsByName = getColumnsByName(TABLE_CONFIG);
  var FILTERS = JSON.parse(filters);
  Object.keys(FILTERS).forEach(function (key, index) {
    if (columnsByName[key].type === 'int(11)') {
      index === 0 ? QUERY.where(_defineProperty({}, key, FILTERS[key])) : QUERY.andWhere(_defineProperty({}, key, FILTERS[key]));
    } else {
      index === 0 ? QUERY.where(key, 'like', '%' + FILTERS[key] + '%') : QUERY.andWhere(key, 'like', '%' + FILTERS[key] + '%');
    }
  });
  return QUERY;
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9hcGkvdXRpbHMvaW5kZXgudHMiXSwibmFtZXMiOlsiY2F0Y2hNaWRkbGV3YXJlIiwibmV4dCIsImVyciIsIlByb21pc2UiLCJyZWplY3QiLCJlcnJvciIsImJ1aWxkRXJyb3IiLCJtZXNzYWdlIiwic3RhdHVzIiwiSHR0cEV4Y2VwdGlvbiIsImFkZFRvUmVzcG9uc2UiLCJyZXMiLCJ0YXJnZXQiLCJkYXRhIiwibmV4dEFuZFJldHVybiIsInJlc29sdmUiLCJlcnJvckhhbmRsZXIiLCJyZXEiLCJqc29uIiwiaGFzQXV0aG9yaXphdGlvbiIsInRhYmxlUm9sZXMiLCJ1c2VyIiwicm9sZXMiLCJpc0F1dGhvcml6ZWQiLCJsZW5ndGgiLCJmaW5kIiwidGFibGVSb2xlIiwidXNlckhhc0F1dGhvcml6YXRpb24iLCJ1c2VyUm9sZSIsImZpbHRlclZpc2libGVUYWJsZUNvbHVtbnMiLCJ0YWJsZSIsImNvbHVtbnMiLCJmaWx0ZXIiLCJjb2x1bW4iLCJ2aXNpYmxlIiwibWFwIiwibmFtZSIsInJ1bkhvb2siLCJUQUJMRSIsImhvb2siLCJpbnN0YW5jZSIsImRhdGFiYXNlIiwicmVzdWx0cyIsImhvb2tzIiwiSE9PSyIsIkNBTExFUiIsImdldFRhYmxlQ29uZmlnIiwiVEFCTEVfTkFNRSIsInNldHRpbmdzIiwidGFibGVJdGVtIiwiZ2V0Q29sdW1uc0J5TmFtZSIsIlRBQkxFX0NPTkZJRyIsImNvbHVtbnNCeU5hbWUiLCJmb3JFYWNoIiwiYXBwbHlRdWVyeUZpbHRlcnMiLCJRVUVSWSIsImZpbHRlcnMiLCJGSUxURVJTIiwiSlNPTiIsInBhcnNlIiwiT2JqZWN0Iiwia2V5cyIsImtleSIsImluZGV4IiwidHlwZSIsIndoZXJlIiwiYW5kV2hlcmUiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7Ozs7O0FBQUE7O0FBQ0E7Ozs7Ozs7O0FBS08sU0FBU0EsZUFBVCxDQUF5QkMsSUFBekIsRUFBNkM7QUFDbEQsU0FBTyxVQUFDQyxHQUFELEVBQXdCO0FBQzdCLFFBQUlELElBQUosRUFBVTtBQUNSQSxNQUFBQSxJQUFJLENBQUNDLEdBQUQsQ0FBSjtBQUNEOztBQUNELFdBQU9DLE9BQU8sQ0FBQ0MsTUFBUixDQUFlO0FBQ3BCQyxNQUFBQSxLQUFLLEVBQUVIO0FBRGEsS0FBZixDQUFQO0FBR0QsR0FQRDtBQVFEOztBQUVNLFNBQVNJLFVBQVQsQ0FBb0JDLE9BQXBCLEVBQXFDQyxNQUFyQyxFQUFxRDtBQUMxRCxNQUFNTixHQUFHLEdBQUcsSUFBSU8sb0JBQUosQ0FBa0JELE1BQWxCLEVBQTBCRCxPQUExQixDQUFaO0FBQ0EsU0FBT0wsR0FBUDtBQUNEOztBQUVNLFNBQVNRLGFBQVQsQ0FBdUJDLEdBQXZCLEVBQXlDQyxNQUF6QyxFQUF5RDtBQUM5RCxTQUFPLFVBQVNDLElBQVQsRUFBb0I7QUFDekIsUUFBSUYsR0FBSixFQUFTO0FBQ1BBLE1BQUFBLEdBQUcsQ0FBQ0UsSUFBSixxQkFDS0YsR0FBRyxDQUFDRSxJQURULHNCQUVHRCxNQUZILEVBRVlDLElBRlo7QUFJQSxhQUFPRixHQUFQO0FBQ0Q7O0FBQ0QsVUFBTUwsVUFBVSxDQUFDLDJCQUFELEVBQThCLEdBQTlCLENBQWhCO0FBQ0QsR0FURDtBQVVEOztBQUVNLFNBQVNRLGFBQVQsQ0FBdUJiLElBQXZCLEVBQTJDO0FBQ2hELFNBQU8sVUFBU1ksSUFBVCxFQUFvQjtBQUN6QixRQUFJWixJQUFKLEVBQVU7QUFDUkEsTUFBQUEsSUFBSTtBQUNMOztBQUNELFdBQU9FLE9BQU8sQ0FBQ1ksT0FBUixDQUFnQkYsSUFBaEIsQ0FBUDtBQUNELEdBTEQ7QUFNRCxDLENBRUQ7OztBQUNPLElBQU1HLFlBQWlDLEdBQUcsU0FBcENBLFlBQW9DLENBQUNkLEdBQUQsRUFBTWUsR0FBTixFQUFXTixHQUFYLEVBQW1CO0FBQ2xFQSxFQUFBQSxHQUFHLENBQUNILE1BQUosQ0FBV04sR0FBRyxDQUFDTSxNQUFKLElBQWMsR0FBekI7QUFDQUcsRUFBQUEsR0FBRyxDQUFDTyxJQUFKLENBQVM7QUFDUFgsSUFBQUEsT0FBTyxFQUFFTCxHQUFHLENBQUNLO0FBRE4sR0FBVDtBQUdELENBTE07Ozs7QUFPQSxTQUFTWSxnQkFBVCxDQUEwQkMsVUFBMUIsRUFBb0Y7QUFBQSxNQUFwQ0MsSUFBb0MsdUVBQXRCO0FBQUNDLElBQUFBLEtBQUssRUFBRTtBQUFSLEdBQXNCO0FBQ3pGLE1BQUlDLFlBQWdDLEdBQUcsTUFBdkM7O0FBRUEsTUFBSUgsVUFBVSxJQUFJQSxVQUFVLENBQUNJLE1BQTdCLEVBQXFDO0FBQ25DRCxJQUFBQSxZQUFZLEdBQUdILFVBQVUsQ0FBQ0ssSUFBWCxDQUNiLFVBQUNDLFNBQUQsRUFBdUI7QUFDckIsVUFBSUEsU0FBUyxLQUFLLEtBQWxCLEVBQXlCO0FBQ3ZCLGVBQU8sSUFBUDtBQUNEOztBQUNELFVBQU1DLG9CQUFvQixHQUFHTixJQUFJLENBQUNDLEtBQUwsQ0FBV0csSUFBWCxDQUMzQixVQUFDRyxRQUFELEVBQXNCO0FBQ3BCLGVBQVFBLFFBQVEsS0FBS0YsU0FBckI7QUFDRCxPQUgwQixDQUE3QjtBQUtBLGFBQU9DLG9CQUFvQixHQUFHLElBQUgsR0FBVSxLQUFyQztBQUNELEtBWFksQ0FBZjtBQWFEOztBQUVELFNBQU9KLFlBQVksR0FBRyxJQUFILEdBQVUsS0FBN0I7QUFDRDs7QUFFTSxTQUFTTSx5QkFBVCxDQUFtQ0MsS0FBbkMsRUFBc0RsQixNQUF0RCxFQUFpRjtBQUN0RixTQUFPa0IsS0FBSyxDQUFDQyxPQUFOLENBQWNDLE1BQWQsQ0FDTCxVQUFDQyxNQUFEO0FBQUEsV0FBWUEsTUFBTSxDQUFDQyxPQUFQLENBQWV0QixNQUFmLENBQVo7QUFBQSxHQURLLEVBRUx1QixHQUZLLENBR0wsVUFBQ0YsTUFBRDtBQUFBLFdBQVlBLE1BQU0sQ0FBQ0csSUFBbkI7QUFBQSxHQUhLLENBQVA7QUFLRDs7QUFFTSxTQUFTQyxPQUFULENBQ0xDLEtBREssRUFFTEMsSUFGSyxFQUdMQyxRQUhLLEVBSUx2QixHQUpLLEVBS0xOLEdBTEssRUFNTDhCLFFBTkssRUFPTEMsT0FQSyxFQVFMO0FBQ0EsTUFBSUosS0FBSyxDQUFDSyxLQUFOLElBQWVMLEtBQUssQ0FBQ0ssS0FBTixDQUFZSixJQUFaLENBQW5CLEVBQXNDO0FBQ3BDLFFBQU1LLElBQUksR0FBR04sS0FBSyxDQUFDSyxLQUFOLENBQVlKLElBQVosQ0FBYjs7QUFDQSxRQUFJRSxRQUFRLElBQUlHLElBQVosSUFBb0JBLElBQUksQ0FBQ0osUUFBRCxDQUE1QixFQUF3QztBQUN0QyxVQUFNSyxNQUFNLEdBQUlELElBQUksQ0FBQ0osUUFBRCxDQUFwQjtBQUNBLGFBQU9LLE1BQU0sR0FDWEEsTUFBTSxDQUFDNUIsR0FBRCxFQUFNTixHQUFOLEVBQVc4QixRQUFYLEVBQXFCSCxLQUFLLENBQUNGLElBQTNCLEVBQWlDTSxPQUFqQyxDQURLLEdBRVh2QyxPQUFPLENBQUNZLE9BQVIsQ0FBZ0J3QixJQUFJLEtBQUssZUFBVCxHQUEyQkcsT0FBTyxDQUFDbEIsTUFBbkMsR0FBNENrQixPQUE1RCxDQUZGO0FBR0Q7QUFDRjs7QUFDRCxTQUFPdkMsT0FBTyxDQUFDWSxPQUFSLENBQWdCd0IsSUFBSSxLQUFLLGVBQVQsR0FBMkJHLE9BQU8sQ0FBQ2xCLE1BQW5DLEdBQTRDa0IsT0FBNUQsQ0FBUDtBQUNEOztBQUVNLFNBQVNJLGNBQVQsQ0FBd0JDLFVBQXhCLEVBQTRDO0FBQ2pELFNBQU8sNkJBQVNDLFFBQVQsQ0FBa0JoQixNQUFsQixDQUNMLFVBQUNpQixTQUFEO0FBQUEsV0FBZUEsU0FBUyxDQUFDYixJQUFWLEtBQW1CVyxVQUFsQztBQUFBLEdBREssRUFFTCxDQUZLLENBQVA7QUFHRDs7QUFFTSxTQUFTRyxnQkFBVCxDQUEwQkMsWUFBMUIsRUFBb0Q7QUFDekQsTUFBTUMsYUFFTCxHQUFHLEVBRko7QUFJQUQsRUFBQUEsWUFBWSxDQUFDcEIsT0FBYixDQUFxQnNCLE9BQXJCLENBQ0UsVUFBQ3BCLE1BQUQsRUFBWTtBQUNWbUIsSUFBQUEsYUFBYSxDQUFDbkIsTUFBTSxDQUFDRyxJQUFSLENBQWIsR0FBNkJILE1BQTdCO0FBQ0QsR0FISDtBQU1BLFNBQU9tQixhQUFQO0FBQ0Q7O0FBRU0sU0FBU0UsaUJBQVQsQ0FBMkJDLEtBQTNCLEVBQXFEQyxPQUFyRCxFQUFzRUwsWUFBdEUsRUFBZ0c7QUFDckcsTUFBTUMsYUFBYSxHQUFHRixnQkFBZ0IsQ0FBQ0MsWUFBRCxDQUF0QztBQUNBLE1BQU1NLE9BQU8sR0FBR0MsSUFBSSxDQUFDQyxLQUFMLENBQVdILE9BQVgsQ0FBaEI7QUFDQUksRUFBQUEsTUFBTSxDQUFDQyxJQUFQLENBQVlKLE9BQVosRUFBcUJKLE9BQXJCLENBQ0UsVUFBQ1MsR0FBRCxFQUFNQyxLQUFOLEVBQWdCO0FBQ2QsUUFBSVgsYUFBYSxDQUFDVSxHQUFELENBQWIsQ0FBbUJFLElBQW5CLEtBQTRCLFNBQWhDLEVBQTJDO0FBQ3pDRCxNQUFBQSxLQUFLLEtBQUssQ0FBVixHQUNFUixLQUFLLENBQUNVLEtBQU4scUJBQ0dILEdBREgsRUFDU0wsT0FBTyxDQUFDSyxHQUFELENBRGhCLEVBREYsR0FJRVAsS0FBSyxDQUFDVyxRQUFOLHFCQUNHSixHQURILEVBQ1NMLE9BQU8sQ0FBQ0ssR0FBRCxDQURoQixFQUpGO0FBT0QsS0FSRCxNQVFPO0FBQ0xDLE1BQUFBLEtBQUssS0FBSyxDQUFWLEdBQ0VSLEtBQUssQ0FBQ1UsS0FBTixDQUFZSCxHQUFaLEVBQWlCLE1BQWpCLEVBQXlCLE1BQU1MLE9BQU8sQ0FBQ0ssR0FBRCxDQUFiLEdBQXFCLEdBQTlDLENBREYsR0FFRVAsS0FBSyxDQUFDVyxRQUFOLENBQWVKLEdBQWYsRUFBb0IsTUFBcEIsRUFBNEIsTUFBTUwsT0FBTyxDQUFDSyxHQUFELENBQWIsR0FBcUIsR0FBakQsQ0FGRjtBQUdEO0FBQ0YsR0FmSDtBQWtCQSxTQUFPUCxLQUFQO0FBQ0QiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBIdHRwRXhjZXB0aW9uLCBJTUNSZXF1ZXN0LCBJTUNSZXNwb25zZSwgSVVzZXIgfSBmcm9tICdAcm9vdC9hcGkvdHlwZXMnXG5pbXBvcnQgY29uZmlnIGZyb20gJ0Byb290L2FwaS91dGlscy9jb25maWdMb2FkZXInXG5pbXBvcnQgeyBIb29rcywgSUNvbHVtbkluZm8sIElUYWJsZUluZm8gfSBmcm9tICdAcm9vdC9jb25maWdHZW5lcmF0b3InXG5pbXBvcnQgeyBFcnJvclJlcXVlc3RIYW5kbGVyLCBOZXh0RnVuY3Rpb24gfSBmcm9tICdleHByZXNzJ1xuaW1wb3J0IEtuZXggZnJvbSAna25leCdcblxuZXhwb3J0IGZ1bmN0aW9uIGNhdGNoTWlkZGxld2FyZShuZXh0OiBOZXh0RnVuY3Rpb24pIHtcbiAgcmV0dXJuIChlcnI6IEh0dHBFeGNlcHRpb24pID0+IHtcbiAgICBpZiAobmV4dCkge1xuICAgICAgbmV4dChlcnIpXG4gICAgfVxuICAgIHJldHVybiBQcm9taXNlLnJlamVjdCh7XG4gICAgICBlcnJvcjogZXJyLFxuICAgIH0pXG4gIH1cbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGJ1aWxkRXJyb3IobWVzc2FnZTogc3RyaW5nLCBzdGF0dXM6IG51bWJlcikge1xuICBjb25zdCBlcnIgPSBuZXcgSHR0cEV4Y2VwdGlvbihzdGF0dXMsIG1lc3NhZ2UpXG4gIHJldHVybiBlcnJcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGFkZFRvUmVzcG9uc2UocmVzOiBJTUNSZXNwb25zZSwgdGFyZ2V0OiBzdHJpbmcpIHtcbiAgcmV0dXJuIGZ1bmN0aW9uKGRhdGE6IGFueSkge1xuICAgIGlmIChyZXMpIHtcbiAgICAgIHJlcy5kYXRhID0ge1xuICAgICAgICAuLi5yZXMuZGF0YSxcbiAgICAgICAgW3RhcmdldF06IGRhdGEsXG4gICAgICB9XG4gICAgICByZXR1cm4gcmVzXG4gICAgfVxuICAgIHRocm93IGJ1aWxkRXJyb3IoJ1Jlc3BvbnNlIG9iamVjdCBub3QgdmFsaWQnLCA1MDApXG4gIH1cbn1cblxuZXhwb3J0IGZ1bmN0aW9uIG5leHRBbmRSZXR1cm4obmV4dDogTmV4dEZ1bmN0aW9uKSB7XG4gIHJldHVybiBmdW5jdGlvbihkYXRhOiBhbnkpIHtcbiAgICBpZiAobmV4dCkge1xuICAgICAgbmV4dCgpXG4gICAgfVxuICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUoZGF0YSlcbiAgfVxufVxuXG4vLyBlcnJvciBoYW5kbGVyXG5leHBvcnQgY29uc3QgZXJyb3JIYW5kbGVyOiBFcnJvclJlcXVlc3RIYW5kbGVyID0gKGVyciwgcmVxLCByZXMpID0+IHtcbiAgcmVzLnN0YXR1cyhlcnIuc3RhdHVzIHx8IDUwMClcbiAgcmVzLmpzb24oe1xuICAgIG1lc3NhZ2U6IGVyci5tZXNzYWdlLFxuICB9KVxufVxuXG5leHBvcnQgZnVuY3Rpb24gaGFzQXV0aG9yaXphdGlvbih0YWJsZVJvbGVzOiBzdHJpbmdbXSwgdXNlcjogSVVzZXIgPSB7cm9sZXM6IFtdfSk6IGJvb2xlYW4ge1xuICBsZXQgaXNBdXRob3JpemVkOiBzdHJpbmcgfCB1bmRlZmluZWQgPSAndHJ1ZSdcblxuICBpZiAodGFibGVSb2xlcyAmJiB0YWJsZVJvbGVzLmxlbmd0aCkge1xuICAgIGlzQXV0aG9yaXplZCA9IHRhYmxlUm9sZXMuZmluZChcbiAgICAgICh0YWJsZVJvbGU6IHN0cmluZykgPT4ge1xuICAgICAgICBpZiAodGFibGVSb2xlID09PSAnYWxsJykge1xuICAgICAgICAgIHJldHVybiB0cnVlXG4gICAgICAgIH1cbiAgICAgICAgY29uc3QgdXNlckhhc0F1dGhvcml6YXRpb24gPSB1c2VyLnJvbGVzLmZpbmQoXG4gICAgICAgICAgKHVzZXJSb2xlOiBzdHJpbmcpID0+IHtcbiAgICAgICAgICAgIHJldHVybiAodXNlclJvbGUgPT09IHRhYmxlUm9sZSk7XG4gICAgICAgICAgfVxuICAgICAgICApXG4gICAgICAgIHJldHVybiB1c2VySGFzQXV0aG9yaXphdGlvbiA/IHRydWUgOiBmYWxzZVxuICAgICAgfVxuICAgIClcbiAgfVxuXG4gIHJldHVybiBpc0F1dGhvcml6ZWQgPyB0cnVlIDogZmFsc2Vcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGZpbHRlclZpc2libGVUYWJsZUNvbHVtbnModGFibGU6IElUYWJsZUluZm8sIHRhcmdldDogJ21haW4nIHwgJ2RldGFpbCcpIHtcbiAgcmV0dXJuIHRhYmxlLmNvbHVtbnMuZmlsdGVyKFxuICAgIChjb2x1bW4pID0+IGNvbHVtbi52aXNpYmxlW3RhcmdldF1cbiAgKS5tYXAoXG4gICAgKGNvbHVtbikgPT4gY29sdW1uLm5hbWVcbiAgKVxufVxuXG5leHBvcnQgZnVuY3Rpb24gcnVuSG9vayhcbiAgVEFCTEU6IElUYWJsZUluZm8sXG4gIGhvb2s6IEhvb2tzLFxuICBpbnN0YW5jZTogJ2FmdGVyJyB8ICdiZWZvcmUnLFxuICByZXE6IElNQ1JlcXVlc3QsXG4gIHJlczogSU1DUmVzcG9uc2UsXG4gIGRhdGFiYXNlOiBLbmV4IHwgbnVsbCxcbiAgcmVzdWx0czogYW55XG4pIHtcbiAgaWYgKFRBQkxFLmhvb2tzICYmIFRBQkxFLmhvb2tzW2hvb2tdKSB7XG4gICAgY29uc3QgSE9PSyA9IFRBQkxFLmhvb2tzW2hvb2tdXG4gICAgaWYgKGRhdGFiYXNlICYmIEhPT0sgJiYgSE9PS1tpbnN0YW5jZV0pIHtcbiAgICAgIGNvbnN0IENBTExFUiAgPSBIT09LW2luc3RhbmNlXVxuICAgICAgcmV0dXJuIENBTExFUiA/XG4gICAgICAgIENBTExFUihyZXEsIHJlcywgZGF0YWJhc2UsIFRBQkxFLm5hbWUsIHJlc3VsdHMpIDpcbiAgICAgICAgUHJvbWlzZS5yZXNvbHZlKGhvb2sgPT09ICdnZXRUYWJsZUNvdW50JyA/IHJlc3VsdHMubGVuZ3RoIDogcmVzdWx0cylcbiAgICB9XG4gIH1cbiAgcmV0dXJuIFByb21pc2UucmVzb2x2ZShob29rID09PSAnZ2V0VGFibGVDb3VudCcgPyByZXN1bHRzLmxlbmd0aCA6IHJlc3VsdHMpXG59XG5cbmV4cG9ydCBmdW5jdGlvbiBnZXRUYWJsZUNvbmZpZyhUQUJMRV9OQU1FOiBzdHJpbmcpIHtcbiAgcmV0dXJuIGNvbmZpZygpLnNldHRpbmdzLmZpbHRlcihcbiAgICAodGFibGVJdGVtKSA9PiB0YWJsZUl0ZW0ubmFtZSA9PT0gVEFCTEVfTkFNRVxuICApWzBdXG59XG5cbmV4cG9ydCBmdW5jdGlvbiBnZXRDb2x1bW5zQnlOYW1lKFRBQkxFX0NPTkZJRzogSVRhYmxlSW5mbykge1xuICBjb25zdCBjb2x1bW5zQnlOYW1lOiB7XG4gICAgW2tleTogc3RyaW5nXTogSUNvbHVtbkluZm9cbiAgfSA9IHt9XG5cbiAgVEFCTEVfQ09ORklHLmNvbHVtbnMuZm9yRWFjaChcbiAgICAoY29sdW1uKSA9PiB7XG4gICAgICBjb2x1bW5zQnlOYW1lW2NvbHVtbi5uYW1lXSA9IGNvbHVtblxuICAgIH1cbiAgKVxuXG4gIHJldHVybiBjb2x1bW5zQnlOYW1lXG59XG5cbmV4cG9ydCBmdW5jdGlvbiBhcHBseVF1ZXJ5RmlsdGVycyhRVUVSWTogS25leC5RdWVyeUJ1aWxkZXIsIGZpbHRlcnM6IHN0cmluZywgVEFCTEVfQ09ORklHOiBJVGFibGVJbmZvKSB7XG4gIGNvbnN0IGNvbHVtbnNCeU5hbWUgPSBnZXRDb2x1bW5zQnlOYW1lKFRBQkxFX0NPTkZJRylcbiAgY29uc3QgRklMVEVSUyA9IEpTT04ucGFyc2UoZmlsdGVycylcbiAgT2JqZWN0LmtleXMoRklMVEVSUykuZm9yRWFjaChcbiAgICAoa2V5LCBpbmRleCkgPT4ge1xuICAgICAgaWYgKGNvbHVtbnNCeU5hbWVba2V5XS50eXBlID09PSAnaW50KDExKScpIHtcbiAgICAgICAgaW5kZXggPT09IDAgP1xuICAgICAgICAgIFFVRVJZLndoZXJlKHtcbiAgICAgICAgICAgIFtrZXldOiBGSUxURVJTW2tleV0sXG4gICAgICAgICAgfSkgOlxuICAgICAgICAgIFFVRVJZLmFuZFdoZXJlKHtcbiAgICAgICAgICAgIFtrZXldOiBGSUxURVJTW2tleV0sXG4gICAgICAgICAgfSlcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGluZGV4ID09PSAwID9cbiAgICAgICAgICBRVUVSWS53aGVyZShrZXksICdsaWtlJywgJyUnICsgRklMVEVSU1trZXldICsgJyUnKSA6XG4gICAgICAgICAgUVVFUlkuYW5kV2hlcmUoa2V5LCAnbGlrZScsICclJyArIEZJTFRFUlNba2V5XSArICclJylcbiAgICAgIH1cbiAgICB9XG4gIClcblxuICByZXR1cm4gUVVFUllcbn1cbiJdfQ==